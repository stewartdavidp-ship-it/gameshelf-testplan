<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Shelf Test Plan v3</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß™</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-500: #6b7280; --gray-700: #374151; --gray-900: #111827;
            --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --bg-tertiary: #f9fafb;
            --text-primary: #111827; --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }
        
        [data-theme="dark"] {
            --gray-50: #1f2937; --gray-100: #111827; --gray-200: #374151;
            --gray-300: #4b5563; --gray-500: #9ca3af; --gray-700: #d1d5db; --gray-900: #f9fafb;
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af;
            --border-color: #374151;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-100); color: var(--gray-900); line-height: 1.5; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 20px; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .header-tabs { display: flex; gap: 4px; }
        .header-tab { background: rgba(255,255,255,0.15); border: none; color: white; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .header-tab.active { background: rgba(255,255,255,0.3); }
        .user-info { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; }
        .admin-badge { background: var(--warning); color: #000; padding: 2px 6px; border-radius: 8px; font-size: 0.65rem; font-weight: 600; }
        .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.7rem; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
        
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center; }
        .login-screen h2 { font-size: 1.4rem; margin-bottom: 8px; }
        .login-screen p { color: var(--gray-500); margin-bottom: 20px; }
        .google-btn { display: flex; align-items: center; gap: 10px; background: white; border: 1px solid var(--gray-300); padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .google-btn img { width: 18px; }
        
        .panel { background: white; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .panel h3 { font-size: 0.95rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .panel.admin { border: 2px solid var(--warning); }
        .panel.debug { border: 2px solid var(--primary); }
        
        .tabs { display: flex; gap: 6px; margin-bottom: 14px; border-bottom: 1px solid var(--gray-200); padding-bottom: 8px; flex-wrap: wrap; }
        .tab { padding: 6px 14px; background: none; border: none; font-size: 0.8rem; cursor: pointer; border-radius: 5px; color: var(--gray-500); }
        .tab.active { background: var(--gray-100); color: var(--gray-900); font-weight: 500; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.85rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        
        .test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 6px; max-height: 250px; overflow-y: auto; padding: 10px; background: var(--gray-50); border-radius: 6px; }
        .test-grid .section-header { grid-column: 1 / -1; font-weight: 600; font-size: 0.8rem; color: var(--gray-700); padding: 6px 0 2px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .test-checkbox { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; cursor: pointer; }
        .test-checkbox input { width: 14px; height: 14px; }
        .select-all-btn { font-size: 0.65rem; padding: 2px 6px; background: var(--gray-200); border: none; border-radius: 4px; cursor: pointer; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }
        
        .assignment-list { display: flex; flex-direction: column; gap: 8px; }
        .assignment-card { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--gray-50); border-radius: 6px; }
        .assignment-card h4 { font-size: 0.85rem; }
        .assignment-card p { font-size: 0.7rem; color: var(--gray-500); }
        .badge { background: var(--primary); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; }
        
        .progress-bar { height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .progress-legend { display: flex; gap: 12px; font-size: 0.7rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.pass { background: var(--success); }
        .legend-dot.fail { background: var(--danger); }
        .legend-dot.skip { background: var(--gray-300); }
        .legend-dot.pending { background: var(--gray-200); border: 1px solid var(--gray-300); }
        
        .section-tabs { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 6px; margin-bottom: 12px; }
        .section-tab { flex-shrink: 0; padding: 6px 12px; background: white; border: 1px solid var(--gray-200); border-radius: 16px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; }
        .section-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .section-tab .count { background: rgba(0,0,0,0.1); padding: 1px 5px; border-radius: 8px; font-size: 0.65rem; margin-left: 4px; }
        .section-tab.active .count { background: rgba(255,255,255,0.2); }
        
        .test-card { background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
        .test-card.status-pass { border-left: 3px solid var(--success); }
        .test-card.status-fail { border-left: 3px solid var(--danger); }
        .test-card.status-skip { border-left: 3px solid var(--gray-300); }
        .test-header { display: flex; align-items: center; padding: 12px; cursor: pointer; gap: 10px; }
        .test-id { background: var(--gray-100); color: var(--gray-500); font-size: 0.7rem; font-weight: 600; padding: 3px 6px; border-radius: 4px; }
        .test-title { flex: 1; font-size: 0.85rem; font-weight: 500; }
        .test-status { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .test-status.pending { background: var(--gray-200); }
        .test-status.pass { background: var(--success); color: white; }
        .test-status.fail { background: var(--danger); color: white; }
        .test-status.skip { background: var(--gray-300); color: white; }
        .test-chevron { color: var(--gray-400); transition: transform 0.2s; }
        .test-card.expanded .test-chevron { transform: rotate(180deg); }
        .test-body { display: none; padding: 0 12px 12px; border-top: 1px solid var(--gray-100); }
        .test-card.expanded .test-body { display: block; }
        
        .launch-row { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .launch-btn { flex: 1; min-width: 140px; padding: 10px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .launch-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(59,130,246,0.3); }
        .launch-btn.debug { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .launch-note { font-size: 0.7rem; color: var(--gray-500); text-align: center; margin-top: -4px; }
        
        .test-data { background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.7rem; white-space: pre-wrap; margin: 8px 0; cursor: pointer; }
        .test-data:hover { background: #2d2d2d; }
        
        .info-box { background: var(--gray-50); padding: 10px; border-radius: 6px; margin: 8px 0; font-size: 0.8rem; }
        .info-box h4 { font-size: 0.7rem; text-transform: uppercase; color: var(--gray-500); margin-bottom: 4px; }
        
        .action-buttons { display: flex; gap: 6px; margin: 12px 0; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .action-btn.pass { background: #dcfce7; color: #166534; }
        .action-btn.pass.selected { background: var(--success); color: white; }
        .action-btn.fail { background: #fee2e2; color: #991b1b; }
        .action-btn.fail.selected { background: var(--danger); color: white; }
        .action-btn.skip { background: var(--gray-100); color: var(--gray-600); }
        .action-btn.skip.selected { background: var(--gray-400); color: white; }
        
        .platform-section { margin: 12px 0; padding-top: 12px; border-top: 1px solid var(--gray-100); }
        .platform-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .platform-btn { padding: 6px 10px; background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
        .platform-btn:hover { background: var(--gray-200); }
        .platform-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .platform-badge { background: var(--gray-100); color: var(--gray-600); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; }
        
        /* Report styles */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .summary-card { padding: 16px; border-radius: 10px; text-align: center; }
        .summary-card.total { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); }
        .summary-card.pass { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }
        .summary-card.fail { background: linear-gradient(135deg, #fee2e2, #fecaca); }
        .summary-card.skip { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); }
        .summary-card.pending { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .summary-value { font-size: 2rem; font-weight: 700; }
        .summary-card.total .summary-value { color: var(--primary-dark); }
        .summary-card.pass .summary-value { color: #166534; }
        .summary-card.fail .summary-value { color: #991b1b; }
        .summary-card.skip .summary-value { color: #374151; }
        .summary-card.pending .summary-value { color: #92400e; }
        .summary-label { font-size: 0.75rem; text-transform: uppercase; color: var(--gray-600); margin-top: 4px; }
        
        .platform-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px; }
        .platform-row .platform-icon { font-size: 1.2rem; width: 40px; text-align: center; }
        .platform-row .platform-name { flex: 0 0 120px; font-weight: 500; font-size: 0.85rem; }
        .platform-row .platform-bar { flex: 1; height: 24px; background: var(--gray-200); border-radius: 12px; overflow: hidden; position: relative; }
        .platform-row .platform-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.7rem; font-weight: 600; color: white; min-width: fit-content; }
        .platform-row .platform-fill.pass { background: var(--success); }
        .platform-row .platform-fill.fail { background: var(--danger); }
        .platform-row .platform-fill.mixed { background: linear-gradient(90deg, var(--success) var(--pass-pct), var(--danger) var(--pass-pct)); }
        .platform-row .platform-stats { flex: 0 0 100px; text-align: right; font-size: 0.8rem; color: var(--gray-600); }
        
        .section-row { display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--gray-100); }
        .section-row:last-child { border-bottom: none; }
        .section-row .section-icon { font-size: 1.1rem; }
        .section-row .section-name { flex: 0 0 100px; font-weight: 500; font-size: 0.85rem; }
        .section-row .section-bar { flex: 1; height: 20px; background: var(--gray-100); border-radius: 10px; overflow: hidden; display: flex; }
        .section-row .bar-segment { height: 100%; }
        .section-row .bar-segment.pass { background: var(--success); }
        .section-row .bar-segment.fail { background: var(--danger); }
        .section-row .bar-segment.skip { background: var(--gray-400); }
        .section-row .section-stats { flex: 0 0 80px; text-align: right; font-size: 0.75rem; color: var(--gray-500); }
        
        .attention-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; margin-bottom: 6px; border-left: 3px solid var(--danger); }
        .attention-item.warning { border-left-color: var(--warning); }
        .attention-item .attention-id { font-weight: 600; font-size: 0.8rem; color: var(--gray-500); }
        .attention-item .attention-title { flex: 1; font-size: 0.85rem; }
        .attention-item .attention-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; }
        .attention-item .attention-badge.fail { background: #fee2e2; color: #991b1b; }
        .attention-item .attention-badge.no-platform { background: #fef3c7; color: #92400e; }
        
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .matrix-table th, .matrix-table td { padding: 8px; text-align: center; border: 1px solid var(--gray-200); }
        .matrix-table th { background: var(--gray-100); font-weight: 600; }
        .matrix-table .section-header-cell { text-align: left; font-weight: 500; }
        .matrix-cell { width: 40px; height: 40px; }
        .matrix-cell.full { background: var(--success); color: white; }
        .matrix-cell.partial { background: #fef3c7; color: #92400e; }
        .matrix-cell.none { background: var(--gray-50); color: var(--gray-400); }
        .matrix-cell.has-fail { background: #fee2e2; color: #991b1b; }
        
        .notes-input { width: 100%; padding: 8px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem; min-height: 60px; resize: vertical; font-family: inherit; margin-top: 8px; }
        
        .screenshot-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .upload-btn { display: flex; align-items: center; gap: 4px; padding: 8px 12px; background: var(--gray-100); border: 1px dashed var(--gray-300); border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
        .upload-btn input { display: none; }
        .screenshot-thumb { width: 60px; height: 60px; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--gray-200); }
        .screenshot-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .screenshot-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 10px; }
        
        .console-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-100); }
        .console-toggle { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; cursor: pointer; }
        .console-toggle input { width: 16px; height: 16px; }
        .console-output { background: #1e1e1e; color: #d4d4d4; padding: 8px; border-radius: 6px; font-family: monospace; font-size: 0.65rem; max-height: 120px; overflow-y: auto; margin-top: 6px; }
        .console-output .error { color: #f87171; }
        .console-output .warn { color: #fbbf24; }
        
        /* Debug Config Panel */
        .debug-config { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .debug-option { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer; }
        .debug-option input { width: 18px; height: 18px; }
        .debug-option-info { flex: 1; }
        .debug-option-info strong { font-size: 0.8rem; display: block; }
        .debug-option-info span { font-size: 0.7rem; color: var(--gray-500); }
        
        /* Automation Panel */
        .automation-controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .automation-status { padding: 12px; background: var(--gray-50); border-radius: 6px; margin-bottom: 12px; }
        .automation-status .status-text { font-size: 0.85rem; font-weight: 500; }
        .automation-status .status-detail { font-size: 0.75rem; color: var(--gray-500); }
        .automation-log { background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.7rem; max-height: 200px; overflow-y: auto; }
        .automation-log .success { color: #4ade80; }
        .automation-log .error { color: #f87171; }
        .automation-log .warn { color: #fbbf24; }
        .automation-log .info { color: #60a5fa; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .metric-card { background: var(--gray-50); padding: 12px; border-radius: 6px; text-align: center; }
        .metric-card .value { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
        .metric-card .label { font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; }
        
        .export-section { margin-top: 16px; }
        .export-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .debug-fab { position: fixed; bottom: 16px; right: 16px; width: 48px; height: 48px; background: var(--gray-700); color: white; border: none; border-radius: 50%; font-size: 1.2rem; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3); z-index: 999; display: none; }
        .debug-fab.visible { display: flex; align-items: center; justify-content: center; }
        
        .debug-panel { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; color: #d4d4d4; max-height: 35vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s; z-index: 1000; }
        .debug-panel.visible { transform: translateY(0); }
        .debug-panel-header { display: flex; justify-content: space-between; padding: 8px 12px; background: #2d2d2d; position: sticky; top: 0; }
        .debug-panel-header h4 { font-size: 0.75rem; color: #9ca3af; }
        .debug-panel-content { padding: 10px; font-family: monospace; font-size: 0.65rem; }
        .debug-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        
        .toast { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--gray-900); color: white; padding: 10px 20px; border-radius: 6px; font-size: 0.8rem; opacity: 0; transition: all 0.3s; z-index: 1001; }
        .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .hidden { display: none !important; }
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .header-tabs { display: none; }
        }
        
        /* Dark Mode Toggle */
        .theme-toggle { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 4px; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); }
        
        /* Variant Testing Styles */
        .variant-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; margin-left: 8px; }
        .variants-section { margin-top: 16px; border: 1px solid var(--gray-200); border-radius: 8px; overflow: hidden; }
        .variants-header { background: var(--gray-50); padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 0.85rem; }
        .variants-header:hover { background: var(--gray-100); }
        .variants-chevron { transition: transform 0.2s; }
        .variants-body { display: none; padding: 10px; }
        .variants-body.expanded { display: block; }
        .variant-row { display: grid; grid-template-columns: auto 1fr auto auto; gap: 8px; align-items: center; padding: 8px 10px; border-radius: 6px; margin-bottom: 6px; background: var(--gray-50); }
        .variant-row.status-pass { background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--success); }
        .variant-row.status-fail { background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); }
        .variant-row.status-skip { background: rgba(156, 163, 175, 0.1); border-left: 3px solid var(--gray-300); }
        .variant-info { display: flex; align-items: center; gap: 6px; min-width: 200px; }
        .variant-type { font-size: 0.9rem; }
        .variant-name { font-size: 0.8rem; font-weight: 500; }
        .variant-expected { font-size: 0.75rem; color: var(--gray-500); }
        .variant-data { font-family: monospace; font-size: 0.7rem; background: var(--gray-100); padding: 4px 8px; border-radius: 4px; cursor: pointer; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .variant-actions { display: flex; gap: 4px; }
        .variant-btn { width: 28px; height: 28px; border: 1px solid var(--gray-200); border-radius: 4px; cursor: pointer; font-size: 0.75rem; background: white; }
        .variant-btn:hover { background: var(--gray-100); }
        .variant-btn.pass.selected { background: var(--success); color: white; border-color: var(--success); }
        .variant-btn.fail.selected { background: var(--danger); color: white; border-color: var(--danger); }
        .variant-btn.skip.selected { background: var(--gray-400); color: white; border-color: var(--gray-400); }
        .variant-actions-row { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-200); }
        
        /* Dark Mode Variant Overrides */
        [data-theme="dark"] .variants-section { border-color: var(--border-color); }
        [data-theme="dark"] .variants-header { background: var(--bg-tertiary); }
        [data-theme="dark"] .variants-header:hover { background: var(--bg-secondary); }
        [data-theme="dark"] .variant-row { background: var(--bg-tertiary); }
        [data-theme="dark"] .variant-row.status-pass { background: rgba(34, 197, 94, 0.15); }
        [data-theme="dark"] .variant-row.status-fail { background: rgba(239, 68, 68, 0.15); }
        [data-theme="dark"] .variant-expected { color: var(--text-secondary); }
        [data-theme="dark"] .variant-data { background: var(--bg-secondary); color: var(--text-primary); }
        [data-theme="dark"] .variant-btn { background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .variant-btn:hover { background: var(--bg-tertiary); }
        [data-theme="dark"] .variant-actions-row { border-color: var(--border-color); }
        
        /* Dark Mode Overrides */
        [data-theme="dark"] body { background: var(--bg-primary); color: var(--text-primary); }
        [data-theme="dark"] .panel { background: var(--bg-secondary); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        [data-theme="dark"] .login-screen p { color: var(--text-secondary); }
        [data-theme="dark"] .google-btn { background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group select,
        [data-theme="dark"] .form-group textarea,
        [data-theme="dark"] .notes-input { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .tab { color: var(--text-secondary); }
        [data-theme="dark"] .tab.active { background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] .tabs { border-color: var(--border-color); }
        [data-theme="dark"] .test-grid { background: var(--bg-tertiary); }
        [data-theme="dark"] .test-grid .section-header { color: var(--text-primary); border-color: var(--border-color); }
        [data-theme="dark"] .select-all-btn { background: var(--bg-secondary); color: var(--text-primary); }
        [data-theme="dark"] .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] .assignment-card { background: var(--bg-tertiary); }
        [data-theme="dark"] .assignment-card p { color: var(--text-secondary); }
        [data-theme="dark"] .progress-bar { background: var(--bg-tertiary); }
        [data-theme="dark"] .test-card { background: var(--bg-secondary); }
        [data-theme="dark"] .test-card-header { background: var(--bg-tertiary); }
        [data-theme="dark"] .test-meta span { color: var(--text-secondary); }
        [data-theme="dark"] .test-detail p { color: var(--text-secondary); }
        [data-theme="dark"] .test-detail pre { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .status-btn { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        [data-theme="dark"] .debug-option { background: var(--bg-tertiary); }
        [data-theme="dark"] .debug-option-info span { color: var(--text-secondary); }
        [data-theme="dark"] .automation-status { background: var(--bg-tertiary); }
        [data-theme="dark"] .automation-status .status-detail { color: var(--text-secondary); }
        [data-theme="dark"] .metric-card { background: var(--bg-tertiary); }
        [data-theme="dark"] .metric-card .label { color: var(--text-secondary); }
        [data-theme="dark"] .upload-btn { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .screenshot-thumb { border-color: var(--border-color); }
        [data-theme="dark"] .console-section { border-color: var(--border-color); }
        [data-theme="dark"] .matrix-cell.none { background: var(--bg-tertiary); }
        [data-theme="dark"] .toast { background: var(--bg-secondary); }
        [data-theme="dark"] .search-input { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .filter-btn { background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] .filter-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üß™ Game Shelf Test Plan</h1>
            <div class="header-tabs" id="header-tabs"></div>
            <div class="user-info" id="user-info"></div>
        </div>
    </header>
    
    <div id="login-screen" class="login-screen">
        <h2>üéÆ Game Shelf Tester Portal</h2>
        <p>Sign in to access your assigned tests</p>
        <button class="google-btn" onclick="signIn()">
            <img src="https://www.google.com/favicon.ico" alt="">Sign in with Google
        </button>
        <button class="theme-toggle" onclick="toggleDarkMode()" style="margin-top: 20px; background: var(--gray-200); color: var(--gray-700);">
            <span id="login-theme-icon">üåô</span> Toggle Dark Mode
        </button>
        <script>
            // Update login screen theme icon (dark mode is default)
            document.getElementById('login-theme-icon').textContent = 
                document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        </script>
    </div>
    
    <main id="main-content" class="container hidden">
        <!-- TESTING TAB -->
        <div id="tab-testing">
            <div id="assignment-banner" class="panel hidden" style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); border: 1px solid #93c5fd;">
                <h3 style="color: var(--primary-dark);">üìã Your Assignment</h3>
                <p id="assignment-desc" style="font-size: 0.85rem;"></p>
            </div>
            
            <div class="panel" id="progress-panel">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Progress</h3>
                    <span id="progress-text" style="font-size: 0.8rem; color: var(--gray-500);">0/0</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <div class="progress-legend">
                    <span class="legend-item"><span class="legend-dot pass"></span> Pass <span id="cnt-pass">0</span></span>
                    <span class="legend-item"><span class="legend-dot fail"></span> Fail <span id="cnt-fail">0</span></span>
                    <span class="legend-item"><span class="legend-dot skip"></span> Skip <span id="cnt-skip">0</span></span>
                    <span class="legend-item"><span class="legend-dot pending"></span> Pending <span id="cnt-pending">0</span></span>
                </div>
            </div>
            
            <div class="panel" id="platform-panel" style="padding: 12px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase;">Testing on:</span>
                    <span id="current-platform" style="font-size: 0.85rem; font-weight: 500;"></span>
                </div>
                <select id="platform-select" onchange="changeGlobalPlatform(this.value)" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                    <option value="desktop-chrome">üñ•Ô∏è Chrome</option>
                    <option value="desktop-safari">üñ•Ô∏è Safari</option>
                    <option value="desktop-firefox">üñ•Ô∏è Firefox</option>
                    <option value="iphone-safari">üì± iPhone Safari</option>
                    <option value="iphone-pwa">üì± iPhone PWA</option>
                    <option value="android-chrome">ü§ñ Android Chrome</option>
                    <option value="android-pwa">ü§ñ Android PWA</option>
                    <option value="ipad">üì≤ iPad</option>
                </select>
            </div>
            
            <div class="section-tabs" id="section-tabs"></div>
            <div id="test-cards"></div>
            
            <div id="no-tests" class="panel hidden" style="text-align: center; padding: 40px;">
                <h3>üéØ No Tests Assigned</h3>
                <p style="color: var(--gray-500);">An admin will assign tests to you.</p>
            </div>
            
            <div class="export-section">
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportJSON()">üìã Copy JSON for Claude</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">üìä Download CSV</button>
                    <button class="btn btn-secondary" onclick="exportMarkdown()">üìù Markdown Report</button>
                </div>
            </div>
        </div>
        
        <!-- ADMIN TAB -->
        <div id="tab-admin" class="hidden">
            <div class="panel admin">
                <h3>üëë Admin Panel</h3>
                <div class="tabs">
                    <button class="tab active" onclick="switchAdminTab('assign')">Assign Tests</button>
                    <button class="tab" onclick="switchAdminTab('view')">Assignments</button>
                    <button class="tab" onclick="switchAdminTab('results')">All Results</button>
                </div>
                
                <div id="admin-assign">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tester Email</label>
                            <input type="email" id="assign-email" placeholder="tester@example.com">
                        </div>
                        <div class="form-group">
                            <label>Focus Area</label>
                            <input type="text" id="assign-focus" placeholder="e.g., Onboarding Expert">
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Select Tests</label>
                        <div class="test-grid" id="test-grid"></div>
                    </div>
                    <button class="btn btn-primary" onclick="createAssignment()">‚úÖ Create Assignment</button>
                </div>
                
                <div id="admin-view" class="assignment-list hidden"></div>
                <div id="admin-results" class="hidden"></div>
            </div>
        </div>
        
        <!-- DEBUG TAB -->
        <div id="tab-debug" class="hidden">
            <div class="panel debug">
                <h3>üîß Debug Configuration</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Configure debug options before launching Game Shelf. These settings enable additional logging and metrics collection.</p>
                
                <div class="debug-config">
                    <label class="debug-option">
                        <input type="checkbox" id="debug-console" checked>
                        <div class="debug-option-info">
                            <strong>Console Capture</strong>
                            <span>Log all console output</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-network">
                        <div class="debug-option-info">
                            <strong>Network Logging</strong>
                            <span>Track API requests</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-performance">
                        <div class="debug-option-info">
                            <strong>Performance Metrics</strong>
                            <span>FPS, load times, memory</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-storage">
                        <div class="debug-option-info">
                            <strong>Storage Monitor</strong>
                            <span>Track localStorage changes</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-events">
                        <div class="debug-option-info">
                            <strong>Event Tracking</strong>
                            <span>User interactions</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-errors" checked>
                        <div class="debug-option-info">
                            <strong>Error Capture</strong>
                            <span>Unhandled exceptions</span>
                        </div>
                    </label>
                </div>
                
                <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="launchWithDebug()">üöÄ Launch Game Shelf with Debug</button>
                    <button class="btn btn-secondary" onclick="copyDebugBookmarklet()">üìé Copy Debug Bookmarklet</button>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìä Collected Metrics</h3>
                <div class="metrics-grid" id="metrics-grid">
                    <div class="metric-card"><div class="value" id="metric-errors">0</div><div class="label">Errors</div></div>
                    <div class="metric-card"><div class="value" id="metric-warnings">0</div><div class="label">Warnings</div></div>
                    <div class="metric-card"><div class="value" id="metric-logs">0</div><div class="label">Log Entries</div></div>
                    <div class="metric-card"><div class="value" id="metric-duration">0s</div><div class="label">Session</div></div>
                </div>
                <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="clearMetrics()">Clear Metrics</button>
            </div>
        </div>
        
        <!-- AUTOMATION TAB -->
        <div id="tab-automation" class="hidden">
            <div class="panel">
                <h3>ü§ñ Automation Runner</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Run through tests automatically or step through manually.</p>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="auto-advance" checked style="width: 18px; height: 18px;">
                        <span style="font-size: 0.85rem; font-weight: 500;">Auto-advance</span>
                    </label>
                    <select id="auto-delay" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                        <option value="3">3 seconds</option>
                        <option value="5" selected>5 seconds</option>
                        <option value="10">10 seconds</option>
                        <option value="15">15 seconds</option>
                        <option value="30">30 seconds</option>
                    </select>
                    <span style="font-size: 0.75rem; color: var(--gray-500);">Time per test</span>
                </div>
                
                <div class="automation-controls">
                    <button class="btn btn-success" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
                    <button class="btn btn-primary" onclick="runSelectedTests()">‚ñ∂Ô∏è Run Selected</button>
                    <button class="btn btn-success" onclick="nextTest()">‚è≠Ô∏è Next Test</button>
                    <button class="btn btn-secondary" onclick="skipTest()">‚è© Skip</button>
                    <button class="btn btn-danger" onclick="stopTests()">‚èπÔ∏è Stop</button>
                    <button class="btn btn-secondary" onclick="resetAutomation()">üîÑ Reset</button>
                </div>
                
                <div class="automation-status" id="automation-status">
                    <div class="status-text">‚è∏Ô∏è Ready to run</div>
                    <div class="status-detail">Select tests and click Run</div>
                </div>
                
                <div class="form-group">
                    <label>Test Sequence</label>
                    <div class="test-grid" id="automation-tests"></div>
                </div>
                
                <div style="margin-top: 12px;">
                    <label style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500);">EXECUTION LOG</label>
                    <div class="automation-log" id="automation-log">
                        <div class="info">[Ready] Automation runner initialized</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìã Test Scripts</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Generate test scripts for external automation tools.</p>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="generatePlaywright()">üé≠ Playwright Script</button>
                    <button class="btn btn-secondary" onclick="generateCypress()">üå≤ Cypress Script</button>
                    <button class="btn btn-secondary" onclick="generatePuppeteer()">üé™ Puppeteer Script</button>
                </div>
            </div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="tab-reports" class="hidden">
            <div class="panel">
                <h3>üìä Test Coverage Dashboard</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 16px;">Visual overview of testing progress across platforms.</p>
                
                <div class="report-summary" id="report-summary">
                    <div class="summary-cards">
                        <div class="summary-card total"><div class="summary-value" id="rpt-total">0</div><div class="summary-label">Total Tests</div></div>
                        <div class="summary-card pass"><div class="summary-value" id="rpt-pass">0</div><div class="summary-label">Passed</div></div>
                        <div class="summary-card fail"><div class="summary-value" id="rpt-fail">0</div><div class="summary-label">Failed</div></div>
                        <div class="summary-card skip"><div class="summary-value" id="rpt-skip">0</div><div class="summary-label">Skipped</div></div>
                        <div class="summary-card pending"><div class="summary-value" id="rpt-pending">0</div><div class="summary-label">Remaining</div></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üì± Platform Coverage</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Tests completed on each platform.</p>
                <div id="platform-coverage"></div>
            </div>
            
            <div class="panel">
                <h3>üìã Section Progress</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Completion status by test section.</p>
                <div id="section-progress"></div>
            </div>
            
            <div class="panel">
                <h3>üî¥ Tests Needing Attention</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Failed tests and tests without platform assignment.</p>
                <div id="attention-list"></div>
            </div>
            
            <div class="panel">
                <h3>üìà Platform √ó Section Matrix</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Coverage heatmap showing which sections have been tested on which platforms.</p>
                <div id="coverage-matrix" style="overflow-x: auto;"></div>
            </div>
        </div>
    </main>
    
    <button class="debug-fab" id="debug-fab" onclick="toggleDebugPanel()">üêõ</button>
    
    <div class="debug-panel" id="debug-panel">
        <div class="debug-panel-header">
            <h4>Console Output (<span id="log-count">0</span>)</h4>
            <div>
                <button onclick="clearLogs()" style="background:none;border:none;color:#9ca3af;cursor:pointer;margin-right:8px;">Clear</button>
                <button onclick="toggleDebugPanel()" style="background:none;border:none;color:#9ca3af;cursor:pointer;">Close</button>
            </div>
        </div>
        <div class="debug-panel-content" id="debug-content"></div>
    </div>
    
    <div class="toast" id="toast"></div>

<script>
// ========== CONFIG ==========
const firebaseConfig = {
    apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
    authDomain: "word-boxing.firebaseapp.com",
    databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
    projectId: "word-boxing"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const GAMESHELF_URL = 'https://stewartdavidp-ship-it.github.io/gameshelftest/';
const ADMIN_EMAILS = ['stewartdavidp@gmail.com'];

// ========== TEST DATA ==========
const TEST_SECTIONS = [
    { id: 'onboarding', name: 'Onboarding', icon: 'üëã', tests: [
        { id: 'A1', title: 'Welcome modal appears', expected: 'Modal with Get Started visible', steps: '1. Open incognito\n2. Verify modal', launch: '?fresh=1', note: 'Clears data first' },
        { id: 'A2', title: 'Game selection', expected: 'Games highlight on select', steps: '1. Click Get Started\n2. Select 3+ games', launch: '', note: 'Continue from A1',
          variants: [
            { name: 'Select 1 game (minimum)', type: 'edge', expected: 'Allowed or error shown' },
            { name: 'Select all games', type: 'edge', expected: 'All selected, can proceed' },
            { name: 'Select none', type: 'error', expected: 'Cannot proceed, error message' },
            { name: 'Deselect after select', type: 'happy', expected: 'Toggle works both ways' },
            { name: 'Select only NYT games', type: 'happy', expected: 'Can proceed' },
            { name: 'Select only LinkedIn games', type: 'happy', expected: 'Can proceed' }
          ]
        },
        { id: 'A3', title: 'Platform selection', expected: 'Can select or skip', steps: '1. Continue\n2. Select platforms', launch: '', note: 'Continue from A2',
          variants: [
            { name: 'Select Browser', type: 'happy', expected: 'Browser option saved' },
            { name: 'Select App', type: 'happy', expected: 'App option saved' },
            { name: 'Select Subscriber', type: 'happy', expected: 'Sub status saved' },
            { name: 'Skip all', type: 'edge', expected: 'Can proceed with defaults' },
            { name: 'Mixed selections', type: 'happy', expected: 'Different per publisher' }
          ]
        },
        { id: 'A4', title: 'Daily goal setting', expected: 'Can select 3/5/7', steps: '1. Continue\n2. Select goal', launch: '', note: 'Continue from A3',
          variants: [
            { name: 'Select 3 games/day', type: 'happy', expected: 'Goal set to 3' },
            { name: 'Select 5 games/day', type: 'happy', expected: 'Goal set to 5' },
            { name: 'Select 7 games/day', type: 'happy', expected: 'Goal set to 7' },
            { name: 'Skip (use default)', type: 'edge', expected: 'Default goal applied' }
          ]
        },
        { id: 'A5', title: 'Onboarding complete', expected: 'Celebration, then home', steps: '1. Complete setup\n2. Verify home', launch: '', note: 'Continue from A4' },
        { id: 'A6', title: 'Tutorial prompt', expected: 'Take a tour? shown', steps: '1. Complete setup\n2. Look for prompt', launch: '', note: 'After onboarding' },
        { id: 'A7', title: 'Tutorial walkthrough', expected: 'All 10 steps work', steps: '1. Start tour\n2. Complete all', launch: '#tutorial', note: 'Direct to tutorial',
          variants: [
            { name: 'Complete all steps', type: 'happy', expected: 'Tutorial completes' },
            { name: 'Skip mid-tutorial', type: 'edge', expected: 'Can exit early' },
            { name: 'Click outside spotlight', type: 'edge', expected: 'Stays on current step' }
          ]
        },
        { id: 'A8', title: 'Skip onboarding', expected: 'Goes to home', steps: '1. Fresh start\n2. Click Skip', launch: '?fresh=1', note: 'Try skip' }
    ]},
    { id: 'tracking', name: 'Tracking', icon: 'üìã', tests: [
        { id: 'B1', title: 'Log button opens sheet', expected: 'Sheet slides up', steps: '1. Tap Log\n2. Verify sheet', launch: '#log', note: '‚ö° Proposed: #log' },
        { id: 'B2', title: 'Wordle paste', expected: 'Detected & parsed', steps: '1. Copy Wordle\n2. Open log', launch: '#log', note: '‚ö° Proposed: #log', 
          data: 'Wordle 1,234 4/6\n\n‚¨õ‚¨õüü®‚¨õ‚¨õ\nüü©üü©üü©üü©üü©',
          variants: [
            { name: 'Win in 1 (lucky)', type: 'edge', data: 'Wordle 1,234 1/6\n\nüü©üü©üü©üü©üü©', expected: 'Score: 1/6' },
            { name: 'Win in 6 (close)', type: 'happy', data: 'Wordle 1,234 6/6\n\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ\n‚¨õüü®‚¨õ‚¨õ‚¨õ\n‚¨õüü®üü®‚¨õ‚¨õ\nüü®üü®üü®‚¨õ‚¨õ\nüü©üü©üü©üü®‚¨õ\nüü©üü©üü©üü©üü©', expected: 'Score: 6/6' },
            { name: 'Loss (X/6)', type: 'edge', data: 'Wordle 1,234 X/6\n\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ\n‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ', expected: 'Score: X/6 (loss)' },
            { name: 'Hard mode', type: 'happy', data: 'Wordle 1,234 3/6*\n\n‚¨õüü®‚¨õ‚¨õ‚¨õ\nüü©üü©‚¨õ‚¨õ‚¨õ\nüü©üü©üü©üü©üü©', expected: 'Score: 3/6, Hard mode detected' },
            { name: 'Invalid - random text', type: 'error', data: 'Hello this is not a wordle result', expected: 'Not detected as Wordle' },
            { name: 'Invalid - partial result', type: 'error', data: 'Wordle 1,234 4/6', expected: 'Error or incomplete' },
            { name: 'Invalid - wrong emoji count', type: 'error', data: 'Wordle 1,234 4/6\n\nüü©üü©üü©', expected: 'Error or rejected' }
          ]
        },
        { id: 'B3', title: 'Connections paste', expected: 'Parsed correctly', steps: '1. Copy result\n2. Open log', launch: '#log', note: '‚ö° Proposed: #log', 
          data: 'Connections\nPuzzle #567\nüü®üü®üü®üü®\nüü©üü©üü©üü©\nüü¶üü¶üü¶üü¶\nüü™üü™üü™üü™',
          variants: [
            { name: 'Perfect (4 guesses)', type: 'happy', data: 'Connections\nPuzzle #567\nüü®üü®üü®üü®\nüü©üü©üü©üü©\nüü¶üü¶üü¶üü¶\nüü™üü™üü™üü™', expected: '4 guesses, perfect' },
            { name: 'With mistakes', type: 'happy', data: 'Connections\nPuzzle #567\nüü®üü®üü®üü©\nüü®üü®üü®üü®\nüü©üü©üü©üü©\nüü¶üü¶üü¶üü¶\nüü™üü™üü™üü™', expected: '5 guesses, 1 mistake' },
            { name: 'Many mistakes', type: 'edge', data: 'Connections\nPuzzle #567\nüü®üü®üü©üü©\nüü®üü©üü©üü©\nüü®üü®üü®üü®\nüü©üü©üü©üü©\nüü¶üü¶üü¶üü™\nüü¶üü¶üü¶üü¶\nüü™üü™üü™üü™', expected: '7 guesses' },
            { name: 'Failed game', type: 'edge', data: 'Connections\nPuzzle #567\nüü®üü®üü©üü©\nüü®üü©üü©üü©\nüü®üü©üü©üü¶\nüü®üü©üü¶üü¶\n‚ùå', expected: 'Loss detected' },
            { name: 'Invalid - missing header', type: 'error', data: 'Puzzle #567\nüü®üü®üü®üü®\nüü©üü©üü©üü©', expected: 'Not detected' },
            { name: 'Invalid - wrong colors', type: 'error', data: 'Connections\nPuzzle #567\nüî¥üî¥üî¥üî¥', expected: 'Error or rejected' }
          ]
        },
        { id: 'B4', title: 'Strands paste', expected: 'Hints counted', steps: '1. Copy result\n2. Verify hints', launch: '#log', note: '‚ö° Proposed: #log', 
          data: 'Strands #321\n"Theme"\nüí°üîµüîµüîµ\nüîµüîµüü°',
          variants: [
            { name: 'No hints used', type: 'happy', data: 'Strands #321\n"Theme Name"\nüîµüîµüîµüîµ\nüîµüîµüü°', expected: '0 hints' },
            { name: 'One hint', type: 'happy', data: 'Strands #321\n"Theme"\nüí°üîµüîµüîµ\nüîµüîµüü°', expected: '1 hint' },
            { name: 'Multiple hints', type: 'edge', data: 'Strands #321\n"Theme"\nüí°üí°üí°üîµ\nüîµüîµüü°', expected: '3 hints' },
            { name: 'Spangram first', type: 'edge', data: 'Strands #321\n"Theme"\nüü°üîµüîµüîµ\nüîµüîµüîµ', expected: 'Spangram first detected' },
            { name: 'Invalid - no spangram', type: 'error', data: 'Strands #321\n"Theme"\nüîµüîµüîµüîµ\nüîµüîµüîµ', expected: 'Error - missing spangram' }
          ]
        },
        { id: 'B5', title: 'Manual entry', expected: 'Can enter manually', steps: '1. Open log\n2. Manual mode', launch: '#log', note: '‚ö° Proposed: #log',
          variants: [
            { name: 'Enter win', type: 'happy', data: null, expected: 'Can mark as win' },
            { name: 'Enter loss', type: 'happy', data: null, expected: 'Can mark as loss' },
            { name: 'Enter with score', type: 'happy', data: null, expected: 'Can enter numeric score' },
            { name: 'Enter for past date', type: 'edge', data: null, expected: 'Can backfill' },
            { name: 'Enter duplicate', type: 'error', data: null, expected: 'Warning or prevented' }
          ]
        },
        { id: 'B6', title: 'Card updates', expected: 'Card shows result', steps: '1. Log game\n2. Check card', launch: '', note: 'Check home after log' },
        { id: 'B7', title: 'Streak increments', expected: 'Streak +1', steps: '1. Note streak\n2. Log\n3. Verify', launch: '', note: 'Check home after log' },
        { id: 'B8', title: 'Calendar updates', expected: 'Today highlighted', steps: '1. Log game\n2. Check calendar', launch: '#games', note: 'Games tab' }
    ]},
    { id: 'social', name: 'Social', icon: 'üë•', tests: [
        { id: 'C1', title: 'Google sign-in', expected: 'Auth successful', steps: '1. Menu > Account\n2. Sign in', launch: '#menu', note: '‚ö° Proposed: #menu',
          variants: [
            { name: 'Fresh sign-in', type: 'happy', expected: 'Account created, synced' },
            { name: 'Returning user', type: 'happy', expected: 'Data restored from cloud' },
            { name: 'Cancel sign-in', type: 'edge', expected: 'Returns to app gracefully' },
            { name: 'Network error during sign-in', type: 'error', expected: 'Error message shown' }
          ]
        },
        { id: 'C2', title: 'Cloud sync icon', expected: '‚òÅÔ∏è shows', steps: '1. Sign in\n2. Check icon', launch: '', note: 'Check after sign-in' },
        { id: 'C3', title: 'Add friend', expected: 'Can enter code', steps: '1. Social tab\n2. Add friend', launch: '#social', note: 'Social tab',
          variants: [
            { name: 'Valid friend code', type: 'happy', data: 'ABC123', expected: 'Friend added' },
            { name: 'Own code', type: 'error', data: '(own code)', expected: 'Cannot add self' },
            { name: 'Invalid code format', type: 'error', data: '!!!', expected: 'Error message' },
            { name: 'Non-existent code', type: 'error', data: 'ZZZZZ9', expected: 'User not found' },
            { name: 'Already friends', type: 'edge', data: '(existing friend)', expected: 'Already added message' },
            { name: 'Empty code', type: 'error', data: '', expected: 'Validation error' }
          ]
        },
        { id: 'C4', title: 'Friend list', expected: 'Shows with status', steps: '1. Social > Friends\n2. Verify', launch: '#social', note: 'Friends list',
          variants: [
            { name: 'No friends', type: 'edge', expected: 'Empty state shown' },
            { name: '1 friend', type: 'happy', expected: 'Friend card visible' },
            { name: 'Many friends (10+)', type: 'edge', expected: 'List scrolls, no lag' },
            { name: 'Friend online today', type: 'happy', expected: 'Green indicator' },
            { name: 'Friend inactive', type: 'happy', expected: 'Gray indicator' }
          ]
        },
        { id: 'C5', title: 'Friend profile', expected: 'Profile modal', steps: '1. Tap friend\n2. Verify', launch: '#social', note: 'Tap card' },
        { id: 'C6', title: 'Nudge friend', expected: 'Nudge works', steps: '1. Find inactive\n2. Nudge', launch: '#social', note: 'Gray dot',
          variants: [
            { name: 'Nudge inactive friend', type: 'happy', expected: 'Nudge sent' },
            { name: 'Nudge active friend', type: 'edge', expected: 'May be disabled or sent' },
            { name: 'Nudge same friend twice', type: 'edge', expected: 'Rate limited or allowed' }
          ]
        },
        { id: 'C7', title: 'Activity feed', expected: 'Shows activity', steps: '1. Activity tab\n2. Verify', launch: '#social', note: 'Activity',
          variants: [
            { name: 'No activity', type: 'edge', expected: 'Empty state' },
            { name: 'Friend completed game', type: 'happy', expected: 'Shows in feed' },
            { name: 'Many activities', type: 'edge', expected: 'Pagination or scroll' }
          ]
        },
        { id: 'C8', title: 'Leaderboard', expected: 'Rankings show', steps: '1. Friends\n2. Leaderboard', launch: '#social', note: 'Rankings' }
    ]},
    { id: 'battles', name: 'Battles', icon: '‚öîÔ∏è', tests: [
        { id: 'D1', title: 'Create battle', expected: 'Can create', steps: '1. Battles tab\n2. Create', launch: '#social', note: 'Battles',
          variants: [
            { name: 'Create 1-day battle', type: 'happy', expected: 'Battle created, ends in 24h' },
            { name: 'Create 7-day battle', type: 'happy', expected: 'Battle created, ends in 7 days' },
            { name: 'Create while signed out', type: 'error', expected: 'Prompted to sign in' },
            { name: 'Create with no games selected', type: 'edge', expected: 'Error or uses default games' },
            { name: 'Create while offline', type: 'error', expected: 'Error message shown' }
          ]
        },
        { id: 'D2', title: 'Public/private', expected: 'Toggle works', steps: '1. Create\n2. Toggle', launch: '#social', note: 'Create flow',
          variants: [
            { name: 'Create public battle', type: 'happy', expected: 'Appears in public lobby' },
            { name: 'Create private battle', type: 'happy', expected: 'Only joinable by code' },
            { name: 'Switch public to private', type: 'edge', expected: 'Removed from lobby' },
            { name: 'Switch private to public', type: 'edge', expected: 'Appears in lobby' }
          ]
        },
        { id: 'D3', title: 'Battle code', expected: '6-char code', steps: '1. Create\n2. Note code', launch: '#social', note: 'After create',
          variants: [
            { name: 'Code is 6 characters', type: 'happy', expected: 'Alphanumeric, 6 chars' },
            { name: 'Code is unique', type: 'happy', expected: 'Different from other battles' },
            { name: 'Copy code button', type: 'happy', expected: 'Code copied to clipboard' },
            { name: 'Share code via native share', type: 'happy', expected: 'Share sheet opens with code' }
          ]
        },
        { id: 'D4', title: 'Join by code', expected: 'Can join', steps: '1. Get code\n2. Join', launch: '#social', note: 'Join option',
          variants: [
            { name: 'Valid code', type: 'happy', expected: 'Joined successfully' },
            { name: 'Invalid code format', type: 'error', expected: 'Invalid code error' },
            { name: 'Expired battle code', type: 'error', expected: 'Battle ended message' },
            { name: 'Already joined battle', type: 'edge', expected: 'Already member message' },
            { name: 'Own battle code', type: 'edge', expected: 'Already creator/member' },
            { name: 'Private battle (not invited)', type: 'error', expected: 'Cannot join or request access' },
            { name: 'Battle at max capacity', type: 'edge', expected: 'Battle full message' }
          ]
        },
        { id: 'D5', title: 'Battle scoring', expected: 'Scores update', steps: '1. Join\n2. Log\n3. Check', launch: '#social', note: 'Log game',
          variants: [
            { name: 'Log win - points added', type: 'happy', expected: 'Score increases correctly' },
            { name: 'Log loss - partial points', type: 'happy', expected: 'Partial points or 0 added' },
            { name: 'Log multiple games same day', type: 'happy', expected: 'All scores counted' },
            { name: 'Log after battle ended', type: 'edge', expected: 'Score not counted for battle' },
            { name: 'Duplicate result same day', type: 'error', expected: 'Only first counts' },
            { name: 'Leaderboard updates live', type: 'happy', expected: 'Position updates immediately' }
          ]
        },
        { id: 'D6', title: 'Public lobby', expected: 'Can browse', steps: '1. Battles\n2. Browse', launch: '#social', note: 'Public list',
          variants: [
            { name: 'View active battles', type: 'happy', expected: 'List of joinable battles' },
            { name: 'Empty lobby', type: 'edge', expected: 'No battles message or CTA' },
            { name: 'Filter by game type', type: 'happy', expected: 'Filtered list shows' },
            { name: 'Sort by participants', type: 'happy', expected: 'Sorted correctly' },
            { name: 'Sort by end date', type: 'happy', expected: 'Sorted correctly' },
            { name: 'Refresh lobby', type: 'happy', expected: 'List updates' }
          ]
        },
        { id: 'D7', title: 'Battle deep link', expected: 'Opens battle', steps: '1. Use link\n2. Verify', launch: '#battle=TEST', note: 'Deep link',
          variants: [
            { name: 'Valid battle code in URL', type: 'happy', expected: 'Battle details shown' },
            { name: 'Invalid battle code', type: 'error', expected: 'Not found message' },
            { name: 'Expired battle', type: 'edge', expected: 'Battle ended, show results' },
            { name: 'Deep link while signed out', type: 'edge', expected: 'Sign in prompt then show battle' },
            { name: 'Deep link to own battle', type: 'happy', expected: 'Shows battle with admin options' }
          ]
        }
    ]},
    { id: 'share', name: 'Share', icon: 'üì§', tests: [
        { id: 'E1', title: 'Share tab loads', expected: 'Preview shows', steps: '1. Share tab\n2. Verify', launch: '#share', note: 'Share tab',
          variants: [
            { name: 'With results today', type: 'happy', expected: 'Preview shows todays games' },
            { name: 'No results today', type: 'edge', expected: 'Empty state or prompt to log' },
            { name: 'Partial results (some games)', type: 'happy', expected: 'Shows completed games only' },
            { name: 'All games completed', type: 'happy', expected: 'Full summary shown' }
          ]
        },
        { id: 'E2', title: 'Copy text', expected: 'Copied', steps: '1. Copy\n2. Paste test', launch: '#share', note: 'Copy button',
          variants: [
            { name: 'Copy with results', type: 'happy', expected: 'Full text copied to clipboard' },
            { name: 'Copy with no results', type: 'edge', expected: 'Empty or default message' },
            { name: 'Copy fails (permission denied)', type: 'error', expected: 'Fallback or error message' },
            { name: 'Verify clipboard content', type: 'happy', expected: 'Paste matches preview' }
          ]
        },
        { id: 'E3', title: 'Download image', expected: 'Downloads', steps: '1. Download\n2. Check', launch: '#share', note: 'Download',
          variants: [
            { name: 'Download PNG', type: 'happy', expected: 'PNG file downloads' },
            { name: 'Download in dark mode', type: 'happy', expected: 'Dark themed image' },
            { name: 'Download in light mode', type: 'happy', expected: 'Light themed image' },
            { name: 'Download on mobile Safari', type: 'edge', expected: 'Opens in new tab or share sheet' },
            { name: 'Download with long username', type: 'edge', expected: 'Text truncated properly' },
            { name: 'Image quality check', type: 'happy', expected: 'Crisp, readable text' }
          ]
        },
        { id: 'E4', title: 'Style options', expected: 'Styles work', steps: '1. Try styles\n2. Verify', launch: '#share', note: 'Styles',
          variants: [
            { name: 'Default style', type: 'happy', expected: 'Standard layout shown' },
            { name: 'Compact style', type: 'happy', expected: 'Condensed layout' },
            { name: 'Detailed style', type: 'happy', expected: 'Full stats shown' },
            { name: 'Style persists on reload', type: 'edge', expected: 'Same style after refresh' },
            { name: 'Switch between styles', type: 'happy', expected: 'Preview updates immediately' }
          ]
        },
        { id: 'E5', title: 'Native share', expected: 'Sheet opens', steps: '1. Share\n2. Verify', launch: '#share', note: 'Mobile',
          variants: [
            { name: 'Share on iOS', type: 'happy', expected: 'iOS share sheet opens' },
            { name: 'Share on Android', type: 'happy', expected: 'Android share menu opens' },
            { name: 'Share on desktop (no native)', type: 'edge', expected: 'Fallback copy or download' },
            { name: 'Cancel share', type: 'edge', expected: 'Returns to app gracefully' },
            { name: 'Share to specific app', type: 'happy', expected: 'Content appears in target app' }
          ]
        },
        { id: 'E6', title: 'Friend comparison', expected: 'Beat X friends', steps: '1. Have friends\n2. Check', launch: '#share', note: 'Need friends',
          variants: [
            { name: 'Beat all friends', type: 'happy', expected: 'Beat X of X friends shown' },
            { name: 'Beat some friends', type: 'happy', expected: 'Beat X of Y friends shown' },
            { name: 'Beat no friends', type: 'edge', expected: 'Beat 0 or encouraging message' },
            { name: 'No friends added', type: 'edge', expected: 'Add friends CTA or hidden' },
            { name: 'Friends havent played', type: 'edge', expected: 'Waiting or N/A shown' }
          ]
        },
        { id: 'E7', title: 'Referral code', expected: 'Code shows', steps: '1. Menu\n2. Invite', launch: '#invite', note: '‚ö° Proposed: #invite',
          variants: [
            { name: 'View own referral code', type: 'happy', expected: 'Unique code displayed' },
            { name: 'Copy referral link', type: 'happy', expected: 'Full URL copied' },
            { name: 'Share referral', type: 'happy', expected: 'Share sheet with link' },
            { name: 'Referral while signed out', type: 'error', expected: 'Sign in prompt' },
            { name: 'Track referral count', type: 'happy', expected: 'Shows X people joined' }
          ]
        }
    ]},
    { id: 'settings', name: 'Settings', icon: '‚öôÔ∏è', tests: [
        { id: 'F1', title: 'Menu animation', expected: 'Smooth', steps: '1. Open menu\n2. Close', launch: '#menu', note: '‚ö° Proposed: #menu',
          variants: [
            { name: 'Open animation', type: 'happy', expected: 'Slides in smoothly' },
            { name: 'Close animation', type: 'happy', expected: 'Slides out smoothly' },
            { name: 'Tap outside to close', type: 'happy', expected: 'Menu closes' },
            { name: 'Swipe to close', type: 'edge', expected: 'Swipe gesture works' },
            { name: 'Rapid open/close', type: 'edge', expected: 'No animation glitches' }
          ]
        },
        { id: 'F2', title: 'Settings order', expected: 'First item', steps: '1. Open\n2. Check', launch: '#menu', note: '‚ö° Proposed: #menu',
          variants: [
            { name: 'Settings is first option', type: 'happy', expected: 'At top of menu' },
            { name: 'All menu items visible', type: 'happy', expected: 'No items cut off' },
            { name: 'Menu scrollable if needed', type: 'edge', expected: 'Can scroll to see all' }
          ]
        },
        { id: 'F3', title: 'Dark mode', expected: 'Theme switches', steps: '1. Toggle\n2. Verify', launch: '#settings', note: '‚ö° Proposed: #settings',
          variants: [
            { name: 'Switch to dark', type: 'happy', expected: 'Dark theme applied' },
            { name: 'Switch to light', type: 'happy', expected: 'Light theme applied' },
            { name: 'Persists on reload', type: 'happy', expected: 'Same theme after refresh' },
            { name: 'Respects system preference', type: 'edge', expected: 'Follows OS setting if auto' },
            { name: 'All screens themed', type: 'happy', expected: 'No white flashes or missed elements' },
            { name: 'Share preview matches theme', type: 'happy', expected: 'Preview uses current theme' }
          ]
        },
        { id: 'F4', title: 'Sound toggle', expected: 'Persists', steps: '1. Toggle\n2. Reload', launch: '#settings', note: '‚ö° Proposed: #settings',
          variants: [
            { name: 'Enable sounds', type: 'happy', expected: 'Sounds play on actions' },
            { name: 'Disable sounds', type: 'happy', expected: 'No sounds play' },
            { name: 'Persists on reload', type: 'happy', expected: 'Same setting after refresh' },
            { name: 'Sound with phone muted', type: 'edge', expected: 'Respects device mute' },
            { name: 'Sound preview', type: 'happy', expected: 'Can hear sample sound' }
          ]
        },
        { id: 'F5', title: 'Goal change', expected: 'Updates', steps: '1. Change\n2. Verify', launch: '#settings', note: '‚ö° Proposed: #settings',
          variants: [
            { name: 'Set goal to 3', type: 'happy', expected: 'Goal updated to 3' },
            { name: 'Set goal to 5', type: 'happy', expected: 'Goal updated to 5' },
            { name: 'Set goal to 7', type: 'happy', expected: 'Goal updated to 7' },
            { name: 'Home reflects new goal', type: 'happy', expected: 'Progress bar updates' },
            { name: 'Goal persists on reload', type: 'happy', expected: 'Same goal after refresh' },
            { name: 'Goal syncs to cloud', type: 'happy', expected: 'Same on other devices' }
          ]
        },
        { id: 'F6', title: 'Export data', expected: 'Downloads', steps: '1. Export\n2. Check', launch: '#settings', note: '‚ö° Proposed: #settings',
          variants: [
            { name: 'Export JSON', type: 'happy', expected: 'JSON file downloads' },
            { name: 'Export with all data', type: 'happy', expected: 'Contains games, results, settings' },
            { name: 'Export empty state', type: 'edge', expected: 'Valid JSON with empty arrays' },
            { name: 'Export large history', type: 'edge', expected: 'Handles 365+ days of data' },
            { name: 'File can be reimported', type: 'happy', expected: 'Import restores data' }
          ]
        },
        { id: 'F7', title: 'Tutorial access', expected: 'Starts', steps: '1. Help\n2. Tour', launch: '#tutorial', note: 'Tutorial',
          variants: [
            { name: 'Start tutorial from menu', type: 'happy', expected: 'Tutorial begins' },
            { name: 'Complete all steps', type: 'happy', expected: 'Tutorial completes' },
            { name: 'Skip tutorial', type: 'edge', expected: 'Can exit early' },
            { name: 'Tutorial on mobile', type: 'happy', expected: 'Works on small screens' },
            { name: 'Tutorial highlights correct elements', type: 'happy', expected: 'Spotlight on right areas' }
          ]
        }
    ]},
    { id: 'mobile', name: 'Mobile', icon: 'üì±', tests: [
        { id: 'G1', title: 'PWA Android', expected: 'Installs', steps: '1. Chrome\n2. Install', launch: '', note: 'Chrome',
          variants: [
            { name: 'Install prompt appears', type: 'happy', expected: 'Add to Home Screen shown' },
            { name: 'Install completes', type: 'happy', expected: 'App icon on home screen' },
            { name: 'Opens as standalone', type: 'happy', expected: 'No browser UI visible' },
            { name: 'Splash screen shows', type: 'happy', expected: 'Branded splash on launch' },
            { name: 'Already installed', type: 'edge', expected: 'Open in app or no prompt' }
          ]
        },
        { id: 'G2', title: 'PWA iOS', expected: 'Adds home', steps: '1. Safari\n2. Add', launch: '', note: 'Safari',
          variants: [
            { name: 'Add to Home Screen option', type: 'happy', expected: 'Option in share sheet' },
            { name: 'Icon appears on home', type: 'happy', expected: 'Custom icon shown' },
            { name: 'Opens as standalone', type: 'happy', expected: 'No Safari UI' },
            { name: 'Splash screen shows', type: 'happy', expected: 'Branded splash' },
            { name: 'Status bar styled', type: 'happy', expected: 'Matches app theme' }
          ]
        },
        { id: 'G3', title: 'Bottom nav', expected: '3 tabs', steps: '1. Check\n2. Count', launch: '', note: 'Nav bar',
          variants: [
            { name: 'All tabs visible', type: 'happy', expected: 'Home, Games, Social visible' },
            { name: 'Active tab highlighted', type: 'happy', expected: 'Current tab has indicator' },
            { name: 'Tap switches tab', type: 'happy', expected: 'Content changes' },
            { name: 'Icons render correctly', type: 'happy', expected: 'No broken icons' },
            { name: 'Labels readable', type: 'happy', expected: 'Text not cut off' }
          ]
        },
        { id: 'G4', title: 'Safe area', expected: 'No overlap', steps: '1. Check edges', launch: '', note: 'Notch',
          variants: [
            { name: 'iPhone notch clearance', type: 'happy', expected: 'Content below notch' },
            { name: 'iPhone home indicator', type: 'happy', expected: 'Nav above indicator' },
            { name: 'Android status bar', type: 'happy', expected: 'Content below status' },
            { name: 'Landscape orientation', type: 'edge', expected: 'No overlap on sides' },
            { name: 'Dynamic Island (iPhone 14+)', type: 'edge', expected: 'Content clears island' }
          ]
        },
        { id: 'G5', title: 'Touch targets', expected: '44px+', steps: '1. Tap all\n2. Note small', launch: '', note: 'Buttons',
          variants: [
            { name: 'Nav buttons 44px+', type: 'happy', expected: 'Easy to tap' },
            { name: 'Action buttons 44px+', type: 'happy', expected: 'Easy to tap' },
            { name: 'Close buttons accessible', type: 'happy', expected: 'Not too small' },
            { name: 'Toggle switches', type: 'happy', expected: 'Easy to tap' },
            { name: 'Links in text', type: 'edge', expected: 'Tappable without zooming' }
          ]
        },
        { id: 'G6', title: 'Keyboard', expected: 'Input visible', steps: '1. Tap input\n2. Verify', launch: '', note: 'Keyboard',
          variants: [
            { name: 'Input scrolls into view', type: 'happy', expected: 'Field visible above keyboard' },
            { name: 'Can dismiss keyboard', type: 'happy', expected: 'Tap outside or done button' },
            { name: 'Paste area accessible', type: 'happy', expected: 'Log input visible' },
            { name: 'Search input', type: 'happy', expected: 'Field stays visible' },
            { name: 'Form inputs', type: 'happy', expected: 'All fields reachable' }
          ]
        },
        { id: 'G7', title: 'Offline', expected: 'Works cached', steps: '1. Airplane\n2. Use', launch: '', note: 'Offline',
          variants: [
            { name: 'App loads offline', type: 'happy', expected: 'Cached version shown' },
            { name: 'Can view past results', type: 'happy', expected: 'History accessible' },
            { name: 'Can log games offline', type: 'edge', expected: 'Queued for sync' },
            { name: 'Offline indicator shown', type: 'happy', expected: 'User knows offline' },
            { name: 'Syncs when back online', type: 'happy', expected: 'Data uploads' },
            { name: 'Social features disabled', type: 'edge', expected: 'Graceful error or hidden' }
          ]
        }
    ]},
    { id: 'deeplinks', name: 'Links', icon: 'üîó', tests: [
        { id: 'H1', title: 'Referral #ref', expected: 'Code stored', steps: '1. Open link\n2. Check', launch: '#ref=TEST', note: 'Referral',
          variants: [
            { name: 'Valid referral code', type: 'happy', launch: '#ref=ABC123', expected: 'Code stored' },
            { name: 'Empty referral', type: 'error', launch: '#ref=', expected: 'Ignored gracefully' },
            { name: 'Long referral code', type: 'edge', launch: '#ref=VERYLONGCODE123456', expected: 'Handled or truncated' },
            { name: 'Special characters', type: 'error', launch: '#ref=<script>', expected: 'Sanitized, no XSS' }
          ]
        },
        { id: 'H2', title: 'Friend #friend', expected: 'Prompt shows', steps: '1. Open link\n2. Verify', launch: '#friend=test', note: 'Friend',
          variants: [
            { name: 'Valid friend ID', type: 'happy', launch: '#friend=validuser', expected: 'Add friend prompt' },
            { name: 'Own user ID', type: 'edge', launch: '#friend=(self)', expected: 'Cannot add self' },
            { name: 'Invalid friend ID', type: 'error', launch: '#friend=nonexistent', expected: 'User not found' },
            { name: 'Empty friend param', type: 'error', launch: '#friend=', expected: 'Ignored gracefully' }
          ]
        },
        { id: 'H3', title: 'Battle #battle', expected: 'Battle loads', steps: '1. Open link\n2. Verify', launch: '#battle=TEST', note: 'Battle',
          variants: [
            { name: 'Valid battle code', type: 'happy', launch: '#battle=ABC123', expected: 'Battle details shown' },
            { name: 'Expired battle', type: 'edge', launch: '#battle=OLDCODE', expected: 'Battle ended message' },
            { name: 'Invalid battle code', type: 'error', launch: '#battle=XXXXX', expected: 'Not found message' },
            { name: 'Private battle (not member)', type: 'edge', launch: '#battle=PRIVATE', expected: 'Access denied or join prompt' }
          ]
        },
        { id: 'H4', title: 'Profile #profile', expected: 'Profile shows', steps: '1. Open link\n2. Verify', launch: '#profile=test', note: 'Profile' },
        { id: 'H5', title: 'Invalid params', expected: 'No crash', steps: '1. Bad params\n2. Verify', launch: '#invalid=xyz', note: 'Error handling',
          variants: [
            { name: 'Unknown hash', type: 'error', launch: '#unknown', expected: 'Ignored, no crash' },
            { name: 'Malformed params', type: 'error', launch: '#log=&&&', expected: 'Sanitized' },
            { name: 'XSS attempt', type: 'error', launch: '#<script>alert(1)<\/script>', expected: 'Sanitized, no XSS' },
            { name: 'SQL injection attempt', type: 'error', launch: "#'; DROP TABLE users;--", expected: 'Sanitized' },
            { name: 'Very long hash', type: 'edge', launch: '#' + 'x'.repeat(1000), expected: 'Handled, no crash' }
          ]
        }
    ]},
    { id: 'achievements', name: 'Achievements', icon: 'üèÜ', tests: [
        { id: 'I1', title: 'View achievements', expected: 'Achievement list shows', steps: '1. Menu > Achievements\n2. Verify list', launch: '#achievements', note: '‚ö° Proposed: #achievements',
          variants: [
            { name: 'All categories visible', type: 'happy', expected: 'Streaks, Games, Social sections' },
            { name: 'Locked achievements shown', type: 'happy', expected: 'Grayed out or hidden progress' },
            { name: 'Unlocked achievements highlighted', type: 'happy', expected: 'Colored or badged' },
            { name: 'Achievement count shown', type: 'happy', expected: 'X of Y unlocked' },
            { name: 'Empty state (new user)', type: 'edge', expected: 'All locked, encouraging message' }
          ]
        },
        { id: 'I2', title: 'Achievement progress', expected: 'Progress bars visible', steps: '1. Open achievements\n2. Check progress', launch: '#achievements', note: '‚ö° Proposed: #achievements',
          variants: [
            { name: 'Progress bar shows %', type: 'happy', expected: 'Visual progress indicator' },
            { name: 'Progress text (X/Y)', type: 'happy', expected: 'Numeric progress shown' },
            { name: 'Near completion highlight', type: 'edge', expected: 'Almost there indicator' },
            { name: '0% progress', type: 'edge', expected: 'Empty bar, not hidden' },
            { name: '100% progress', type: 'happy', expected: 'Full bar, unlocked state' }
          ]
        },
        { id: 'I3', title: 'Unlock achievement', expected: 'Badge unlocks with animation', steps: '1. Complete requirement\n2. Verify unlock', launch: '', note: 'Trigger manually',
          variants: [
            { name: 'Animation plays', type: 'happy', expected: 'Celebration animation' },
            { name: 'Sound plays (if enabled)', type: 'happy', expected: 'Achievement sound' },
            { name: 'Badge changes to unlocked', type: 'happy', expected: 'Visual state change' },
            { name: 'Unlock date recorded', type: 'happy', expected: 'Date shown on badge' },
            { name: 'Multiple unlocks at once', type: 'edge', expected: 'All animate sequentially' }
          ]
        },
        { id: 'I4', title: 'Achievement notification', expected: 'Toast/popup shows', steps: '1. Earn achievement\n2. Check notification', launch: '', note: 'Trigger manually',
          variants: [
            { name: 'Toast appears', type: 'happy', expected: 'Notification shown' },
            { name: 'Achievement name in toast', type: 'happy', expected: 'Title visible' },
            { name: 'Toast auto-dismisses', type: 'happy', expected: 'Goes away after delay' },
            { name: 'Tap toast opens achievements', type: 'happy', expected: 'Navigates to list' },
            { name: 'Multiple toasts queued', type: 'edge', expected: 'Show sequentially' }
          ]
        },
        { id: 'I5', title: 'Streak achievements', expected: '7/30/100 day badges', steps: '1. Check streak badges\n2. Verify criteria', launch: '#achievements', note: '‚ö° Proposed: #achievements',
          variants: [
            { name: '7-day streak badge', type: 'happy', expected: 'Unlocks at 7 days' },
            { name: '30-day streak badge', type: 'happy', expected: 'Unlocks at 30 days' },
            { name: '100-day streak badge', type: 'edge', expected: 'Unlocks at 100 days' },
            { name: '365-day streak badge', type: 'edge', expected: 'Unlocks at 365 days' },
            { name: 'Streak broken, progress reset', type: 'error', expected: 'Progress back to 0' },
            { name: 'Current streak shown', type: 'happy', expected: 'Days count visible' }
          ]
        },
        { id: 'I6', title: 'Share achievement', expected: 'Can share badge', steps: '1. Tap achievement\n2. Share option', launch: '#achievements', note: '‚ö° Proposed: #achievements',
          variants: [
            { name: 'Share button on unlocked', type: 'happy', expected: 'Share option visible' },
            { name: 'No share on locked', type: 'happy', expected: 'Button hidden or disabled' },
            { name: 'Share opens native sheet', type: 'happy', expected: 'OS share menu' },
            { name: 'Share image generated', type: 'happy', expected: 'Badge image created' },
            { name: 'Share text includes achievement', type: 'happy', expected: 'Name in share text' }
          ]
        }
    ]},
    { id: 'rewards', name: 'Rewards', icon: 'üõçÔ∏è', tests: [
        { id: 'J1', title: 'Token balance display', expected: 'Token count in header', steps: '1. Check header\n2. Verify üéüÔ∏è count', launch: '', note: 'Header always visible',
          variants: [
            { name: 'Balance shows in header', type: 'happy', expected: 'Token count visible' },
            { name: 'Zero balance shown', type: 'edge', expected: '0 or empty state' },
            { name: 'Large balance formatted', type: 'edge', expected: '1.2K or similar format' },
            { name: 'Balance updates on earn', type: 'happy', expected: 'Count increases' },
            { name: 'Balance updates on spend', type: 'happy', expected: 'Count decreases' }
          ]
        },
        { id: 'J2', title: 'Coin balance display', expected: 'Coin count visible', steps: '1. Check header\n2. Verify ü™ô count', launch: '', note: 'Header always visible',
          variants: [
            { name: 'Coin count in header', type: 'happy', expected: 'Balance visible' },
            { name: 'Zero coins shown', type: 'edge', expected: '0 or placeholder' },
            { name: 'Coins vs tokens distinct', type: 'happy', expected: 'Different icons/colors' },
            { name: 'Tap opens shop', type: 'happy', expected: 'Navigates to rewards' }
          ]
        },
        { id: 'J3', title: 'Open rewards shop', expected: 'Shop modal opens', steps: '1. Tap shop icon\n2. Verify products', launch: '#shop', note: '‚ö° Proposed: #shop',
          variants: [
            { name: 'Shop modal opens', type: 'happy', expected: 'Product list shown' },
            { name: 'Products have prices', type: 'happy', expected: 'Token/coin cost shown' },
            { name: 'Products have images', type: 'happy', expected: 'Visual icons' },
            { name: 'Categories/filters', type: 'happy', expected: 'Can filter products' },
            { name: 'Empty shop', type: 'edge', expected: 'No products message' }
          ]
        },
        { id: 'J4', title: 'Redeem reward', expected: 'Redemption flow works', steps: '1. Select reward\n2. Confirm redeem', launch: '#shop', note: '‚ö° Proposed: #shop',
          variants: [
            { name: 'Select product', type: 'happy', expected: 'Details/confirm shown' },
            { name: 'Confirm purchase', type: 'happy', expected: 'Balance deducted' },
            { name: 'Cancel purchase', type: 'edge', expected: 'Returns to shop' },
            { name: 'Reward applied', type: 'happy', expected: 'Feature unlocked or item given' },
            { name: 'Purchase receipt', type: 'happy', expected: 'Confirmation shown' }
          ]
        },
        { id: 'J5', title: 'Insufficient funds', expected: 'Error message shown', steps: '1. Try expensive item\n2. Check error', launch: '#shop', note: '‚ö° Proposed: #shop',
          variants: [
            { name: 'Cannot buy - not enough', type: 'error', expected: 'Error message' },
            { name: 'Buy button disabled', type: 'happy', expected: 'Grayed out if insufficient' },
            { name: 'Shows amount needed', type: 'happy', expected: 'Need X more tokens' },
            { name: 'Earn more CTA', type: 'edge', expected: 'Link to earn tokens' }
          ]
        },
        { id: 'J6', title: 'Token earning', expected: 'Tokens added for actions', steps: '1. Complete action\n2. Check balance', launch: '', note: 'Referral/battle reward',
          variants: [
            { name: 'Earn from referral', type: 'happy', expected: 'Tokens added when friend joins' },
            { name: 'Earn from battle win', type: 'happy', expected: 'Tokens for winning' },
            { name: 'Daily login bonus', type: 'happy', expected: 'Tokens for daily use' },
            { name: 'Streak milestone bonus', type: 'edge', expected: 'Tokens at 7/30/100 days' },
            { name: 'Earning animation', type: 'happy', expected: 'Visual feedback on earn' },
            { name: 'Earning notification', type: 'happy', expected: 'Toast or alert' }
          ]
        }
    ]},
    { id: 'games', name: 'Games Mgmt', icon: 'üéÆ', tests: [
        { id: 'K1', title: 'Reconfigure games', expected: 'Can change selection', steps: '1. Settings > Reconfigure\n2. Change games', launch: '#reconfigure', note: '‚ö° Proposed: #reconfigure',
          variants: [
            { name: 'Open reconfigure screen', type: 'happy', expected: 'Game selection shown' },
            { name: 'Current selection highlighted', type: 'happy', expected: 'Selected games checked' },
            { name: 'Save changes', type: 'happy', expected: 'New selection saved' },
            { name: 'Cancel without saving', type: 'edge', expected: 'Original selection kept' },
            { name: 'No changes made', type: 'edge', expected: 'Can close without error' }
          ]
        },
        { id: 'K2', title: 'Add game to shelf', expected: 'Game appears on home', steps: '1. Reconfigure\n2. Add new game', launch: '#reconfigure', note: '‚ö° Proposed: #reconfigure',
          variants: [
            { name: 'Add one game', type: 'happy', expected: 'Game card appears on home' },
            { name: 'Add multiple games', type: 'happy', expected: 'All new games appear' },
            { name: 'Add to max games', type: 'edge', expected: 'Max limit enforced or allowed' },
            { name: 'Game order on home', type: 'happy', expected: 'Appears in expected position' }
          ]
        },
        { id: 'K3', title: 'Remove game from shelf', expected: 'Game removed', steps: '1. Reconfigure\n2. Uncheck game', launch: '#reconfigure', note: '‚ö° Proposed: #reconfigure',
          variants: [
            { name: 'Remove one game', type: 'happy', expected: 'Game card disappears' },
            { name: 'Remove game with history', type: 'edge', expected: 'History preserved or warned' },
            { name: 'Remove all but one', type: 'edge', expected: 'Minimum 1 enforced' },
            { name: 'Remove and re-add', type: 'edge', expected: 'History restored if kept' }
          ]
        },
        { id: 'K4', title: 'Game stats view', expected: 'History shows', steps: '1. Tap game card\n2. View stats', launch: '#games', note: 'Games tab',
          variants: [
            { name: 'View stats modal opens', type: 'happy', expected: 'Stats sheet/modal shown' },
            { name: 'History calendar view', type: 'happy', expected: 'Calendar with results' },
            { name: 'Win/loss statistics', type: 'happy', expected: 'Totals displayed' },
            { name: 'Average score shown', type: 'happy', expected: 'Avg calculation correct' },
            { name: 'No history yet', type: 'edge', expected: 'Empty state message' },
            { name: 'Streak info shown', type: 'happy', expected: 'Current streak visible' }
          ]
        },
        { id: 'K5', title: 'See all games', expected: 'Full list shows', steps: '1. Home > See All\n2. Browse games', launch: '#games', note: 'Games tab',
          variants: [
            { name: 'All supported games listed', type: 'happy', expected: 'Complete game catalog' },
            { name: 'Games grouped by publisher', type: 'happy', expected: 'NYT, LinkedIn, etc sections' },
            { name: 'Search/filter games', type: 'edge', expected: 'Can find specific game' },
            { name: 'Game info shown', type: 'happy', expected: 'Description or link' }
          ]
        },
        { id: 'K6', title: 'Suggest a game', expected: 'Form submits', steps: '1. Games > Suggest\n2. Submit form', launch: '#suggest', note: '‚ö° Proposed: #suggest',
          variants: [
            { name: 'Open suggestion form', type: 'happy', expected: 'Form appears' },
            { name: 'Submit valid suggestion', type: 'happy', expected: 'Thank you message' },
            { name: 'Submit empty form', type: 'error', expected: 'Validation error' },
            { name: 'Submit duplicate', type: 'edge', expected: 'Already suggested or accepted' }
          ]
        }
    ]},
    { id: 'tracking2', name: 'More Tracking', icon: 'üìù', tests: [
        { id: 'L1', title: 'Mini crossword paste', expected: 'Time parsed', steps: '1. Copy Mini result\n2. Paste & verify', launch: '#log', note: '‚ö° Proposed: #log', data: 'I solved the 1/19/2025 New York Times Mini Crossword in 0:42!' },
        { id: 'L2', title: 'Spelling Bee paste', expected: 'Points parsed', steps: '1. Copy Bee result\n2. Paste & verify', launch: '#log', note: '‚ö° Proposed: #log', data: 'Spelling Bee\nGenius üéØ\n156 points' },
        { id: 'L3', title: 'Letter Boxed paste', expected: 'Moves parsed', steps: '1. Copy result\n2. Paste & verify', launch: '#log', note: '‚ö° Proposed: #log', data: 'Letter Boxed\n3 words' },
        { id: 'L4', title: 'Digits paste', expected: 'Stars parsed', steps: '1. Copy result\n2. Paste & verify', launch: '#log', note: '‚ö° Proposed: #log', data: 'Digits #123\n‚≠ê‚≠ê‚≠ê' },
        { id: 'L5', title: 'Edit logged result', expected: 'Can modify entry', steps: '1. Find logged game\n2. Edit result', launch: '#games', note: 'Games tab' },
        { id: 'L6', title: 'Delete logged result', expected: 'Entry removed', steps: '1. Find logged game\n2. Delete', launch: '#games', note: 'Games tab' },
        { id: 'L7', title: 'Multiple results per day', expected: 'Both show', steps: '1. Log game\n2. Log different game', launch: '#log', note: '‚ö° Proposed: #log' },
        { id: 'L8', title: 'Backfill past date', expected: 'Can log old result', steps: '1. Select past date\n2. Log result', launch: '#log', note: '‚ö° Proposed: #log' }
    ]},
    { id: 'data', name: 'Data', icon: 'üíæ', tests: [
        { id: 'M1', title: 'Export data JSON', expected: 'File downloads', steps: '1. Settings > Export\n2. Check file', launch: '#export', note: '‚ö° Proposed: #export' },
        { id: 'M2', title: 'Import data', expected: 'Data restored', steps: '1. Settings > Import\n2. Select file', launch: '#import', note: '‚ö° Proposed: #import' },
        { id: 'M3', title: 'Reset all data', expected: 'Confirmation + clear', steps: '1. Settings > Reset\n2. Confirm', launch: '#settings', note: '‚ö° Proposed: #settings' },
        { id: 'M4', title: 'Data persistence', expected: 'Data survives reload', steps: '1. Log games\n2. Refresh\n3. Verify', launch: '', note: 'Manual reload test' },
        { id: 'M5', title: 'Cloud sync conflict', expected: 'Merge handled', steps: '1. Edit on 2 devices\n2. Sync', launch: '', note: 'Multi-device test' }
    ]},
    { id: 'sounds', name: 'Sounds', icon: 'üîä', tests: [
        { id: 'N1', title: 'Sound on action', expected: 'Sound plays', steps: '1. Enable sounds\n2. Log game\n3. Listen', launch: '#sounds', note: '‚ö° Proposed: #sounds' },
        { id: 'N2', title: 'Sound muted', expected: 'No sound plays', steps: '1. Disable sounds\n2. Log game\n3. Silent', launch: '#sounds', note: '‚ö° Proposed: #sounds' },
        { id: 'N3', title: 'Customize sounds', expected: 'Can change sounds', steps: '1. Settings > Sounds\n2. Customize', launch: '#sounds', note: '‚ö° Proposed: #sounds' },
        { id: 'N4', title: 'Preview sound', expected: 'Preview plays', steps: '1. Sound settings\n2. Tap preview', launch: '#sounds', note: '‚ö° Proposed: #sounds' }
    ]},
    { id: 'notifications', name: 'Notifications', icon: 'üîî', tests: [
        { id: 'O1', title: 'Activity summary', expected: 'Shows on return', steps: '1. Leave app\n2. Return\n3. Check summary', launch: '', note: 'Welcome back' },
        { id: 'O2', title: 'Friend nudge received', expected: 'Notification shows', steps: '1. Have friend nudge\n2. Check alert', launch: '', note: 'Nudge notification' },
        { id: 'O3', title: 'Battle invite', expected: 'Invite notification', steps: '1. Receive invite\n2. Check notification', launch: '', note: 'Battle notification' },
        { id: 'O4', title: 'Streak reminder', expected: 'Reminder shows', steps: '1. Enable reminders\n2. Wait for alert', launch: '', note: 'Daily reminder' }
    ]},
    { id: 'errors', name: 'Errors', icon: '‚ö†Ô∏è', tests: [
        { id: 'P1', title: 'Network offline', expected: 'Graceful degradation', steps: '1. Go offline\n2. Try features', launch: '', note: 'No connection',
          variants: [
            { name: 'Offline indicator shown', type: 'happy', expected: 'User knows offline' },
            { name: 'Can view cached data', type: 'happy', expected: 'History still visible' },
            { name: 'Cannot sign in', type: 'error', expected: 'Offline error message' },
            { name: 'Cannot add friends', type: 'error', expected: 'Requires connection message' },
            { name: 'Log game offline', type: 'edge', expected: 'Queued or error shown' },
            { name: 'Auto-retry when online', type: 'happy', expected: 'Syncs when connected' }
          ]
        },
        { id: 'P2', title: 'Auth token expired', expected: 'Re-auth prompt', steps: '1. Wait for expiry\n2. Check prompt', launch: '', note: 'Token refresh',
          variants: [
            { name: 'Silent refresh works', type: 'happy', expected: 'Token refreshed automatically' },
            { name: 'Refresh fails - re-login', type: 'edge', expected: 'Sign in prompt shown' },
            { name: 'Data preserved on re-auth', type: 'happy', expected: 'No data loss' },
            { name: 'Partial session restore', type: 'edge', expected: 'Graceful recovery' }
          ]
        },
        { id: 'P3', title: 'Invalid paste data', expected: 'Error message', steps: '1. Paste garbage\n2. Check error', launch: '', note: 'Parse error',
          variants: [
            { name: 'Random text - no match', type: 'error', expected: 'Not recognized message' },
            { name: 'Partial game result', type: 'error', expected: 'Incomplete data error' },
            { name: 'Wrong format', type: 'error', expected: 'Format not recognized' },
            { name: 'Empty paste', type: 'error', expected: 'Nothing to parse' },
            { name: 'XSS in paste', type: 'error', expected: 'Sanitized, no execution' },
            { name: 'Very long text', type: 'edge', expected: 'Handled without crash' }
          ]
        },
        { id: 'P4', title: 'Server error', expected: 'Error shown', steps: '1. Trigger 500\n2. Check message', launch: '', note: 'Backend error',
          variants: [
            { name: '500 error', type: 'error', expected: 'Server error message' },
            { name: '503 unavailable', type: 'error', expected: 'Try again later message' },
            { name: 'Timeout error', type: 'error', expected: 'Request timed out message' },
            { name: 'Retry button shown', type: 'happy', expected: 'Can retry action' },
            { name: 'Error logged', type: 'happy', expected: 'Sent to analytics' }
          ]
        },
        { id: 'P5', title: 'Rate limiting', expected: 'Retry message', steps: '1. Spam actions\n2. Check throttle', launch: '', note: 'Too many requests',
          variants: [
            { name: '429 rate limit hit', type: 'error', expected: 'Slow down message' },
            { name: 'Retry-after shown', type: 'happy', expected: 'Wait time indicated' },
            { name: 'Auto-retry after delay', type: 'edge', expected: 'Retries automatically' },
            { name: 'UI disabled during limit', type: 'happy', expected: 'Buttons disabled' }
          ]
        }
    ]},
    { id: 'social2', name: 'More Social', icon: 'üë§', tests: [
        { id: 'Q1', title: 'Remove friend', expected: 'Friend removed', steps: '1. Friend profile\n2. Remove', launch: '#social', note: 'Social tab' },
        { id: 'Q2', title: 'Block user', expected: 'User blocked', steps: '1. Profile\n2. Block', launch: '#social', note: 'Social tab' },
        { id: 'Q3', title: 'Find from contacts', expected: 'Contact matches shown', steps: '1. Invite > Contacts\n2. Check matches', launch: '#contacts', note: '‚ö° Proposed: #contacts' },
        { id: 'Q4', title: 'Privacy settings', expected: 'Can hide activity', steps: '1. Settings > Privacy\n2. Toggle', launch: '#privacy', note: '‚ö° Proposed: #privacy' }
    ]},
    { id: 'battles2', name: 'More Battles', icon: '‚öîÔ∏è', tests: [
        { id: 'R1', title: 'Leave battle', expected: 'Can exit battle', steps: '1. Open battle\n2. Leave', launch: '#social', note: 'Exit option' },
        { id: 'R2', title: 'Battle completion', expected: 'Winner announced', steps: '1. Wait for end\n2. Check result', launch: '#social', note: 'Battle ends' },
        { id: 'R3', title: 'Battle prizes', expected: 'Prizes distributed', steps: '1. Win battle\n2. Check rewards', launch: '#social', note: 'Prize pool' },
        { id: 'R4', title: 'Battle game filter', expected: 'Can select games', steps: '1. Create battle\n2. Pick games', launch: '#social', note: 'Game selection' }
    ]}
];

// ========== STATE ==========
let currentUser = null;
let isAdmin = false;
let userAssignment = null;
let testResults = {};
let currentSection = null;
let currentTab = 'testing';
let consoleLogs = [];
let debugPanelVisible = false;
let automationRunning = false;
let sessionStart = Date.now();
let detectedPlatform = null;

// ========== CONSOLE CAPTURE ==========
(function() {
    const orig = { log: console.log, warn: console.warn, error: console.error, info: console.info };
    function capture(type, args) {
        const entry = { type, ts: new Date().toISOString(), msg: Array.from(args).map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ') };
        consoleLogs.push(entry);
        if (consoleLogs.length > 1000) consoleLogs.shift();
        updateDebugPanel();
        updateMetrics();
    }
    console.log = function() { capture('log', arguments); orig.log.apply(console, arguments); };
    console.warn = function() { capture('warn', arguments); orig.warn.apply(console, arguments); };
    console.error = function() { capture('error', arguments); orig.error.apply(console, arguments); };
    console.info = function() { capture('info', arguments); orig.info.apply(console, arguments); };
    window.onerror = (m, u, l) => { capture('error', [`Uncaught: ${m} at ${u}:${l}`]); return false; };
    window.onunhandledrejection = e => capture('error', [`Promise: ${e.reason}`]);
})();

// ========== DARK MODE ==========
function initDarkMode() {
    const saved = localStorage.getItem('testplan-theme');
    // Default to dark mode unless explicitly set to light
    if (saved !== 'light') {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
}

function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('testplan-theme', 'light');
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('testplan-theme', 'dark');
    }
    // Re-render user info to update icon
    if (currentUser) renderUserInfo();
    // Update login screen icon if visible
    const loginIcon = document.getElementById('login-theme-icon');
    if (loginIcon) loginIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}

// Initialize dark mode immediately
initDarkMode();

// ========== AUTH ==========
auth.onAuthStateChanged(async user => {
    currentUser = user;
    if (user) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('debug-fab').classList.add('visible');
        isAdmin = ADMIN_EMAILS.includes(user.email);
        renderUserInfo();
        await loadData();
        renderHeaderTabs();
        renderUI();
        updatePlatformUI();
        if (isAdmin) renderAdminPanel();
        renderAutomationTests();
    } else {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');
    }
});

function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => toast('Sign in failed')); }
function signOut() { auth.signOut(); }

function renderUserInfo() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.getElementById('user-info').innerHTML = `
        <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">
            ${isDark ? '‚òÄÔ∏è' : 'üåô'}
        </button>
        ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
        <img class="user-avatar" src="${currentUser.photoURL || ''}" alt="">
        <span>${currentUser.displayName?.split(' ')[0] || ''}</span>
        <button class="header-btn" onclick="signOut()">Sign Out</button>
    `;
}

function renderHeaderTabs() {
    const tabs = [{ id: 'testing', label: 'üß™ Tests' }];
    if (isAdmin) tabs.push({ id: 'admin', label: 'üëë Admin' });
    tabs.push({ id: 'debug', label: 'üîß Debug' }, { id: 'automation', label: 'ü§ñ Auto' }, { id: 'reports', label: 'üìä Reports' });
    document.getElementById('header-tabs').innerHTML = tabs.map(t => 
        `<button class="header-tab ${t.id === currentTab ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}</button>`
    ).join('');
}

function switchTab(tab) {
    currentTab = tab;
    renderHeaderTabs();
    ['testing', 'admin', 'debug', 'automation', 'reports'].forEach(t => 
        document.getElementById(`tab-${t}`)?.classList.toggle('hidden', t !== tab)
    );
    if (tab === 'reports') renderReports();
}

// ========== DATA ==========
async function loadData() {
    const emailKey = currentUser.email.replace(/\./g, ',');
    const [assignSnap, resultsSnap] = await Promise.all([
        db.ref(`test-assignments/${emailKey}`).once('value'),
        db.ref(`test-results/${currentUser.uid}`).once('value')
    ]);
    userAssignment = assignSnap.val();
    testResults = resultsSnap.val() || {};
}

function getAssignedTests() {
    if (isAdmin && !userAssignment) return TEST_SECTIONS.flatMap(s => s.tests);
    if (userAssignment?.testIds) {
        const ids = new Set(userAssignment.testIds);
        return TEST_SECTIONS.flatMap(s => s.tests).filter(t => ids.has(t.id));
    }
    return [];
}

function getAssignedSections() {
    const tests = getAssignedTests();
    const ids = new Set(tests.map(t => t.id));
    return TEST_SECTIONS.filter(s => s.tests.some(t => ids.has(t.id)))
        .map(s => ({ ...s, tests: s.tests.filter(t => ids.has(t.id)) }));
}

// ========== UI ==========
function renderUI() {
    const tests = getAssignedTests();
    const noTests = !tests.length && !isAdmin;
    
    document.getElementById('no-tests').classList.toggle('hidden', !noTests);
    document.getElementById('section-tabs').classList.toggle('hidden', noTests);
    document.getElementById('progress-panel').classList.toggle('hidden', noTests);
    
    if (userAssignment) {
        document.getElementById('assignment-banner').classList.remove('hidden');
        document.getElementById('assignment-desc').innerHTML = `<strong>${userAssignment.focusArea || 'General'}</strong> - ${userAssignment.testIds?.length || 0} tests assigned`;
    }
    
    if (noTests) return;
    
    const sections = getAssignedSections();
    if (sections.length && !currentSection) currentSection = sections[0].id;
    
    renderSectionTabs();
    renderTestCards();
    updateProgress();
}

function renderSectionTabs() {
    const sections = getAssignedSections();
    document.getElementById('section-tabs').innerHTML = sections.map(s => {
        const done = s.tests.filter(t => testResults[t.id]?.status).length;
        return `<button class="section-tab ${s.id === currentSection ? 'active' : ''}" onclick="switchSection('${s.id}')">${s.icon} ${s.name} <span class="count">${done}/${s.tests.length}</span></button>`;
    }).join('');
}

function switchSection(id) { currentSection = id; renderSectionTabs(); renderTestCards(); }

function renderTestCards() {
    const section = getAssignedSections().find(s => s.id === currentSection);
    if (!section) return;
    
    document.getElementById('test-cards').innerHTML = section.tests.map(test => {
        const r = testResults[test.id] || {};
        const status = r.status || 'pending';
        const variantResults = r.variants || {};
        const hasVariants = test.variants && test.variants.length > 0;
        const variantStats = hasVariants ? getVariantStats(test, variantResults) : null;
        
        return `
            <div class="test-card status-${status}" id="card-${test.id}">
                <div class="test-header" onclick="toggleCard('${test.id}')">
                    <span class="test-id">${test.id}</span>
                    <span class="test-title">${test.title}</span>
                    ${hasVariants ? `<span class="variant-badge" title="${variantStats.pass}/${variantStats.total} variants passed">üîÄ ${variantStats.pass}/${variantStats.total}</span>` : ''}
                    ${r.platform ? `<span class="platform-badge">${getPlatformIcon(r.platform)}</span>` : ''}
                    <span class="test-status ${status}">${status === 'pass' ? '‚úì' : status === 'fail' ? '‚úó' : status === 'skip' ? '‚àí' : ''}</span>
                    <span class="test-chevron">‚ñº</span>
                </div>
                <div class="test-body">
                    <div class="launch-row">
                        <button class="launch-btn" onclick="launchTest('${test.id}')">üöÄ Launch Feature</button>
                        <button class="launch-btn debug" onclick="launchTestDebug('${test.id}')">üîß Launch with Debug</button>
                    </div>
                    <p class="launch-note">${test.note || 'Opens Game Shelf'}</p>
                    
                    ${test.data ? `<div class="test-data" onclick="copyData('${test.id}')" title="Click to copy">${escapeHtml(test.data)}</div><button class="btn btn-sm btn-secondary" onclick="copyData('${test.id}')">üìã Copy Test Data</button>` : ''}
                    
                    <div class="info-box"><h4>Expected</h4>${test.expected}</div>
                    <div class="info-box"><h4>Steps</h4><pre style="margin:0;white-space:pre-wrap;font-family:inherit;">${test.steps}</pre></div>
                    
                    <div class="action-buttons">
                        <button class="action-btn pass ${status === 'pass' ? 'selected' : ''}" onclick="setStatus('${test.id}','pass')">‚úì Pass</button>
                        <button class="action-btn fail ${status === 'fail' ? 'selected' : ''}" onclick="setStatus('${test.id}','fail')">‚úó Fail</button>
                        <button class="action-btn skip ${status === 'skip' ? 'selected' : ''}" onclick="setStatus('${test.id}','skip')">‚àí Skip</button>
                    </div>
                    
                    ${hasVariants ? renderVariantsSection(test, variantResults) : ''}
                    
                    <div class="platform-section">
                        <label style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; display: block; margin-bottom: 6px;">Tested On <button class="btn btn-sm btn-secondary" style="margin-left: 8px; padding: 2px 8px;" onclick="autoDetectPlatform('${test.id}')">üîç Auto-detect</button></label>
                        <div class="platform-buttons" id="platforms-${test.id}">
                            <button class="platform-btn ${r.platform === 'desktop-chrome' ? 'selected' : ''}" onclick="setPlatform('${test.id}','desktop-chrome')">üñ•Ô∏è Chrome</button>
                            <button class="platform-btn ${r.platform === 'desktop-safari' ? 'selected' : ''}" onclick="setPlatform('${test.id}','desktop-safari')">üñ•Ô∏è Safari</button>
                            <button class="platform-btn ${r.platform === 'desktop-firefox' ? 'selected' : ''}" onclick="setPlatform('${test.id}','desktop-firefox')">üñ•Ô∏è Firefox</button>
                            <button class="platform-btn ${r.platform === 'iphone-safari' ? 'selected' : ''}" onclick="setPlatform('${test.id}','iphone-safari')">üì± iPhone Safari</button>
                            <button class="platform-btn ${r.platform === 'iphone-pwa' ? 'selected' : ''}" onclick="setPlatform('${test.id}','iphone-pwa')">üì± iPhone PWA</button>
                            <button class="platform-btn ${r.platform === 'android-chrome' ? 'selected' : ''}" onclick="setPlatform('${test.id}','android-chrome')">ü§ñ Android Chrome</button>
                            <button class="platform-btn ${r.platform === 'android-pwa' ? 'selected' : ''}" onclick="setPlatform('${test.id}','android-pwa')">ü§ñ Android PWA</button>
                            <button class="platform-btn ${r.platform === 'ipad' ? 'selected' : ''}" onclick="setPlatform('${test.id}','ipad')">üì≤ iPad</button>
                        </div>
                    </div>
                    
                    <textarea class="notes-input" id="notes-${test.id}" placeholder="Notes, issues, observations..." onchange="saveNotes('${test.id}')">${r.notes || ''}</textarea>
                    
                    <div class="screenshot-row">
                        <label class="upload-btn">üì∑ Screenshot<input type="file" accept="image/*" onchange="uploadImg('${test.id}',this)"></label>
                        <label class="upload-btn">üì∏ Camera<input type="file" accept="image/*" capture="environment" onchange="uploadImg('${test.id}',this)"></label>
                        ${(r.screenshots || []).map((u, i) => `<div class="screenshot-thumb"><img src="${u}" onclick="window.open('${u}')"><button class="remove" onclick="removeImg('${test.id}',${i})">√ó</button></div>`).join('')}
                    </div>
                    
                    <div class="console-section">
                        <label class="console-toggle"><input type="checkbox" ${r.includeConsole ? 'checked' : ''} onchange="toggleConsole('${test.id}',this.checked)"> Attach console logs</label>
                        ${r.consoleLogs ? `<div class="console-output">${r.consoleLogs.slice(-10).map(l => `<div class="${l.type}">[${l.type}] ${escapeHtml(l.msg)}</div>`).join('')}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Variant helper functions
function getVariantStats(test, variantResults) {
    const total = test.variants.length;
    const pass = test.variants.filter((v, i) => variantResults[i] === 'pass').length;
    const fail = test.variants.filter((v, i) => variantResults[i] === 'fail').length;
    return { total, pass, fail };
}

function renderVariantsSection(test, variantResults) {
    const typeIcons = { happy: '‚úÖ', edge: '‚ö†Ô∏è', error: '‚ùå' };
    const typeLabels = { happy: 'Happy Path', edge: 'Edge Case', error: 'Error Case' };
    
    return `
        <div class="variants-section">
            <div class="variants-header" onclick="toggleVariants('${test.id}')">
                <span>üîÄ Test Variants (${test.variants.length})</span>
                <span class="variants-chevron">‚ñº</span>
            </div>
            <div class="variants-body" id="variants-${test.id}">
                ${test.variants.map((v, i) => {
                    const vStatus = variantResults[i] || 'pending';
                    return `
                        <div class="variant-row status-${vStatus}">
                            <div class="variant-info">
                                <span class="variant-type" title="${typeLabels[v.type]}">${typeIcons[v.type]}</span>
                                <span class="variant-name">${v.name}</span>
                            </div>
                            <div class="variant-expected">${v.expected}</div>
                            ${v.data ? `<div class="variant-data" onclick="copyVariantData('${escapeHtml(v.data)}')" title="Click to copy">${escapeHtml(v.data.substring(0, 50))}${v.data.length > 50 ? '...' : ''}</div>` : ''}
                            ${v.launch ? `<button class="btn btn-sm btn-secondary" onclick="launchVariant('${v.launch}')">üöÄ</button>` : ''}
                            <div class="variant-actions">
                                <button class="variant-btn pass ${vStatus === 'pass' ? 'selected' : ''}" onclick="setVariantStatus('${test.id}',${i},'pass')">‚úì</button>
                                <button class="variant-btn fail ${vStatus === 'fail' ? 'selected' : ''}" onclick="setVariantStatus('${test.id}',${i},'fail')">‚úó</button>
                                <button class="variant-btn skip ${vStatus === 'skip' ? 'selected' : ''}" onclick="setVariantStatus('${test.id}',${i},'skip')">‚àí</button>
                            </div>
                        </div>
                    `;
                }).join('')}
                <div class="variant-actions-row">
                    <button class="btn btn-sm btn-success" onclick="passAllVariants('${test.id}')">‚úì Pass All</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetVariants('${test.id}')">üîÑ Reset</button>
                </div>
            </div>
        </div>
    `;
}

function toggleVariants(testId) {
    const body = document.getElementById(`variants-${testId}`);
    body.classList.toggle('expanded');
    body.previousElementSibling.querySelector('.variants-chevron').style.transform = 
        body.classList.contains('expanded') ? 'rotate(180deg)' : '';
}

function setVariantStatus(testId, variantIndex, status) {
    const existing = testResults[testId] || {};
    const variants = existing.variants || {};
    variants[variantIndex] = status;
    saveResult(testId, { ...existing, variants });
    renderTestCards();
}

function passAllVariants(testId) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === testId);
    if (!test || !test.variants) return;
    const existing = testResults[testId] || {};
    const variants = {};
    test.variants.forEach((v, i) => variants[i] = 'pass');
    saveResult(testId, { ...existing, variants, status: 'pass' });
    renderTestCards();
}

function resetVariants(testId) {
    const existing = testResults[testId] || {};
    saveResult(testId, { ...existing, variants: {} });
    renderTestCards();
}

function copyVariantData(data) {
    navigator.clipboard.writeText(data);
    toast('Variant data copied!');
}

function launchVariant(launch) {
    const debugParams = getDebugParams();
    const url = GAMESHELF_URL + launch + (launch.includes('?') ? '&' : '?') + debugParams;
    window.open(url, '_blank');
    toast('Launching variant test...');
}

// ========== LAUNCH ==========
function launchTest(id) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === id);
    window.open(GAMESHELF_URL + (test?.launch || ''), '_blank');
    toast('Launching Game Shelf...');
}

function launchTestDebug(id) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === id);
    const debugParams = getDebugParams();
    const url = GAMESHELF_URL + (test?.launch || '') + (test?.launch?.includes('?') ? '&' : '?') + debugParams;
    window.open(url, '_blank');
    toast('Launching with debug mode...');
}

function launchWithDebug() {
    const debugParams = getDebugParams();
    window.open(GAMESHELF_URL + '?' + debugParams, '_blank');
    toast('Launching with debug...');
}

function getDebugParams() {
    const opts = [];
    if (document.getElementById('debug-console')?.checked) opts.push('debugConsole=1');
    if (document.getElementById('debug-network')?.checked) opts.push('debugNetwork=1');
    if (document.getElementById('debug-performance')?.checked) opts.push('debugPerf=1');
    if (document.getElementById('debug-storage')?.checked) opts.push('debugStorage=1');
    if (document.getElementById('debug-events')?.checked) opts.push('debugEvents=1');
    if (document.getElementById('debug-errors')?.checked) opts.push('debugErrors=1');
    return opts.join('&');
}

function copyDebugBookmarklet() {
    const code = `javascript:(function(){localStorage.setItem('gs-debug',JSON.stringify({console:true,network:true,perf:true,storage:true,events:true,errors:true}));location.reload();})();`;
    navigator.clipboard.writeText(code);
    toast('Bookmarklet copied! Add to browser bookmarks.');
}

function copyData(id) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === id);
    if (test?.data) { navigator.clipboard.writeText(test.data); toast('Test data copied!'); }
}

// ========== TEST RESULTS ==========
function setStatus(id, status) { 
    const existing = testResults[id] || {};
    // Auto-apply detected platform if not already set
    const platform = existing.platform || detectedPlatform;
    saveResult(id, { ...existing, status, platform }); 
    renderTestCards(); 
}
function setPlatform(id, platform) { saveResult(id, { ...(testResults[id] || {}), platform }); renderTestCards(); }
function saveNotes(id) { saveResult(id, { ...(testResults[id] || {}), notes: document.getElementById(`notes-${id}`).value }); }
function toggleConsole(id, on) { saveResult(id, { ...(testResults[id] || {}), includeConsole: on, consoleLogs: on ? consoleLogs.slice(-50) : null }); }

function saveResult(id, data) {
    testResults[id] = { ...data, tester: { uid: currentUser.uid, name: currentUser.displayName, email: currentUser.email }, updatedAt: new Date().toISOString(), device: navigator.userAgent, screen: `${innerWidth}x${innerHeight}` };
    db.ref(`test-results/${currentUser.uid}/${id}`).set(testResults[id]).then(() => { updateProgress(); toast('Saved'); });
}

async function uploadImg(id, input) {
    const file = input.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        const r = testResults[id] || {};
        const shots = r.screenshots || [];
        shots.push(reader.result);
        saveResult(id, { ...r, screenshots: shots });
        renderTestCards();
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function removeImg(id, i) {
    const r = testResults[id] || {};
    const shots = r.screenshots || [];
    shots.splice(i, 1);
    saveResult(id, { ...r, screenshots: shots });
    renderTestCards();
}

function updateProgress() {
    const tests = getAssignedTests();
    let pass = 0, fail = 0, skip = 0, pending = 0;
    tests.forEach(t => { const s = testResults[t.id]?.status; if (s === 'pass') pass++; else if (s === 'fail') fail++; else if (s === 'skip') skip++; else pending++; });
    const done = pass + fail + skip;
    document.getElementById('progress-fill').style.width = (tests.length ? done / tests.length * 100 : 0) + '%';
    document.getElementById('progress-text').textContent = `${done}/${tests.length} (${tests.length ? Math.round(done / tests.length * 100) : 0}%)`;
    document.getElementById('cnt-pass').textContent = pass;
    document.getElementById('cnt-fail').textContent = fail;
    document.getElementById('cnt-skip').textContent = skip;
    document.getElementById('cnt-pending').textContent = pending;
    renderSectionTabs();
}

// ========== ADMIN ==========
function renderAdminPanel() {
    document.getElementById('test-grid').innerHTML = TEST_SECTIONS.map(s => `
        <div class="section-header">${s.icon} ${s.name} <button class="select-all-btn" onclick="selectSection('${s.id}')">All</button></div>
        ${s.tests.map(t => `<label class="test-checkbox"><input type="checkbox" value="${t.id}">${t.id}</label>`).join('')}
    `).join('');
}

function selectSection(id) {
    const sec = TEST_SECTIONS.find(s => s.id === id);
    sec?.tests.forEach(t => { const cb = document.querySelector(`#test-grid input[value="${t.id}"]`); if (cb) cb.checked = true; });
}

function switchAdminTab(tab) {
    document.querySelectorAll('#tab-admin .tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase().includes(tab)));
    document.getElementById('admin-assign').classList.toggle('hidden', tab !== 'assign');
    document.getElementById('admin-view').classList.toggle('hidden', tab !== 'view');
    document.getElementById('admin-results').classList.toggle('hidden', tab !== 'results');
    if (tab === 'view') loadAssignments();
    if (tab === 'results') loadAllResults();
}

async function createAssignment() {
    const email = document.getElementById('assign-email').value.trim();
    const focus = document.getElementById('assign-focus').value.trim();
    const ids = Array.from(document.querySelectorAll('#test-grid input:checked')).map(c => c.value);
    if (!email) return toast('Enter email');
    if (!ids.length) return toast('Select tests');
    const key = email.replace(/\./g, ',');
    await db.ref(`test-assignments/${key}`).set({ email, focusArea: focus || 'General', testIds: ids, createdAt: new Date().toISOString(), createdBy: currentUser.email });
    toast(`Assigned ${ids.length} tests`);
    document.getElementById('assign-email').value = '';
    document.getElementById('assign-focus').value = '';
    document.querySelectorAll('#test-grid input:checked').forEach(c => c.checked = false);
}

async function loadAssignments() {
    const snap = await db.ref('test-assignments').once('value');
    const data = snap.val() || {};
    document.getElementById('admin-view').innerHTML = Object.entries(data).length ? Object.entries(data).map(([k, a]) => `
        <div class="assignment-card">
            <div><h4>${a.email}</h4><p>${a.focusArea}</p></div>
            <span class="badge">${a.testIds?.length || 0}</span>
            <button class="btn btn-danger btn-sm" onclick="deleteAssignment('${k}')">üóëÔ∏è</button>
        </div>
    `).join('') : '<p style="color:var(--gray-500)">No assignments</p>';
}

async function deleteAssignment(key) {
    if (!confirm('Delete?')) return;
    await db.ref(`test-assignments/${key}`).remove();
    toast('Deleted');
    loadAssignments();
}

async function loadAllResults() {
    const snap = await db.ref('test-results').once('value');
    const data = snap.val() || {};
    const rows = Object.entries(data).map(([uid, results]) => {
        const tests = Object.values(results);
        const platforms = [...new Set(tests.map(t => t.platform).filter(Boolean))];
        return { 
            name: tests[0]?.tester?.name || uid, 
            pass: tests.filter(t => t.status === 'pass').length, 
            fail: tests.filter(t => t.status === 'fail').length, 
            total: tests.length,
            platforms: platforms
        };
    });
    document.getElementById('admin-results').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="exportAllResults()" style="margin-bottom:10px;">üìä Export All</button>
        <table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
            <tr style="background:var(--gray-100)"><th style="padding:6px;text-align:left">Tester</th><th>Pass</th><th>Fail</th><th>Total</th><th style="text-align:left">Platforms</th></tr>
            ${rows.map(r => `<tr style="border-bottom:1px solid var(--gray-200)"><td style="padding:6px">${r.name}</td><td style="text-align:center;color:var(--success)">${r.pass}</td><td style="text-align:center;color:var(--danger)">${r.fail}</td><td style="text-align:center">${r.total}</td><td style="padding:6px;font-size:0.7rem">${r.platforms.map(p => getPlatformIcon(p)).join(', ') || '-'}</td></tr>`).join('')}
        </table>
    `;
}

async function exportAllResults() {
    const snap = await db.ref('test-results').once('value');
    navigator.clipboard.writeText(JSON.stringify(snap.val(), null, 2));
    toast('All results copied!');
}

// ========== DEBUG ==========
function updateDebugPanel() {
    document.getElementById('log-count').textContent = consoleLogs.length;
    document.getElementById('debug-content').innerHTML = consoleLogs.slice(-100).map(l => `<div class="debug-entry ${l.type}">[${l.type}] ${escapeHtml(l.msg)}</div>`).join('');
    document.getElementById('debug-content').scrollTop = 99999;
}

function toggleDebugPanel() {
    debugPanelVisible = !debugPanelVisible;
    document.getElementById('debug-panel').classList.toggle('visible', debugPanelVisible);
}

function clearLogs() { consoleLogs = []; updateDebugPanel(); }

function updateMetrics() {
    document.getElementById('metric-errors').textContent = consoleLogs.filter(l => l.type === 'error').length;
    document.getElementById('metric-warnings').textContent = consoleLogs.filter(l => l.type === 'warn').length;
    document.getElementById('metric-logs').textContent = consoleLogs.length;
    document.getElementById('metric-duration').textContent = Math.round((Date.now() - sessionStart) / 1000) + 's';
}

function clearMetrics() { consoleLogs = []; sessionStart = Date.now(); updateMetrics(); updateDebugPanel(); toast('Metrics cleared'); }

// ========== AUTOMATION ==========
function renderAutomationTests() {
    document.getElementById('automation-tests').innerHTML = TEST_SECTIONS.map(s => `
        <div class="section-header">${s.icon} ${s.name} <button class="select-all-btn" onclick="selectAutoSection('${s.id}')">All</button></div>
        ${s.tests.map(t => `<label class="test-checkbox"><input type="checkbox" value="${t.id}" class="auto-test">${t.id}: ${t.title.substring(0, 25)}...</label>`).join('')}
    `).join('');
}

function selectAutoSection(id) {
    const sec = TEST_SECTIONS.find(s => s.id === id);
    sec?.tests.forEach(t => { const cb = document.querySelector(`.auto-test[value="${t.id}"]`); if (cb) cb.checked = true; });
}

function addAutoLog(msg, type = 'info') {
    const log = document.getElementById('automation-log');
    log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
    log.scrollTop = 99999;
}

function updateAutoStatus(text, detail) {
    document.getElementById('automation-status').innerHTML = `<div class="status-text">${text}</div><div class="status-detail">${detail}</div>`;
}

// Automation state
let autoTestQueue = [];
let autoCurrentIndex = 0;
let autoWindow = null;
let autoTimer = null;
let autoCountdown = 0;
let lastAutoUrl = '';

async function runAllTests() {
    const tests = getAssignedTests();
    document.querySelectorAll('.auto-test').forEach(cb => { cb.checked = tests.some(t => t.id === cb.value); });
    await runSelectedTests();
}

async function runSelectedTests() {
    const selected = Array.from(document.querySelectorAll('.auto-test:checked')).map(cb => cb.value);
    if (!selected.length) return toast('Select tests first');
    
    autoTestQueue = selected;
    autoCurrentIndex = 0;
    automationRunning = true;
    
    const isAutoAdvance = document.getElementById('auto-advance')?.checked;
    const delay = document.getElementById('auto-delay')?.value || '5';
    
    addAutoLog(`Queued ${selected.length} tests`, 'info');
    addAutoLog(`Mode: ${isAutoAdvance ? `Auto-advance every ${delay}s` : 'Manual (click Next Test)'}`, 'info');
    
    // Start first test
    runNextTest();
}

async function runNextTest() {
    // Clear any existing timer
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    if (!automationRunning || autoCurrentIndex >= autoTestQueue.length) {
        automationRunning = false;
        lastAutoUrl = '';
        updateAutoStatus('‚úÖ Complete', `${autoTestQueue.length} tests run`);
        addAutoLog('All tests complete!', 'success');
        return;
    }
    
    const testId = autoTestQueue[autoCurrentIndex];
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === testId);
    const isAutoAdvance = document.getElementById('auto-advance')?.checked;
    const delay = parseInt(document.getElementById('auto-delay')?.value || '5');
    
    addAutoLog(`Running ${testId}: ${test?.title}`, 'info');
    
    // Build URL - only if test has a launch parameter
    const hasLaunch = test?.launch && test.launch.length > 0;
    
    if (hasLaunch) {
        const debugParams = getDebugParams();
        let url = GAMESHELF_URL + test.launch;
        const separator = url.includes('?') ? '&' : '?';
        if (debugParams) url += separator + debugParams;
        
        // For ?fresh=1 tests, close existing window to ensure clean state
        const needsFreshWindow = test.launch.includes('fresh=1');
        if (needsFreshWindow && autoWindow && !autoWindow.closed) {
            addAutoLog('Closing window for fresh start...', 'info');
            autoWindow.close();
            autoWindow = null;
            // Small delay to ensure window is closed
            await new Promise(r => setTimeout(r, 500));
        }
        
        // Only navigate if URL is different from last (or fresh window needed)
        if (url !== lastAutoUrl || needsFreshWindow) {
            addAutoLog(`Opening: ${url}`, 'info');
            lastAutoUrl = url;
            
            // Reuse same window to avoid popup blockers (unless fresh needed)
            if (autoWindow && !autoWindow.closed) {
                autoWindow.location.href = url;
                autoWindow.focus();
            } else {
                autoWindow = window.open(url, 'gameshelf-test');
            }
        } else {
            addAutoLog(`Same URL - continuing in current window`, 'info');
            if (autoWindow && !autoWindow.closed) autoWindow.focus();
        }
    } else {
        addAutoLog(`Continue in current window (${test?.note || 'sequential test'})`, 'info');
        if (autoWindow && !autoWindow.closed) autoWindow.focus();
    }
    
    // Start countdown if auto-advance is enabled
    if (isAutoAdvance) {
        autoCountdown = delay;
        updateAutoStatus(
            `üîÑ Test ${autoCurrentIndex + 1}/${autoTestQueue.length}: ${testId}`,
            `${test?.title || ''} - Next in ${autoCountdown}s`
        );
        
        autoTimer = setInterval(() => {
            autoCountdown--;
            if (autoCountdown <= 0) {
                clearInterval(autoTimer);
                autoTimer = null;
                addAutoLog(`${testId} auto-advanced`, 'success');
                autoCurrentIndex++;
                runNextTest();
            } else {
                updateAutoStatus(
                    `üîÑ Test ${autoCurrentIndex + 1}/${autoTestQueue.length}: ${testId}`,
                    `${test?.title || ''} - Next in ${autoCountdown}s`
                );
            }
        }, 1000);
    } else {
        updateAutoStatus(
            `üîÑ Test ${autoCurrentIndex + 1}/${autoTestQueue.length}: ${testId}`,
            `${test?.title || ''} - Click "Next Test" when done`
        );
    }
}

function nextTest() {
    if (!automationRunning) return toast('Start automation first');
    
    // Clear timer if running
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    const testId = autoTestQueue[autoCurrentIndex];
    addAutoLog(`${testId} marked as reviewed`, 'success');
    
    autoCurrentIndex++;
    runNextTest();
}

function skipTest() {
    if (!automationRunning) return toast('Start automation first');
    
    // Clear timer if running
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    const testId = autoTestQueue[autoCurrentIndex];
    addAutoLog(`${testId} skipped`, 'warn');
    
    autoCurrentIndex++;
    runNextTest();
}

function stopTests() {
    // Clear timer
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    automationRunning = false;
    autoTestQueue = [];
    autoCurrentIndex = 0;
    lastAutoUrl = '';
    updateAutoStatus('‚èπÔ∏è Stopped', 'Automation halted');
    addAutoLog('Automation stopped', 'error');
}

function resetAutomation() {
    // Clear timer
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    automationRunning = false;
    autoTestQueue = [];
    autoCurrentIndex = 0;
    lastAutoUrl = '';
    if (autoWindow && !autoWindow.closed) autoWindow.close();
    autoWindow = null;
    document.getElementById('automation-log').innerHTML = '<div class="info">[Ready] Automation runner reset</div>';
    updateAutoStatus('‚è∏Ô∏è Ready', 'Select tests and click Run');
    document.querySelectorAll('.auto-test').forEach(cb => cb.checked = false);
}

// ========== REPORTS ==========
function renderReports() {
    const tests = getAssignedTests();
    const results = testResults;
    
    // Calculate summary stats
    let pass = 0, fail = 0, skip = 0, pending = 0;
    tests.forEach(t => {
        const status = results[t.id]?.status;
        if (status === 'pass') pass++;
        else if (status === 'fail') fail++;
        else if (status === 'skip') skip++;
        else pending++;
    });
    
    // Update summary cards
    document.getElementById('rpt-total').textContent = tests.length;
    document.getElementById('rpt-pass').textContent = pass;
    document.getElementById('rpt-fail').textContent = fail;
    document.getElementById('rpt-skip').textContent = skip;
    document.getElementById('rpt-pending').textContent = pending;
    
    // Platform coverage
    renderPlatformCoverage(tests, results);
    
    // Section progress
    renderSectionProgress(tests, results);
    
    // Attention list
    renderAttentionList(tests, results);
    
    // Coverage matrix
    renderCoverageMatrix(tests, results);
}

function renderPlatformCoverage(tests, results) {
    const platforms = [
        { id: 'desktop-chrome', icon: 'üñ•Ô∏è', name: 'Chrome' },
        { id: 'desktop-safari', icon: 'üñ•Ô∏è', name: 'Safari' },
        { id: 'desktop-firefox', icon: 'üñ•Ô∏è', name: 'Firefox' },
        { id: 'iphone-safari', icon: 'üì±', name: 'iPhone Safari' },
        { id: 'iphone-pwa', icon: 'üì±', name: 'iPhone PWA' },
        { id: 'android-chrome', icon: 'ü§ñ', name: 'Android Chrome' },
        { id: 'android-pwa', icon: 'ü§ñ', name: 'Android PWA' },
        { id: 'ipad', icon: 'üì≤', name: 'iPad' }
    ];
    
    const platformStats = {};
    platforms.forEach(p => platformStats[p.id] = { pass: 0, fail: 0, total: 0 });
    
    tests.forEach(t => {
        const r = results[t.id];
        if (r?.platform && platformStats[r.platform]) {
            platformStats[r.platform].total++;
            if (r.status === 'pass') platformStats[r.platform].pass++;
            if (r.status === 'fail') platformStats[r.platform].fail++;
        }
    });
    
    const maxTests = Math.max(...Object.values(platformStats).map(s => s.total), 1);
    
    document.getElementById('platform-coverage').innerHTML = platforms.map(p => {
        const stats = platformStats[p.id];
        const pct = stats.total ? Math.round((stats.total / tests.length) * 100) : 0;
        const passPct = stats.total ? Math.round((stats.pass / stats.total) * 100) : 0;
        const barWidth = (stats.total / maxTests) * 100;
        
        let fillClass = 'pass';
        if (stats.fail > 0 && stats.pass > 0) fillClass = 'mixed';
        else if (stats.fail > 0) fillClass = 'fail';
        
        return `
            <div class="platform-row">
                <div class="platform-icon">${p.icon}</div>
                <div class="platform-name">${p.name}</div>
                <div class="platform-bar">
                    <div class="platform-fill ${fillClass}" style="width: ${barWidth}%; --pass-pct: ${passPct}%;">
                        ${stats.total > 0 ? stats.total : ''}
                    </div>
                </div>
                <div class="platform-stats">
                    ${stats.total > 0 ? `${stats.pass}‚úì ${stats.fail > 0 ? stats.fail + '‚úó' : ''}` : '<span style="color: var(--gray-400)">No tests</span>'}
                </div>
            </div>
        `;
    }).join('') + `
        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 0.8rem;">
            <strong>üìå Not yet tested on any platform:</strong> ${tests.filter(t => !results[t.id]?.platform).length} tests
        </div>
    `;
}

function renderSectionProgress(tests, results) {
    document.getElementById('section-progress').innerHTML = TEST_SECTIONS.map(section => {
        const sectionTests = section.tests.filter(t => tests.some(at => at.id === t.id));
        if (!sectionTests.length) return '';
        
        let pass = 0, fail = 0, skip = 0;
        sectionTests.forEach(t => {
            const status = results[t.id]?.status;
            if (status === 'pass') pass++;
            else if (status === 'fail') fail++;
            else if (status === 'skip') skip++;
        });
        
        const total = sectionTests.length;
        const passPct = (pass / total) * 100;
        const failPct = (fail / total) * 100;
        const skipPct = (skip / total) * 100;
        
        return `
            <div class="section-row">
                <div class="section-icon">${section.icon}</div>
                <div class="section-name">${section.name}</div>
                <div class="section-bar">
                    <div class="bar-segment pass" style="width: ${passPct}%"></div>
                    <div class="bar-segment fail" style="width: ${failPct}%"></div>
                    <div class="bar-segment skip" style="width: ${skipPct}%"></div>
                </div>
                <div class="section-stats">${pass + fail + skip}/${total}</div>
            </div>
        `;
    }).join('');
}

function renderAttentionList(tests, results) {
    const failedTests = tests.filter(t => results[t.id]?.status === 'fail');
    const noPlatformTests = tests.filter(t => results[t.id]?.status && !results[t.id]?.platform);
    
    let html = '';
    
    if (failedTests.length === 0 && noPlatformTests.length === 0) {
        html = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">‚úÖ All tests looking good!</p>';
    } else {
        if (failedTests.length > 0) {
            html += '<h4 style="font-size: 0.8rem; color: var(--danger); margin-bottom: 8px;">Failed Tests</h4>';
            html += failedTests.map(t => `
                <div class="attention-item">
                    <span class="attention-id">${t.id}</span>
                    <span class="attention-title">${t.title}</span>
                    <span class="attention-badge fail">FAIL</span>
                </div>
            `).join('');
        }
        
        if (noPlatformTests.length > 0) {
            html += '<h4 style="font-size: 0.8rem; color: var(--warning); margin: 16px 0 8px;">Missing Platform</h4>';
            html += noPlatformTests.slice(0, 10).map(t => `
                <div class="attention-item warning">
                    <span class="attention-id">${t.id}</span>
                    <span class="attention-title">${t.title}</span>
                    <span class="attention-badge no-platform">No Platform</span>
                </div>
            `).join('');
            if (noPlatformTests.length > 10) {
                html += `<p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 8px;">...and ${noPlatformTests.length - 10} more</p>`;
            }
        }
    }
    
    document.getElementById('attention-list').innerHTML = html;
}

function renderCoverageMatrix(tests, results) {
    const platforms = [
        { id: 'desktop-chrome', short: 'üñ•Ô∏è Chr' },
        { id: 'desktop-safari', short: 'üñ•Ô∏è Saf' },
        { id: 'desktop-firefox', short: 'üñ•Ô∏è FF' },
        { id: 'iphone-safari', short: 'üì± iOS' },
        { id: 'iphone-pwa', short: 'üì± PWA' },
        { id: 'android-chrome', short: 'ü§ñ And' },
        { id: 'android-pwa', short: 'ü§ñ PWA' },
        { id: 'ipad', short: 'üì≤ iPad' }
    ];
    
    let html = '<table class="matrix-table"><thead><tr><th>Section</th>';
    platforms.forEach(p => html += `<th>${p.short}</th>`);
    html += '</tr></thead><tbody>';
    
    TEST_SECTIONS.forEach(section => {
        const sectionTests = section.tests.filter(t => tests.some(at => at.id === t.id));
        if (!sectionTests.length) return;
        
        html += `<tr><td class="section-header-cell">${section.icon} ${section.name}</td>`;
        
        platforms.forEach(platform => {
            const platformTests = sectionTests.filter(t => results[t.id]?.platform === platform.id);
            const passCount = platformTests.filter(t => results[t.id]?.status === 'pass').length;
            const failCount = platformTests.filter(t => results[t.id]?.status === 'fail').length;
            const total = platformTests.length;
            
            let cellClass = 'none';
            let cellContent = '-';
            
            if (total > 0) {
                if (failCount > 0) {
                    cellClass = 'has-fail';
                    cellContent = `${passCount}/${total}`;
                } else if (total === sectionTests.length) {
                    cellClass = 'full';
                    cellContent = '‚úì';
                } else {
                    cellClass = 'partial';
                    cellContent = total;
                }
            }
            
            html += `<td class="matrix-cell ${cellClass}">${cellContent}</td>`;
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    // Add legend
    html += `
        <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.7rem; color: var(--gray-500);">
            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 2px;"></span> All pass</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #fef3c7; border-radius: 2px;"></span> Partial</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #fee2e2; border-radius: 2px;"></span> Has failures</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--gray-50); border-radius: 2px;"></span> Not tested</span>
        </div>
    `;
    
    document.getElementById('coverage-matrix').innerHTML = html;
}

// ========== SCRIPT GENERATION ==========
function generatePlaywright() {
    const tests = getAssignedTests();
    const script = `import { test, expect } from '@playwright/test';

const GAMESHELF_URL = '${GAMESHELF_URL}';

${tests.map(t => `
test('${t.id}: ${t.title}', async ({ page }) => {
    await page.goto(GAMESHELF_URL + '${t.launch || ''}');
    // Expected: ${t.expected}
    // TODO: Add assertions
    await page.waitForTimeout(2000);
});
`).join('')}`;
    
    downloadFile(script, 'gameshelf.spec.ts', 'text/typescript');
    toast('Playwright script downloaded');
}

function generateCypress() {
    const tests = getAssignedTests();
    const script = `describe('Game Shelf Tests', () => {
    const GAMESHELF_URL = '${GAMESHELF_URL}';
    
${tests.map(t => `
    it('${t.id}: ${t.title}', () => {
        cy.visit(GAMESHELF_URL + '${t.launch || ''}');
        // Expected: ${t.expected}
        // TODO: Add assertions
        cy.wait(2000);
    });
`).join('')}
});`;
    
    downloadFile(script, 'gameshelf.cy.js', 'text/javascript');
    toast('Cypress script downloaded');
}

function generatePuppeteer() {
    const tests = getAssignedTests();
    const script = `const puppeteer = require('puppeteer');

const GAMESHELF_URL = '${GAMESHELF_URL}';

(async () => {
    const browser = await puppeteer.launch({ headless: false });
    const page = await browser.newPage();
    
${tests.map(t => `
    // ${t.id}: ${t.title}
    // Expected: ${t.expected}
    console.log('Running ${t.id}...');
    await page.goto(GAMESHELF_URL + '${t.launch || ''}');
    await page.waitForTimeout(2000);
    // TODO: Add assertions
`).join('')}
    
    await browser.close();
})();`;
    
    downloadFile(script, 'gameshelf.puppeteer.js', 'text/javascript');
    toast('Puppeteer script downloaded');
}

// ========== EXPORT ==========
function exportJSON() {
    const data = {
        exportedAt: new Date().toISOString(),
        tester: { uid: currentUser.uid, name: currentUser.displayName, email: currentUser.email },
        assignment: userAssignment,
        device: navigator.userAgent,
        screen: `${innerWidth}x${innerHeight}`,
        summary: {
            total: getAssignedTests().length,
            pass: Object.values(testResults).filter(r => r.status === 'pass').length,
            fail: Object.values(testResults).filter(r => r.status === 'fail').length,
            skip: Object.values(testResults).filter(r => r.status === 'skip').length
        },
        platformCoverage: [...new Set(Object.values(testResults).map(r => r.platform).filter(Boolean))],
        failedTests: getAssignedTests().filter(t => testResults[t.id]?.status === 'fail').map(t => ({
            id: t.id, title: t.title, expected: t.expected,
            platform: testResults[t.id]?.platform,
            notes: testResults[t.id]?.notes,
            screenshots: testResults[t.id]?.screenshots?.length || 0
        })),
        results: testResults,
        consoleLogs: consoleLogs.slice(-200)
    };
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    toast('JSON copied! Paste to Claude');
}

function exportCSV() {
    const rows = [['ID', 'Title', 'Status', 'Platform', 'Notes', 'Screenshots']];
    getAssignedTests().forEach(t => {
        const r = testResults[t.id] || {};
        rows.push([t.id, `"${t.title}"`, r.status || 'pending', r.platform || '', `"${(r.notes || '').replace(/"/g, '""')}"`, (r.screenshots || []).length]);
    });
    downloadFile(rows.map(r => r.join(',')).join('\n'), 'test-results.csv', 'text/csv');
}

function exportMarkdown() {
    const tests = getAssignedTests();
    const pass = tests.filter(t => testResults[t.id]?.status === 'pass').length;
    const fail = tests.filter(t => testResults[t.id]?.status === 'fail').length;
    const platforms = [...new Set(Object.values(testResults).map(r => r.platform).filter(Boolean))];
    
    let md = `# Game Shelf Test Results\n\n`;
    md += `**Tester:** ${currentUser.displayName}\n`;
    md += `**Date:** ${new Date().toLocaleString()}\n`;
    md += `**Summary:** ${pass} pass, ${fail} fail of ${tests.length}\n`;
    md += `**Platforms Tested:** ${platforms.map(p => getPlatformIcon(p)).join(', ') || 'Not specified'}\n\n`;
    
    const failed = tests.filter(t => testResults[t.id]?.status === 'fail');
    if (failed.length) {
        md += `## Failed Tests\n\n`;
        failed.forEach(t => {
            const r = testResults[t.id];
            md += `### ${t.id}: ${t.title}\n`;
            md += `**Platform:** ${r.platform ? getPlatformIcon(r.platform) : 'Not specified'}\n`;
            md += `**Expected:** ${t.expected}\n`;
            md += `**Notes:** ${r.notes || 'None'}\n\n`;
        });
    }
    
    downloadFile(md, 'test-results.md', 'text/markdown');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

// ========== UTILS ==========
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 2000);
}

function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function getPlatformIcon(platform) {
    const icons = {
        'desktop-chrome': 'üñ•Ô∏è Chrome',
        'desktop-safari': 'üñ•Ô∏è Safari',
        'desktop-firefox': 'üñ•Ô∏è Firefox',
        'iphone-safari': 'üì± iOS',
        'iphone-pwa': 'üì± iOS PWA',
        'android-chrome': 'ü§ñ Android',
        'android-pwa': 'ü§ñ Android PWA',
        'ipad': 'üì≤ iPad'
    };
    return icons[platform] || platform;
}

function detectPlatform() {
    const ua = navigator.userAgent;
    const standalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    
    if (/iPad/.test(ua)) return 'ipad';
    if (/iPhone|iPod/.test(ua)) return standalone ? 'iphone-pwa' : 'iphone-safari';
    if (/Android/.test(ua)) return standalone ? 'android-pwa' : 'android-chrome';
    if (/Firefox/.test(ua)) return 'desktop-firefox';
    if (/Safari/.test(ua) && !/Chrome/.test(ua)) return 'desktop-safari';
    return 'desktop-chrome';
}

function autoDetectPlatform(id) {
    const platform = detectPlatform();
    setPlatform(id, platform);
    toast(`Detected: ${getPlatformIcon(platform)}`);
}

function changeGlobalPlatform(platform) {
    detectedPlatform = platform;
    updatePlatformUI();
    toast(`Platform set to ${getPlatformIcon(platform)}`);
}

function updatePlatformUI() {
    document.getElementById('current-platform').textContent = getPlatformIcon(detectedPlatform);
    const select = document.getElementById('platform-select');
    if (select) select.value = detectedPlatform;
}

// Init
detectedPlatform = detectPlatform();
console.log('üß™ Test Plan v3 loaded');
console.log('üì± Detected platform:', detectedPlatform, getPlatformIcon(detectedPlatform));
setInterval(updateMetrics, 1000);
</script>
<script src="playwright-runner.js"></script>
</body>
</html>
