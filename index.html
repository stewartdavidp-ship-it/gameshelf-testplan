<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XRL2SVN0YF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XRL2SVN0YF');
    </script>
    

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="version" content="4.0.1">
    <meta name="gs-app-id" content="testplan">
    <title>Game Shelf Test Plan v4</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß™</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-500: #6b7280; --gray-700: #374151; --gray-900: #111827;
            --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --bg-tertiary: #f9fafb;
            --text-primary: #111827; --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }
        
        [data-theme="dark"] {
            --gray-50: #1f2937; --gray-100: #111827; --gray-200: #374151;
            --gray-300: #4b5563; --gray-500: #9ca3af; --gray-700: #d1d5db; --gray-900: #f9fafb;
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af;
            --border-color: #374151;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-100); color: var(--gray-900); line-height: 1.5; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 20px; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .header-tabs { display: flex; gap: 4px; }
        .header-tab { background: rgba(255,255,255,0.15); border: none; color: white; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .header-tab.active { background: rgba(255,255,255,0.3); }
        .user-info { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; }
        .admin-badge { background: var(--warning); color: #000; padding: 2px 6px; border-radius: 8px; font-size: 0.65rem; font-weight: 600; }
        .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.7rem; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
        
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center; }
        .login-screen h2 { font-size: 1.4rem; margin-bottom: 8px; }
        .login-screen p { color: var(--gray-500); margin-bottom: 20px; }
        .google-btn { display: flex; align-items: center; gap: 10px; background: white; border: 1px solid var(--gray-300); padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .google-btn img { width: 18px; }
        
        .panel { background: white; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .panel h3 { font-size: 0.95rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .panel.admin { border: 2px solid var(--warning); }
        .panel.debug { border: 2px solid var(--primary); }
        
        .tabs { display: flex; gap: 6px; margin-bottom: 14px; border-bottom: 1px solid var(--gray-200); padding-bottom: 8px; flex-wrap: wrap; }
        .tab { padding: 6px 14px; background: none; border: none; font-size: 0.8rem; cursor: pointer; border-radius: 5px; color: var(--gray-500); }
        .tab.active { background: var(--gray-100); color: var(--gray-900); font-weight: 500; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.85rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        
        .test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 6px; max-height: 250px; overflow-y: auto; padding: 10px; background: var(--gray-50); border-radius: 6px; }
        .test-grid .section-header { grid-column: 1 / -1; font-weight: 600; font-size: 0.8rem; color: var(--gray-700); padding: 6px 0 2px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .test-checkbox { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; cursor: pointer; }
        .test-checkbox input { width: 14px; height: 14px; }
        .select-all-btn { font-size: 0.65rem; padding: 2px 6px; background: var(--gray-200); border: none; border-radius: 4px; cursor: pointer; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }
        
        .assignment-list { display: flex; flex-direction: column; gap: 8px; }
        .assignment-card { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--gray-50); border-radius: 6px; }
        .assignment-card h4 { font-size: 0.85rem; }
        .assignment-card p { font-size: 0.7rem; color: var(--gray-500); }
        .badge { background: var(--primary); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; }
        
        .progress-bar { height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .progress-legend { display: flex; gap: 12px; font-size: 0.7rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.pass { background: var(--success); }
        .legend-dot.fail { background: var(--danger); }
        .legend-dot.skip { background: var(--gray-300); }
        .legend-dot.pending { background: var(--gray-200); border: 1px solid var(--gray-300); }
        
        .section-tabs { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 6px; margin-bottom: 12px; }
        .section-tab { flex-shrink: 0; padding: 6px 12px; background: white; border: 1px solid var(--gray-200); border-radius: 16px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; }
        .section-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .section-tab .count { background: rgba(0,0,0,0.1); padding: 1px 5px; border-radius: 8px; font-size: 0.65rem; margin-left: 4px; }
        .section-tab.active .count { background: rgba(255,255,255,0.2); }
        
        .test-card { background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
        .test-card.status-pass { border-left: 3px solid var(--success); }
        .test-card.status-fail { border-left: 3px solid var(--danger); }
        .test-card.status-skip { border-left: 3px solid var(--gray-300); }
        .test-header { display: flex; align-items: center; padding: 12px; cursor: pointer; gap: 10px; }
        .test-id { background: var(--gray-100); color: var(--gray-500); font-size: 0.7rem; font-weight: 600; padding: 3px 6px; border-radius: 4px; }
        .test-title { flex: 1; font-size: 0.85rem; font-weight: 500; }
        .test-status { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .test-status.pending { background: var(--gray-200); }
        .test-status.pass { background: var(--success); color: white; }
        .test-status.fail { background: var(--danger); color: white; }
        .test-status.skip { background: var(--gray-300); color: white; }
        .test-chevron { color: var(--gray-400); transition: transform 0.2s; }
        .test-card.expanded .test-chevron { transform: rotate(180deg); }
        .test-body { display: none; padding: 0 12px 12px; border-top: 1px solid var(--gray-100); }
        .test-card.expanded .test-body { display: block; }
        
        .launch-row { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .launch-btn { flex: 1; min-width: 140px; padding: 10px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .launch-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(59,130,246,0.3); }
        .launch-btn.debug { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .launch-note { font-size: 0.7rem; color: var(--gray-500); text-align: center; margin-top: -4px; }
        
        .test-data { background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.7rem; white-space: pre-wrap; margin: 8px 0; cursor: pointer; }
        .test-data:hover { background: #2d2d2d; }
        
        .info-box { background: var(--gray-50); padding: 10px; border-radius: 6px; margin: 8px 0; font-size: 0.8rem; }
        .info-box h4 { font-size: 0.7rem; text-transform: uppercase; color: var(--gray-500); margin-bottom: 4px; }
        
        .action-buttons { display: flex; gap: 6px; margin: 12px 0; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .action-btn.pass { background: #dcfce7; color: #166534; }
        .action-btn.pass.selected { background: var(--success); color: white; }
        .action-btn.fail { background: #fee2e2; color: #991b1b; }
        .action-btn.fail.selected { background: var(--danger); color: white; }
        .action-btn.skip { background: var(--gray-100); color: var(--gray-600); }
        .action-btn.skip.selected { background: var(--gray-400); color: white; }
        
        .platform-section { margin: 12px 0; padding-top: 12px; border-top: 1px solid var(--gray-100); }
        .platform-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .platform-btn { padding: 6px 10px; background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
        .platform-btn:hover { background: var(--gray-200); }
        .platform-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .platform-badge { background: var(--gray-100); color: var(--gray-600); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; }
        
        /* Report styles */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .summary-card { padding: 16px; border-radius: 10px; text-align: center; }
        .summary-card.total { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); }
        .summary-card.pass { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }
        .summary-card.fail { background: linear-gradient(135deg, #fee2e2, #fecaca); }
        .summary-card.skip { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); }
        .summary-card.pending { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .summary-value { font-size: 2rem; font-weight: 700; }
        .summary-card.total .summary-value { color: var(--primary-dark); }
        .summary-card.pass .summary-value { color: #166534; }
        .summary-card.fail .summary-value { color: #991b1b; }
        .summary-card.skip .summary-value { color: #374151; }
        .summary-card.pending .summary-value { color: #92400e; }
        .summary-label { font-size: 0.75rem; text-transform: uppercase; color: var(--gray-600); margin-top: 4px; }
        
        .platform-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 8px; }
        .platform-row .platform-icon { font-size: 1.2rem; width: 40px; text-align: center; }
        .platform-row .platform-name { flex: 0 0 120px; font-weight: 500; font-size: 0.85rem; }
        .platform-row .platform-bar { flex: 1; height: 24px; background: var(--gray-200); border-radius: 12px; overflow: hidden; position: relative; }
        .platform-row .platform-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.7rem; font-weight: 600; color: white; min-width: fit-content; }
        .platform-row .platform-fill.pass { background: var(--success); }
        .platform-row .platform-fill.fail { background: var(--danger); }
        .platform-row .platform-fill.mixed { background: linear-gradient(90deg, var(--success) var(--pass-pct), var(--danger) var(--pass-pct)); }
        .platform-row .platform-stats { flex: 0 0 100px; text-align: right; font-size: 0.8rem; color: var(--gray-600); }
        
        .section-row { display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--gray-100); }
        .section-row:last-child { border-bottom: none; }
        .section-row .section-icon { font-size: 1.1rem; }
        .section-row .section-name { flex: 0 0 100px; font-weight: 500; font-size: 0.85rem; }
        .section-row .section-bar { flex: 1; height: 20px; background: var(--gray-100); border-radius: 10px; overflow: hidden; display: flex; }
        .section-row .bar-segment { height: 100%; }
        .section-row .bar-segment.pass { background: var(--success); }
        .section-row .bar-segment.fail { background: var(--danger); }
        .section-row .bar-segment.skip { background: var(--gray-400); }
        .section-row .section-stats { flex: 0 0 80px; text-align: right; font-size: 0.75rem; color: var(--gray-500); }
        
        .attention-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 6px; margin-bottom: 6px; border-left: 3px solid var(--danger); }
        .attention-item.warning { border-left-color: var(--warning); }
        .attention-item .attention-id { font-weight: 600; font-size: 0.8rem; color: var(--gray-500); }
        .attention-item .attention-title { flex: 1; font-size: 0.85rem; }
        .attention-item .attention-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; }
        .attention-item .attention-badge.fail { background: #fee2e2; color: #991b1b; }
        .attention-item .attention-badge.no-platform { background: #fef3c7; color: #92400e; }
        
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .matrix-table th, .matrix-table td { padding: 8px; text-align: center; border: 1px solid var(--gray-200); }
        .matrix-table th { background: var(--gray-100); font-weight: 600; }
        .matrix-table .section-header-cell { text-align: left; font-weight: 500; }
        .matrix-cell { width: 40px; height: 40px; }
        .matrix-cell.full { background: var(--success); color: white; }
        .matrix-cell.partial { background: #fef3c7; color: #92400e; }
        .matrix-cell.none { background: var(--gray-50); color: var(--gray-400); }
        .matrix-cell.has-fail { background: #fee2e2; color: #991b1b; }
        
        .notes-input { width: 100%; padding: 8px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem; min-height: 60px; resize: vertical; font-family: inherit; margin-top: 8px; }
        
        .screenshot-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .upload-btn { display: flex; align-items: center; gap: 4px; padding: 8px 12px; background: var(--gray-100); border: 1px dashed var(--gray-300); border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
        .upload-btn input { display: none; }
        .screenshot-thumb { width: 60px; height: 60px; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--gray-200); }
        .screenshot-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .screenshot-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 10px; }
        
        .console-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-100); }
        .console-toggle { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; cursor: pointer; }
        .console-toggle input { width: 16px; height: 16px; }
        .console-output { background: #1e1e1e; color: #d4d4d4; padding: 8px; border-radius: 6px; font-family: monospace; font-size: 0.65rem; max-height: 120px; overflow-y: auto; margin-top: 6px; }
        .console-output .error { color: #f87171; }
        .console-output .warn { color: #fbbf24; }
        
        /* Debug Config Panel */
        .debug-config { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .debug-option { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px; cursor: pointer; }
        .debug-option input { width: 18px; height: 18px; }
        .debug-option-info { flex: 1; }
        .debug-option-info strong { font-size: 0.8rem; display: block; }
        .debug-option-info span { font-size: 0.7rem; color: var(--gray-500); }
        
        /* Automation Panel */
        .automation-controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .automation-status { padding: 12px; background: var(--gray-50); border-radius: 6px; margin-bottom: 12px; }
        .automation-status .status-text { font-size: 0.85rem; font-weight: 500; }
        .automation-status .status-detail { font-size: 0.75rem; color: var(--gray-500); }
        .automation-log { background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.7rem; max-height: 200px; overflow-y: auto; }
        .automation-log .success { color: #4ade80; }
        .automation-log .error { color: #f87171; }
        .automation-log .warn { color: #fbbf24; }
        .automation-log .info { color: #60a5fa; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .metric-card { background: var(--gray-50); padding: 12px; border-radius: 6px; text-align: center; }
        .metric-card .value { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
        .metric-card .label { font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; }
        
        .export-section { margin-top: 16px; }
        .export-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .debug-fab { position: fixed; bottom: 16px; right: 16px; width: 48px; height: 48px; background: var(--gray-700); color: white; border: none; border-radius: 50%; font-size: 1.2rem; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3); z-index: 999; display: none; }
        .debug-fab.visible { display: flex; align-items: center; justify-content: center; }
        
        .debug-panel { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; color: #d4d4d4; max-height: 35vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s; z-index: 1000; }
        .debug-panel.visible { transform: translateY(0); }
        .debug-panel-header { display: flex; justify-content: space-between; padding: 8px 12px; background: #2d2d2d; position: sticky; top: 0; }
        .debug-panel-header h4 { font-size: 0.75rem; color: #9ca3af; }
        .debug-panel-content { padding: 10px; font-family: monospace; font-size: 0.65rem; }
        .debug-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        
        .toast { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--gray-900); color: white; padding: 10px 20px; border-radius: 6px; font-size: 0.8rem; opacity: 0; transition: all 0.3s; z-index: 1001; }
        .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .hidden { display: none !important; }
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .header-tabs { 
                display: flex; 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch;
                padding-bottom: 4px;
                margin: 8px -10px 0 -10px;
                padding: 0 10px 8px 10px;
            }
            .header-tab { 
                flex-shrink: 0; 
                font-size: 0.7rem; 
                padding: 5px 10px;
            }
        }
        
        /* Dark Mode Toggle */
        .theme-toggle { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 4px; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); }
        
        /* Variant Testing Styles */
        .variant-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; margin-left: 8px; }
        .variants-section { margin-top: 16px; border: 1px solid var(--gray-200); border-radius: 8px; overflow: hidden; }
        .variants-header { background: var(--gray-50); padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; font-size: 0.85rem; }
        .variants-header:hover { background: var(--gray-100); }
        .variants-chevron { transition: transform 0.2s; }
        .variants-body { display: none; padding: 10px; }
        .variants-body.expanded { display: block; }
        .variant-row { display: grid; grid-template-columns: auto 1fr auto auto; gap: 8px; align-items: center; padding: 8px 10px; border-radius: 6px; margin-bottom: 6px; background: var(--gray-50); }
        .variant-row.status-pass { background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--success); }
        .variant-row.status-fail { background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); }
        .variant-row.status-skip { background: rgba(156, 163, 175, 0.1); border-left: 3px solid var(--gray-300); }
        .variant-info { display: flex; align-items: center; gap: 6px; min-width: 200px; }
        .variant-type { font-size: 0.9rem; }
        .variant-name { font-size: 0.8rem; font-weight: 500; }
        .variant-expected { font-size: 0.75rem; color: var(--gray-500); }
        .variant-data { font-family: monospace; font-size: 0.7rem; background: var(--gray-100); padding: 4px 8px; border-radius: 4px; cursor: pointer; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .variant-actions { display: flex; gap: 4px; }
        .variant-btn { width: 28px; height: 28px; border: 1px solid var(--gray-200); border-radius: 4px; cursor: pointer; font-size: 0.75rem; background: white; }
        .variant-btn:hover { background: var(--gray-100); }
        .variant-btn.pass.selected { background: var(--success); color: white; border-color: var(--success); }
        .variant-btn.fail.selected { background: var(--danger); color: white; border-color: var(--danger); }
        .variant-btn.skip.selected { background: var(--gray-400); color: white; border-color: var(--gray-400); }
        .variant-actions-row { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-200); }
        
        /* Dark Mode Variant Overrides */
        [data-theme="dark"] .variants-section { border-color: var(--border-color); }
        [data-theme="dark"] .variants-header { background: var(--bg-tertiary); }
        [data-theme="dark"] .variants-header:hover { background: var(--bg-secondary); }
        [data-theme="dark"] .variant-row { background: var(--bg-tertiary); }
        [data-theme="dark"] .variant-row.status-pass { background: rgba(34, 197, 94, 0.15); }
        [data-theme="dark"] .variant-row.status-fail { background: rgba(239, 68, 68, 0.15); }
        [data-theme="dark"] .variant-expected { color: var(--text-secondary); }
        [data-theme="dark"] .variant-data { background: var(--bg-secondary); color: var(--text-primary); }
        [data-theme="dark"] .variant-btn { background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .variant-btn:hover { background: var(--bg-tertiary); }
        [data-theme="dark"] .variant-actions-row { border-color: var(--border-color); }
        
        /* Dark Mode Overrides */
        [data-theme="dark"] body { background: var(--bg-primary); color: var(--text-primary); }
        [data-theme="dark"] .panel { background: var(--bg-secondary); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        [data-theme="dark"] .login-screen p { color: var(--text-secondary); }
        [data-theme="dark"] .google-btn { background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group select,
        [data-theme="dark"] .form-group textarea,
        [data-theme="dark"] .notes-input { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .tab { color: var(--text-secondary); }
        [data-theme="dark"] .tab.active { background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] .tabs { border-color: var(--border-color); }
        [data-theme="dark"] .test-grid { background: var(--bg-tertiary); }
        [data-theme="dark"] .test-grid .section-header { color: var(--text-primary); border-color: var(--border-color); }
        [data-theme="dark"] .select-all-btn { background: var(--bg-secondary); color: var(--text-primary); }
        [data-theme="dark"] .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] .assignment-card { background: var(--bg-tertiary); }
        [data-theme="dark"] .assignment-card p { color: var(--text-secondary); }
        [data-theme="dark"] .progress-bar { background: var(--bg-tertiary); }
        [data-theme="dark"] .test-card { background: var(--bg-secondary); }
        [data-theme="dark"] .test-card-header { background: var(--bg-tertiary); }
        [data-theme="dark"] .test-meta span { color: var(--text-secondary); }
        [data-theme="dark"] .test-detail p { color: var(--text-secondary); }
        [data-theme="dark"] .test-detail pre { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .status-btn { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        [data-theme="dark"] .debug-option { background: var(--bg-tertiary); }
        [data-theme="dark"] .debug-option-info span { color: var(--text-secondary); }
        [data-theme="dark"] .automation-status { background: var(--bg-tertiary); }
        [data-theme="dark"] .automation-status .status-detail { color: var(--text-secondary); }
        [data-theme="dark"] .metric-card { background: var(--bg-tertiary); }
        [data-theme="dark"] .metric-card .label { color: var(--text-secondary); }
        [data-theme="dark"] .upload-btn { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .screenshot-thumb { border-color: var(--border-color); }
        [data-theme="dark"] .console-section { border-color: var(--border-color); }
        [data-theme="dark"] .matrix-cell.none { background: var(--bg-tertiary); }
        [data-theme="dark"] .toast { background: var(--bg-secondary); }
        [data-theme="dark"] .search-input { background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .filter-btn { background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] .filter-btn.active { background: var(--primary); color: white; }
        
        /* Issue Reporting Styles */
        .screenshot-upload { margin-top: 8px; }
        .screenshot-preview { 
            border: 2px dashed var(--gray-300); 
            border-radius: 8px; 
            min-height: 150px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
        }
        .screenshot-preview:hover { border-color: var(--primary); background: var(--gray-50); }
        .screenshot-preview.has-image { border-style: solid; border-color: var(--success); }
        .screenshot-preview img { max-width: 100%; max-height: 300px; object-fit: contain; }
        .screenshot-placeholder { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            color: var(--gray-400); 
            font-size: 0.85rem;
        }
        .screenshot-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .issue-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid var(--gray-300);
        }
        .issue-card.severity-critical { border-left-color: #dc2626; }
        .issue-card.severity-major { border-left-color: #ea580c; }
        .issue-card.severity-minor { border-left-color: #ca8a04; }
        .issue-card.severity-cosmetic { border-left-color: #16a34a; }
        .issue-card.severity-suggestion { border-left-color: #6366f1; }
        
        .issue-card.status-fixed { opacity: 0.7; }
        .issue-card.status-wont-fix { opacity: 0.5; }
        
        .issue-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
        .issue-title { font-weight: 600; font-size: 0.9rem; flex: 1; }
        .issue-badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .issue-badge { 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.65rem; 
            font-weight: 500;
            white-space: nowrap;
        }
        .issue-badge.severity { background: var(--gray-200); color: var(--gray-700); }
        .issue-badge.section { background: var(--primary); color: white; }
        .issue-badge.status-open { background: #dbeafe; color: #1e40af; }
        .issue-badge.status-in-progress { background: #fef3c7; color: #92400e; }
        .issue-badge.status-fixed { background: #dcfce7; color: #166534; }
        .issue-badge.status-wont-fix { background: var(--gray-300); color: var(--gray-700); }
        
        .issue-description { font-size: 0.8rem; color: var(--gray-600); margin-bottom: 10px; line-height: 1.5; }
        .issue-meta { display: flex; gap: 12px; font-size: 0.7rem; color: var(--gray-500); flex-wrap: wrap; align-items: center; }
        .issue-screenshot-thumb { 
            width: 60px; 
            height: 60px; 
            object-fit: cover; 
            border-radius: 4px; 
            border: 1px solid var(--gray-200);
            cursor: pointer;
        }
        .issue-actions { display: flex; gap: 6px; margin-top: 10px; }
        
        /* Dark mode overrides for issues */
        [data-theme="dark"] .issue-card { background: var(--bg-tertiary); }
        [data-theme="dark"] .issue-description { color: var(--text-secondary); }
        [data-theme="dark"] .issue-meta { color: var(--text-secondary); }
        [data-theme="dark"] .screenshot-preview { border-color: var(--border-color); }
        [data-theme="dark"] .screenshot-preview:hover { background: var(--bg-tertiary); }
        [data-theme="dark"] .screenshot-placeholder { color: var(--text-secondary); }
        [data-theme="dark"] .issue-badge.severity { background: var(--bg-secondary); color: var(--text-secondary); }
        
        /* Issue image modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .image-modal.visible { display: flex; }
        .image-modal img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üß™ Game Shelf Test Plan</h1>
            <div class="header-tabs" id="header-tabs"></div>
            <div class="user-info" id="user-info"></div>
        </div>
    </header>
    
    <div id="login-screen" class="login-screen">
        <h2>üéÆ Game Shelf Tester Portal</h2>
        <p>Sign in to access your assigned tests</p>
        <button class="google-btn" onclick="signIn()">
            <img src="https://www.google.com/favicon.ico" alt="">Sign in with Google
        </button>
        <button class="theme-toggle" onclick="toggleDarkMode()" style="margin-top: 20px; background: var(--gray-200); color: var(--gray-700);">
            <span id="login-theme-icon">üåô</span> Toggle Dark Mode
        </button>
        <script>
            // Update login screen theme icon (dark mode is default)
            document.getElementById('login-theme-icon').textContent = 
                document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        </script>
    </div>
    
    <main id="main-content" class="container hidden">
        <!-- TESTING TAB -->
        <div id="tab-testing">
            <div id="assignment-banner" class="panel hidden" style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); border: 1px solid #93c5fd;">
                <h3 style="color: var(--primary-dark);">üìã Your Assignment</h3>
                <p id="assignment-desc" style="font-size: 0.85rem;"></p>
            </div>
            
            <div class="panel" id="progress-panel">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Progress</h3>
                    <span id="progress-text" style="font-size: 0.8rem; color: var(--gray-500);">0/0</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <div class="progress-legend">
                    <span class="legend-item"><span class="legend-dot pass"></span> Pass <span id="cnt-pass">0</span></span>
                    <span class="legend-item"><span class="legend-dot fail"></span> Fail <span id="cnt-fail">0</span></span>
                    <span class="legend-item"><span class="legend-dot skip"></span> Skip <span id="cnt-skip">0</span></span>
                    <span class="legend-item"><span class="legend-dot pending"></span> Pending <span id="cnt-pending">0</span></span>
                </div>
            </div>
            
            <div class="panel" id="platform-panel" style="padding: 12px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase;">Testing on:</span>
                    <span id="current-platform" style="font-size: 0.85rem; font-weight: 500;"></span>
                </div>
                <select id="platform-select" onchange="changeGlobalPlatform(this.value)" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                    <option value="desktop-chrome">üñ•Ô∏è Chrome</option>
                    <option value="desktop-safari">üñ•Ô∏è Safari</option>
                    <option value="desktop-firefox">üñ•Ô∏è Firefox</option>
                    <option value="iphone-safari">üì± iPhone Safari</option>
                    <option value="iphone-pwa">üì± iPhone PWA</option>
                    <option value="android-chrome">ü§ñ Android Chrome</option>
                    <option value="android-pwa">ü§ñ Android PWA</option>
                    <option value="ipad">üì≤ iPad</option>
                </select>
            </div>
            
            <div class="section-tabs" id="section-tabs"></div>
            <div id="test-cards"></div>
            
            <div id="no-tests" class="panel hidden" style="text-align: center; padding: 40px;">
                <h3>üéØ No Tests Assigned</h3>
                <p style="color: var(--gray-500);">An admin will assign tests to you.</p>
            </div>
            
            <div class="export-section">
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportJSON()">üìã Copy JSON for Claude</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">üìä Download CSV</button>
                    <button class="btn btn-secondary" onclick="exportMarkdown()">üìù Markdown Report</button>
                </div>
            </div>
        </div>
        
        <!-- ADMIN TAB -->
        <div id="tab-admin" class="hidden">
            <div class="panel admin">
                <h3>üëë Admin Panel</h3>
                <div class="tabs">
                    <button class="tab active" onclick="switchAdminTab('assign')">Assign Tests</button>
                    <button class="tab" onclick="switchAdminTab('view')">Assignments</button>
                    <button class="tab" onclick="switchAdminTab('results')">All Results</button>
                </div>
                
                <div id="admin-assign">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tester Email</label>
                            <input type="email" id="assign-email" placeholder="tester@example.com">
                        </div>
                        <div class="form-group">
                            <label>Focus Area</label>
                            <input type="text" id="assign-focus" placeholder="e.g., Onboarding Expert">
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Select Tests</label>
                        <div class="test-grid" id="test-grid"></div>
                    </div>
                    <button class="btn btn-primary" onclick="createAssignment()">‚úÖ Create Assignment</button>
                </div>
                
                <div id="admin-view" class="assignment-list hidden"></div>
                <div id="admin-results" class="hidden"></div>
            </div>
        </div>
        
        <!-- DEBUG TAB -->
        <div id="tab-debug" class="hidden">
            <div class="panel debug">
                <h3>üîß Debug Configuration</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Configure debug options before launching Game Shelf. These settings enable additional logging and metrics collection.</p>
                
                <div class="debug-config">
                    <label class="debug-option">
                        <input type="checkbox" id="debug-console" checked>
                        <div class="debug-option-info">
                            <strong>Console Capture</strong>
                            <span>Log all console output</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-network">
                        <div class="debug-option-info">
                            <strong>Network Logging</strong>
                            <span>Track API requests</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-performance">
                        <div class="debug-option-info">
                            <strong>Performance Metrics</strong>
                            <span>FPS, load times, memory</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-storage">
                        <div class="debug-option-info">
                            <strong>Storage Monitor</strong>
                            <span>Track localStorage changes</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-events">
                        <div class="debug-option-info">
                            <strong>Event Tracking</strong>
                            <span>User interactions</span>
                        </div>
                    </label>
                    <label class="debug-option">
                        <input type="checkbox" id="debug-errors" checked>
                        <div class="debug-option-info">
                            <strong>Error Capture</strong>
                            <span>Unhandled exceptions</span>
                        </div>
                    </label>
                </div>
                
                <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="launchWithDebug()">üöÄ Launch Game Shelf with Debug</button>
                    <button class="btn btn-secondary" onclick="copyDebugBookmarklet()">üìé Copy Debug Bookmarklet</button>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìä Collected Metrics</h3>
                <div class="metrics-grid" id="metrics-grid">
                    <div class="metric-card"><div class="value" id="metric-errors">0</div><div class="label">Errors</div></div>
                    <div class="metric-card"><div class="value" id="metric-warnings">0</div><div class="label">Warnings</div></div>
                    <div class="metric-card"><div class="value" id="metric-logs">0</div><div class="label">Log Entries</div></div>
                    <div class="metric-card"><div class="value" id="metric-duration">0s</div><div class="label">Session</div></div>
                </div>
                <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="clearMetrics()">Clear Metrics</button>
            </div>
        </div>
        
        <!-- AUTOMATION TAB -->
        <div id="tab-automation" class="hidden">
            <div class="panel">
                <h3>ü§ñ Automation Runner</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Run through tests automatically or step through manually.</p>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="auto-advance" checked style="width: 18px; height: 18px;">
                        <span style="font-size: 0.85rem; font-weight: 500;">Auto-advance</span>
                    </label>
                    <select id="auto-delay" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                        <option value="3">3 seconds</option>
                        <option value="5" selected>5 seconds</option>
                        <option value="10">10 seconds</option>
                        <option value="15">15 seconds</option>
                        <option value="30">30 seconds</option>
                    </select>
                    <span style="font-size: 0.75rem; color: var(--gray-500);">Time per test</span>
                </div>
                
                <div class="automation-controls">
                    <button class="btn btn-success" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
                    <button class="btn btn-primary" onclick="runSelectedTests()">‚ñ∂Ô∏è Run Selected</button>
                    <button class="btn btn-success" onclick="nextTest()">‚è≠Ô∏è Next Test</button>
                    <button class="btn btn-secondary" onclick="skipTest()">‚è© Skip</button>
                    <button class="btn btn-danger" onclick="stopTests()">‚èπÔ∏è Stop</button>
                    <button class="btn btn-secondary" onclick="resetAutomation()">üîÑ Reset</button>
                </div>
                
                <div class="automation-status" id="automation-status">
                    <div class="status-text">‚è∏Ô∏è Ready to run</div>
                    <div class="status-detail">Select tests and click Run</div>
                </div>
                
                <div class="form-group">
                    <label>Test Sequence</label>
                    <div class="test-grid" id="automation-tests"></div>
                </div>
                
                <div style="margin-top: 12px;">
                    <label style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500);">EXECUTION LOG</label>
                    <div class="automation-log" id="automation-log">
                        <div class="info">[Ready] Automation runner initialized</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìã Test Scripts</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Generate test scripts for external automation tools.</p>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="generatePlaywright()">üé≠ Playwright Script</button>
                    <button class="btn btn-secondary" onclick="generateCypress()">üå≤ Cypress Script</button>
                    <button class="btn btn-secondary" onclick="generatePuppeteer()">üé™ Puppeteer Script</button>
                </div>
            </div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="tab-reports" class="hidden">
            <div class="panel">
                <h3>üìä Test Coverage Dashboard</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 16px;">Visual overview of testing progress across platforms.</p>
                
                <div class="report-summary" id="report-summary">
                    <div class="summary-cards">
                        <div class="summary-card total"><div class="summary-value" id="rpt-total">0</div><div class="summary-label">Total Tests</div></div>
                        <div class="summary-card pass"><div class="summary-value" id="rpt-pass">0</div><div class="summary-label">Passed</div></div>
                        <div class="summary-card fail"><div class="summary-value" id="rpt-fail">0</div><div class="summary-label">Failed</div></div>
                        <div class="summary-card skip"><div class="summary-value" id="rpt-skip">0</div><div class="summary-label">Skipped</div></div>
                        <div class="summary-card pending"><div class="summary-value" id="rpt-pending">0</div><div class="summary-label">Remaining</div></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üì± Platform Coverage</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Tests completed on each platform.</p>
                <div id="platform-coverage"></div>
            </div>
            
            <div class="panel">
                <h3>üìã Section Progress</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Completion status by test section.</p>
                <div id="section-progress"></div>
            </div>
            
            <div class="panel">
                <h3>üî¥ Tests Needing Attention</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Failed tests and tests without platform assignment.</p>
                <div id="attention-list"></div>
            </div>
            
            <div class="panel">
                <h3>üìà Platform √ó Section Matrix</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Coverage heatmap showing which sections have been tested on which platforms.</p>
                <div id="coverage-matrix" style="overflow-x: auto;"></div>
            </div>
        </div>
        
        <!-- ISSUE REPORTING TAB -->
        <div id="tab-issues" class="hidden">
            <div class="panel">
                <h3>üêõ Report an Issue</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 16px;">Found a bug or problem? Report it here. Screenshots help!</p>
                
                <form id="issue-form" onsubmit="submitIssue(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>App Section *</label>
                            <select id="issue-section" required>
                                <option value="">Select section...</option>
                                <option value="home">üè† Home</option>
                                <option value="games">üéÆ Games / Shelf</option>
                                <option value="social">üë• Social / Friends</option>
                                <option value="battles">‚öîÔ∏è Battles</option>
                                <option value="share">üì§ Share</option>
                                <option value="log">üìã Log Sheet</option>
                                <option value="settings">‚öôÔ∏è Settings / Menu</option>
                                <option value="onboarding">üéØ Setup / Onboarding</option>
                                <option value="auth">üîê Login / Account</option>
                                <option value="achievements">üèÜ Achievements</option>
                                <option value="rewards">üéÅ Rewards Shop</option>
                                <option value="notifications">üîî Notifications</option>
                                <option value="other">üì± Other / General</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Severity *</label>
                            <select id="issue-severity" required>
                                <option value="">Select severity...</option>
                                <option value="critical">üî¥ Critical - App crash / data loss</option>
                                <option value="major">üü† Major - Feature broken</option>
                                <option value="minor">üü° Minor - Works but annoying</option>
                                <option value="cosmetic">üü¢ Cosmetic - Visual glitch</option>
                                <option value="suggestion">üí° Suggestion / Enhancement</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Device / Platform</label>
                            <select id="issue-platform">
                                <option value="iphone">üì± iPhone</option>
                                <option value="ipad">üì± iPad</option>
                                <option value="android">ü§ñ Android Phone</option>
                                <option value="android-tablet">ü§ñ Android Tablet</option>
                                <option value="mac">üíª Mac (Safari)</option>
                                <option value="mac-chrome">üíª Mac (Chrome)</option>
                                <option value="windows">üñ•Ô∏è Windows</option>
                                <option value="other">‚ùì Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Browser (if applicable)</label>
                            <input type="text" id="issue-browser" placeholder="e.g., Safari 17, Chrome 120">
                        </div>
                    </div>
                    
                    <div class="form-group full">
                        <label>Issue Title *</label>
                        <input type="text" id="issue-title" placeholder="Brief description of the issue" required maxlength="100">
                    </div>
                    
                    <div class="form-group full">
                        <label>Detailed Description *</label>
                        <textarea id="issue-description" rows="4" placeholder="What happened? What did you expect to happen?" required></textarea>
                    </div>
                    
                    <div class="form-group full">
                        <label>Steps to Reproduce (optional)</label>
                        <textarea id="issue-steps" rows="3" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error..."></textarea>
                    </div>
                    
                    <div class="form-group full">
                        <label>Screenshot</label>
                        <div class="screenshot-upload" id="screenshot-upload">
                            <input type="file" id="issue-screenshot" accept="image/*" onchange="handleScreenshotSelect(event)" style="display: none;">
                            <div class="screenshot-preview" id="screenshot-preview" onclick="document.getElementById('issue-screenshot').click()">
                                <div class="screenshot-placeholder">
                                    <span style="font-size: 2rem;">üì∑</span>
                                    <span>Click to add screenshot</span>
                                    <span style="font-size: 0.7rem; color: var(--gray-400);">or paste from clipboard</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button type="submit" class="btn btn-primary" id="submit-issue-btn">
                            üêõ Submit Issue
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearIssueForm()">
                            Clear Form
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="panel">
                <h3>üìã Recent Issues</h3>
                <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">Issues reported by all testers.</p>
                
                <details style="font-size: 0.75rem; color: var(--gray-400); margin-bottom: 12px; background: var(--card-bg); padding: 8px; border-radius: 6px; border: 1px solid var(--gray-200);">
                    <summary style="cursor: pointer;">‚öôÔ∏è Firebase Setup Required</summary>
                    <div style="margin-top: 8px;">
                        <p>Add these rules to Firebase Realtime Database:</p>
                        <pre style="background: #1a1a2e; color: #00ff00; padding: 8px; border-radius: 4px; font-size: 0.7rem; overflow-x: auto;">
"reported-issues": {
  ".read": "auth != null",
  ".write": "auth != null"
}</pre>
                    </div>
                </details>
                
                <div class="issue-filters" style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <select id="filter-type" onchange="filterIssues()" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                        <option value="all">All Types</option>
                        <option value="bug">üêõ Bug</option>
                        <option value="enhancement">‚ú® Enhancement</option>
                        <option value="feature">üí° Feature</option>
                        <option value="question">‚ùì Question</option>
                    </select>
                    <select id="filter-status" onchange="filterIssues()" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                        <option value="all">All Status</option>
                        <option value="open">üîµ Open</option>
                        <option value="triaged">üìã Triaged</option>
                        <option value="in-progress">üü° In Progress</option>
                        <option value="in-review">üîç In Review</option>
                        <option value="resolved">üü¢ Resolved</option>
                        <option value="closed">‚ö´ Closed</option>
                        <option value="wont-fix">üö´ Won't Fix</option>
                        <option value="duplicate">üìé Duplicate</option>
                    </select>
                    <select id="filter-priority" onchange="filterIssues()" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                        <option value="all">All Priority</option>
                        <option value="p0">üî¥ P0 - Critical</option>
                        <option value="p1">üü† P1 - High</option>
                        <option value="p2">üü° P2 - Medium</option>
                        <option value="p3">üü¢ P3 - Low</option>
                        <option value="p4">‚ö™ P4 - Backlog</option>
                        <option value="none">‚ùì Unassigned</option>
                    </select>
                    <select id="filter-severity" onchange="filterIssues()" style="padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8rem;">
                        <option value="all">All Severity</option>
                        <option value="critical">üî¥ Critical</option>
                        <option value="major">üü† Major</option>
                        <option value="minor">üü° Minor</option>
                        <option value="cosmetic">üü¢ Cosmetic</option>
                        <option value="suggestion">üí° Suggestion</option>
                    </select>
                    <button class="btn btn-sm btn-secondary" onclick="loadIssues()">üîÑ Refresh</button>
                </div>
                
                <div id="issues-list">
                    <div style="text-align: center; padding: 20px; color: var(--gray-500);">Loading issues...</div>
                </div>
            </div>
        </div>
    </main>
    
    <button class="debug-fab" id="debug-fab" onclick="toggleDebugPanel()">üêõ</button>
    
    <div class="debug-panel" id="debug-panel">
        <div class="debug-panel-header">
            <h4>Console Output (<span id="log-count">0</span>)</h4>
            <div>
                <button onclick="clearLogs()" style="background:none;border:none;color:#9ca3af;cursor:pointer;margin-right:8px;">Clear</button>
                <button onclick="toggleDebugPanel()" style="background:none;border:none;color:#9ca3af;cursor:pointer;">Close</button>
            </div>
        </div>
        <div class="debug-panel-content" id="debug-content"></div>
    </div>
    
    <div class="toast" id="toast"></div>

<script>
// ========== CONFIG ==========
const firebaseConfig = {
    apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
    authDomain: "word-boxing.firebaseapp.com",
    databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
    projectId: "word-boxing"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const GAMESHELF_URL = 'https://stewartdavidp-ship-it.github.io/gameshelftest/';
const ADMIN_EMAILS = ['stewartdavidp@gmail.com'];


// ========== TEST DATA ==========
// Lean Test Suite - 60 tests designed to find REAL BUGS
const TEST_SECTIONS = [
    // ========== E: PARSER EDGE CASES (E1-E20) ==========
    { id: 'parser-edge', name: 'Parser Edge Cases', icon: 'üéØ', tests: [
        { id: 'E1', title: 'Wordle with comma in puzzle number', expected: 'Parsed correctly', steps: 'Paste: Wordle 1,234 3/6', launch: '#log', note: 'Lean Test' },
        { id: 'E2', title: 'Wordle with period in puzzle number (EU)', expected: 'Handled gracefully', steps: 'Paste: Wordle 1.234 3/6', launch: '#log', note: 'Lean Test' },
        { id: 'E3', title: 'Wordle X/6 loss detection', expected: 'Loss detected', steps: 'Paste: Wordle X/6 result', launch: '#log', note: 'Lean Test' },
        { id: 'E4', title: 'Wordle lowercase input', expected: 'Case insensitive', steps: 'Paste: wordle 100 4/6', launch: '#log', note: 'Lean Test' },
        { id: 'E5', title: 'Wordle with extra whitespace', expected: 'Trimmed & parsed', steps: 'Paste with leading/trailing spaces', launch: '#log', note: 'Lean Test' },
        { id: 'E6', title: 'Wordle 1/6 ace detection', expected: 'Ace detected', steps: 'Paste: Wordle 1/6', launch: '#log', note: 'Lean Test' },
        { id: 'E7', title: 'Connections standard format', expected: 'Parsed', steps: 'Paste standard Connections', launch: '#log', note: 'Lean Test' },
        { id: 'E8', title: 'Connections with mistakes', expected: 'Mistakes counted', steps: 'Paste Connections with errors', launch: '#log', note: 'Lean Test' },
        { id: 'E9', title: 'Connections without puzzle number', expected: 'Still parsed', steps: 'Paste without #number', launch: '#log', note: 'Lean Test' },
        { id: 'E10', title: 'Mini Crossword under 1 minute', expected: 'Time parsed', steps: 'Paste 0:45 result', launch: '#log', note: 'Lean Test' },
        { id: 'E11', title: 'Mini Crossword over 1 minute', expected: 'Time parsed', steps: 'Paste 1:23 result', launch: '#log', note: 'Lean Test' },
        { id: 'E12', title: 'Mini Crossword over 10 minutes', expected: 'Time parsed', steps: 'Paste 12:05 result', launch: '#log', note: 'Lean Test' },
        { id: 'E13', title: 'Strands with hints used', expected: 'Hints counted', steps: 'Paste with üí°', launch: '#log', note: 'Lean Test' },
        { id: 'E14', title: 'Strands perfect game no hints', expected: 'Perfect detected', steps: 'Paste without hints', launch: '#log', note: 'Lean Test' },
        { id: 'E15', title: 'Empty input returns no detection', expected: 'No false positive', steps: 'Submit empty', launch: '#log', note: 'Lean Test' },
        { id: 'E16', title: 'Random text not detected as game', expected: 'No false positive', steps: 'Paste random text', launch: '#log', note: 'Lean Test' },
        { id: 'E17', title: 'Partial Wordle not detected', expected: 'No partial match', steps: 'Paste: Wordle only', launch: '#log', note: 'Lean Test' },
        { id: 'E18', title: 'Future puzzle number handled', expected: 'Accepted or rejected gracefully', steps: 'Paste: Wordle 99999', launch: '#log', note: 'Lean Test' },
        { id: 'E19', title: 'Unicode emoji variants handled', expected: 'All emoji parsed', steps: 'Paste various emoji', launch: '#log', note: 'Lean Test' },
        { id: 'E20', title: 'Multiple games in one paste', expected: 'First or all detected', steps: 'Paste 2 games', launch: '#log', note: 'Lean Test' }
    ]},
    
    // ========== K: DATA CORRUPTION (K1-K10) ==========
    { id: 'data-corruption', name: 'Data Corruption', icon: 'üíæ', tests: [
        { id: 'K1', title: 'Corrupted localStorage handled', expected: 'App loads with defaults', steps: 'Set invalid JSON in localStorage', launch: '', note: 'Lean Test' },
        { id: 'K2', title: 'Missing required fields handled', expected: 'Defaults applied', steps: 'Remove games array from data', launch: '', note: 'Lean Test' },
        { id: 'K3', title: 'Null values in history handled', expected: 'No crash', steps: 'Set history[date]=null', launch: '', note: 'Lean Test' },
        { id: 'K4', title: 'Future dates in history handled', expected: 'Displayed or filtered', steps: 'Add future date entry', launch: '', note: 'Lean Test' },
        { id: 'K5', title: 'Negative token balance handled', expected: 'Reset or shown correctly', steps: 'Set tokens=-100', launch: '', note: 'Lean Test' },
        { id: 'K6', title: 'Invalid game ID in games array', expected: 'Filtered out', steps: 'Add fake_game to array', launch: '', note: 'Lean Test' },
        { id: 'K7', title: 'Extremely long username handled', expected: 'Truncated in UI', steps: 'Set 1000 char name', launch: '', note: 'Lean Test' },
        { id: 'K8', title: 'Special chars in username handled', expected: 'Escaped or rejected', steps: 'XSS attempt in name', launch: '', note: 'Lean Test' },
        { id: 'K9', title: 'Duplicate dates in history handled', expected: 'Latest wins or merged', steps: 'Add duplicate date entries', launch: '', note: 'Lean Test' },
        { id: 'K10', title: 'Version mismatch in data handled', expected: 'Migrated correctly', steps: 'Load old version data', launch: '', note: 'Lean Test' }
    ]},
    
    // ========== L: BOUNDARY CONDITIONS (L1-L10) ==========
    { id: 'boundaries', name: 'Boundary Conditions', icon: 'üìè', tests: [
        { id: 'L1', title: 'Zero games selected state', expected: 'Handled gracefully', steps: 'Remove all games from selection', launch: '', note: 'Lean Test' },
        { id: 'L2', title: 'Maximum games selected', expected: 'All games display', steps: 'Add all available games', launch: '', note: 'Lean Test' },
        { id: 'L3', title: 'First day streak calculation', expected: 'Streak = 1', steps: 'New user logs first game', launch: '', note: 'Lean Test' },
        { id: 'L4', title: '365 day history performance', expected: 'Loads in <2s', steps: 'Load full year of data', launch: '', note: 'Lean Test' },
        { id: 'L5', title: 'Token balance at MAX_SAFE_INTEGER', expected: 'Displays correctly', steps: 'Set tokens to max value', launch: '', note: 'Lean Test' },
        { id: 'L6', title: 'Empty history display', expected: 'Shows empty state', steps: 'Clear all history', launch: '', note: 'Lean Test' },
        { id: 'L7', title: 'Single character input', expected: 'No crash', steps: 'Type single char "a"', launch: '#log', note: 'Lean Test' },
        { id: 'L8', title: 'Exactly max length input', expected: 'Accepted', steps: 'Paste at character limit', launch: '#log', note: 'Lean Test' },
        { id: 'L9', title: 'Date boundary at midnight', expected: 'Correct day assigned', steps: 'Log at 00:00:00', launch: '', note: 'Lean Test' },
        { id: 'L10', title: 'Leap year Feb 29 handling', expected: 'Valid date accepted', steps: 'Log on Feb 29 leap year', launch: '', note: 'Lean Test' }
    ]},
    
    // ========== M: RACE CONDITIONS (M1-M5) ==========
    { id: 'race-conditions', name: 'Race Conditions', icon: 'üèÉ', tests: [
        { id: 'M1', title: 'Rapid tab switching', expected: 'No crash or freeze', steps: 'Switch tabs 20x rapidly', launch: '', note: 'Lean Test' },
        { id: 'M2', title: 'Double-submit prevention', expected: 'Single entry created', steps: 'Click save button twice fast', launch: '#log', note: 'Lean Test' },
        { id: 'M3', title: 'Reload during save', expected: 'Data intact or clean', steps: 'Reload mid-save operation', launch: '', note: 'Lean Test' },
        { id: 'M4', title: 'Multiple paste events', expected: 'Latest paste wins', steps: 'Paste 3 results quickly', launch: '#log', note: 'Lean Test' },
        { id: 'M5', title: 'Concurrent localStorage access', expected: 'No data corruption', steps: 'Open 2 tabs, save in both', launch: '', note: 'Lean Test' }
    ]},
    
    // ========== N: CRITICAL FLOWS (N1-N5) ==========
    { id: 'critical-flows', name: 'Critical Flows', icon: 'üö¶', tests: [
        { id: 'N1', title: 'Fresh user to first log complete', expected: 'Full flow works', steps: '1. Fresh load\n2. Complete onboarding\n3. Log first game', launch: '?fresh=1', note: 'Lean Test' },
        { id: 'N2', title: 'Returning user quick log', expected: 'Direct to log sheet', steps: 'Navigate to #log', launch: '#log', note: 'Lean Test' },
        { id: 'N3', title: 'Data persists across sessions', expected: 'Data restored', steps: 'Log game, reload, verify', launch: '', note: 'Lean Test' },
        { id: 'N4', title: 'Theme persists across sessions', expected: 'Theme kept', steps: 'Toggle theme, reload, verify', launch: '', note: 'Lean Test' },
        { id: 'N5', title: 'Deep link to specific tab', expected: 'Correct tab shown', steps: 'Test #home, #games, #log, #share', launch: '', note: 'Lean Test' }
    ]},
    
    // ========== Q: SECURITY (Q1-Q5) ==========
    { id: 'security', name: 'Security', icon: 'üîí', tests: [
        { id: 'Q1', title: 'XSS via paste input', expected: 'Script escaped', steps: 'Paste script tag with alert', launch: '#log', note: 'Lean Test' },
        { id: 'Q2', title: 'XSS via URL hash', expected: 'Script not executed', steps: 'Navigate to hash with script tag', launch: '', note: 'Lean Test' },
        { id: 'Q3', title: 'XSS via referral code', expected: 'Script escaped', steps: 'Open URL with script in ref param', launch: '', note: 'Lean Test' },
        { id: 'Q4', title: 'Path traversal attempt', expected: 'Blocked', steps: 'Open ?ref=../../../etc/passwd', launch: '', note: 'Lean Test' },
        { id: 'Q5', title: 'Extremely long input handling', expected: 'No crash or hang', steps: 'Paste 100KB of text', launch: '#log', note: 'Lean Test' }
    ]},
    
    // ========== W: PERFORMANCE (W1-W5) ==========
    { id: 'performance', name: 'Performance', icon: '‚è±Ô∏è', tests: [
        { id: 'W1', title: 'Initial page load under 3 seconds', expected: '<3s on 3G', steps: 'Measure load time', launch: '', note: 'Lean Test' },
        { id: 'W2', title: 'Tab switch under 300ms', expected: '<300ms', steps: 'Measure tab switch time', launch: '', note: 'Lean Test' },
        { id: 'W3', title: 'History with 100 entries loads fast', expected: '<5s', steps: 'Load 100 day history', launch: '', note: 'Lean Test' },
        { id: 'W4', title: 'No memory leak on navigation', expected: '<3x memory growth', steps: 'Navigate 20 times, check memory', launch: '', note: 'Lean Test' },
        { id: 'W5', title: 'Large clipboard content handled', expected: '<2s parse time', steps: 'Paste 1000 line content', launch: '#log', note: 'Lean Test' }
    ]}
];

// ========== STATE ==========
let currentUser = null;
let isAdmin = false;
let userAssignment = null;
let testResults = {};
let currentSection = null;
let currentTab = 'testing';
let consoleLogs = [];
let debugPanelVisible = false;
let automationRunning = false;
let sessionStart = Date.now();
let detectedPlatform = null;

// ========== CONSOLE CAPTURE ==========
(function() {
    const orig = { log: console.log, warn: console.warn, error: console.error, info: console.info };
    function capture(type, args) {
        const entry = { type, ts: new Date().toISOString(), msg: Array.from(args).map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ') };
        consoleLogs.push(entry);
        if (consoleLogs.length > 1000) consoleLogs.shift();
        updateDebugPanel();
        updateMetrics();
    }
    console.log = function() { capture('log', arguments); orig.log.apply(console, arguments); };
    console.warn = function() { capture('warn', arguments); orig.warn.apply(console, arguments); };
    console.error = function() { capture('error', arguments); orig.error.apply(console, arguments); };
    console.info = function() { capture('info', arguments); orig.info.apply(console, arguments); };
    window.onerror = (m, u, l) => { capture('error', [`Uncaught: ${m} at ${u}:${l}`]); return false; };
    window.onunhandledrejection = e => capture('error', [`Promise: ${e.reason}`]);
})();

// ========== DARK MODE ==========
function initDarkMode() {
    const saved = localStorage.getItem('testplan-theme');
    // Default to dark mode unless explicitly set to light
    if (saved !== 'light') {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
}

function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('testplan-theme', 'light');
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('testplan-theme', 'dark');
    }
    // Re-render user info to update icon
    if (currentUser) renderUserInfo();
    // Update login screen icon if visible
    const loginIcon = document.getElementById('login-theme-icon');
    if (loginIcon) loginIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}

// Initialize dark mode immediately
initDarkMode();

// ========== AUTH ==========
auth.onAuthStateChanged(async user => {
    currentUser = user;
    if (user) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('debug-fab').classList.add('visible');
        isAdmin = ADMIN_EMAILS.includes(user.email);
        renderUserInfo();
        await loadData();
        checkIssueParams(); // Check URL for direct issue link
        renderHeaderTabs();
        renderUI();
        updatePlatformUI();
        if (isAdmin) renderAdminPanel();
        renderAutomationTests();
        // Ensure correct tab is displayed (especially for direct links)
        switchTab(currentTab);
    } else {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');
    }
});

function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => toast('Sign in failed')); }
function signOut() { auth.signOut(); }

function renderUserInfo() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.getElementById('user-info').innerHTML = `
        <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">
            ${isDark ? '‚òÄÔ∏è' : 'üåô'}
        </button>
        ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}
        <img class="user-avatar" src="${currentUser.photoURL || ''}" alt="">
        <span>${currentUser.displayName?.split(' ')[0] || ''}</span>
        <button class="header-btn" onclick="signOut()">Sign Out</button>
    `;
}

function renderHeaderTabs() {
    const tabs = [{ id: 'testing', label: 'üß™ Tests' }];
    if (isAdmin) tabs.push({ id: 'admin', label: 'üëë Admin' });
    tabs.push({ id: 'debug', label: 'üîß Debug' }, { id: 'automation', label: 'ü§ñ Auto' }, { id: 'reports', label: 'üìä Reports' }, { id: 'issues', label: 'üêõ Issues' });
    document.getElementById('header-tabs').innerHTML = tabs.map(t => 
        `<button class="header-tab ${t.id === currentTab ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}</button>`
    ).join('');
}

function switchTab(tab) {
    currentTab = tab;
    renderHeaderTabs();
    ['testing', 'admin', 'debug', 'automation', 'reports', 'issues'].forEach(t => 
        document.getElementById(`tab-${t}`)?.classList.toggle('hidden', t !== tab)
    );
    if (tab === 'reports') renderReports();
    if (tab === 'issues') loadIssues();
}

// ========== DATA ==========
async function loadData() {
    const emailKey = currentUser.email.replace(/\./g, ',');
    const [assignSnap, resultsSnap] = await Promise.all([
        db.ref(`test-assignments/${emailKey}`).once('value'),
        db.ref(`test-results/${currentUser.uid}`).once('value')
    ]);
    userAssignment = assignSnap.val();
    testResults = resultsSnap.val() || {};
}

function getAssignedTests() {
    if (isAdmin && !userAssignment) return TEST_SECTIONS.flatMap(s => s.tests);
    if (userAssignment?.testIds) {
        const ids = new Set(userAssignment.testIds);
        return TEST_SECTIONS.flatMap(s => s.tests).filter(t => ids.has(t.id));
    }
    return [];
}

function getAssignedSections() {
    const tests = getAssignedTests();
    const ids = new Set(tests.map(t => t.id));
    return TEST_SECTIONS.filter(s => s.tests.some(t => ids.has(t.id)))
        .map(s => ({ ...s, tests: s.tests.filter(t => ids.has(t.id)) }));
}

// ========== UI ==========
function renderUI() {
    const tests = getAssignedTests();
    const noTests = !tests.length && !isAdmin;
    
    document.getElementById('no-tests').classList.toggle('hidden', !noTests);
    document.getElementById('section-tabs').classList.toggle('hidden', noTests);
    document.getElementById('progress-panel').classList.toggle('hidden', noTests);
    
    if (userAssignment) {
        document.getElementById('assignment-banner').classList.remove('hidden');
        document.getElementById('assignment-desc').innerHTML = `<strong>${userAssignment.focusArea || 'General'}</strong> - ${userAssignment.testIds?.length || 0} tests assigned`;
    }
    
    if (noTests) return;
    
    const sections = getAssignedSections();
    if (sections.length && !currentSection) currentSection = sections[0].id;
    
    renderSectionTabs();
    renderTestCards();
    updateProgress();
}

function renderSectionTabs() {
    const sections = getAssignedSections();
    document.getElementById('section-tabs').innerHTML = sections.map(s => {
        const done = s.tests.filter(t => testResults[t.id]?.status).length;
        return `<button class="section-tab ${s.id === currentSection ? 'active' : ''}" onclick="switchSection('${s.id}')">${s.icon} ${s.name} <span class="count">${done}/${s.tests.length}</span></button>`;
    }).join('');
}

function switchSection(id) { currentSection = id; renderSectionTabs(); renderTestCards(); }

function renderTestCards() {
    const section = getAssignedSections().find(s => s.id === currentSection);
    if (!section) return;
    
    document.getElementById('test-cards').innerHTML = section.tests.map(test => {
        const r = testResults[test.id] || {};
        const status = r.status || 'pending';
        const variantResults = r.variants || {};
        const hasVariants = test.variants && test.variants.length > 0;
        const variantStats = hasVariants ? getVariantStats(test, variantResults) : null;
        
        return `
            <div class="test-card status-${status}" id="card-${test.id}">
                <div class="test-header" onclick="toggleCard('${test.id}')">
                    <span class="test-id">${test.id}</span>
                    <span class="test-title">${test.title}</span>
                    ${hasVariants ? `<span class="variant-badge" title="${variantStats.pass}/${variantStats.total} variants passed">üîÄ ${variantStats.pass}/${variantStats.total}</span>` : ''}
                    ${r.platform ? `<span class="platform-badge">${getPlatformIcon(r.platform)}</span>` : ''}
                    <span class="test-status ${status}">${status === 'pass' ? '‚úì' : status === 'fail' ? '‚úó' : status === 'skip' ? '‚àí' : ''}</span>
                    <span class="test-chevron">‚ñº</span>
                </div>
                <div class="test-body">
                    <div class="launch-row">
                        <button class="launch-btn" onclick="launchTest('${test.id}')">üöÄ Launch Feature</button>
                        <button class="launch-btn debug" onclick="launchTestDebug('${test.id}')">üîß Launch with Debug</button>
                    </div>
                    <p class="launch-note">${test.note || 'Opens Game Shelf'}</p>
                    
                    ${test.data ? `<div class="test-data" onclick="copyData('${test.id}')" title="Click to copy">${escapeHtml(test.data)}</div><button class="btn btn-sm btn-secondary" onclick="copyData('${test.id}')">üìã Copy Test Data</button>` : ''}
                    
                    <div class="info-box"><h4>Expected</h4>${test.expected}</div>
                    <div class="info-box"><h4>Steps</h4><pre style="margin:0;white-space:pre-wrap;font-family:inherit;">${test.steps}</pre></div>
                    
                    <div class="action-buttons">
                        <button class="action-btn pass ${status === 'pass' ? 'selected' : ''}" onclick="setStatus('${test.id}','pass')">‚úì Pass</button>
                        <button class="action-btn fail ${status === 'fail' ? 'selected' : ''}" onclick="setStatus('${test.id}','fail')">‚úó Fail</button>
                        <button class="action-btn skip ${status === 'skip' ? 'selected' : ''}" onclick="setStatus('${test.id}','skip')">‚àí Skip</button>
                    </div>
                    
                    ${hasVariants ? renderVariantsSection(test, variantResults) : ''}
                    
                    <div class="platform-section">
                        <label style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; display: block; margin-bottom: 6px;">Tested On <button class="btn btn-sm btn-secondary" style="margin-left: 8px; padding: 2px 8px;" onclick="autoDetectPlatform('${test.id}')">üîç Auto-detect</button></label>
                        <div class="platform-buttons" id="platforms-${test.id}">
                            <button class="platform-btn ${r.platform === 'desktop-chrome' ? 'selected' : ''}" onclick="setPlatform('${test.id}','desktop-chrome')">üñ•Ô∏è Chrome</button>
                            <button class="platform-btn ${r.platform === 'desktop-safari' ? 'selected' : ''}" onclick="setPlatform('${test.id}','desktop-safari')">üñ•Ô∏è Safari</button>
                            <button class="platform-btn ${r.platform === 'desktop-firefox' ? 'selected' : ''}" onclick="setPlatform('${test.id}','desktop-firefox')">üñ•Ô∏è Firefox</button>
                            <button class="platform-btn ${r.platform === 'iphone-safari' ? 'selected' : ''}" onclick="setPlatform('${test.id}','iphone-safari')">üì± iPhone Safari</button>
                            <button class="platform-btn ${r.platform === 'iphone-pwa' ? 'selected' : ''}" onclick="setPlatform('${test.id}','iphone-pwa')">üì± iPhone PWA</button>
                            <button class="platform-btn ${r.platform === 'android-chrome' ? 'selected' : ''}" onclick="setPlatform('${test.id}','android-chrome')">ü§ñ Android Chrome</button>
                            <button class="platform-btn ${r.platform === 'android-pwa' ? 'selected' : ''}" onclick="setPlatform('${test.id}','android-pwa')">ü§ñ Android PWA</button>
                            <button class="platform-btn ${r.platform === 'ipad' ? 'selected' : ''}" onclick="setPlatform('${test.id}','ipad')">üì≤ iPad</button>
                        </div>
                    </div>
                    
                    <textarea class="notes-input" id="notes-${test.id}" placeholder="Notes, issues, observations..." onchange="saveNotes('${test.id}')">${r.notes || ''}</textarea>
                    
                    <div class="screenshot-row">
                        <label class="upload-btn">üì∑ Screenshot<input type="file" accept="image/*" onchange="uploadImg('${test.id}',this)"></label>
                        <label class="upload-btn">üì∏ Camera<input type="file" accept="image/*" capture="environment" onchange="uploadImg('${test.id}',this)"></label>
                        ${(r.screenshots || []).map((u, i) => `<div class="screenshot-thumb"><img src="${u}" onclick="window.open('${u}')"><button class="remove" onclick="removeImg('${test.id}',${i})">√ó</button></div>`).join('')}
                    </div>
                    
                    <div class="console-section">
                        <label class="console-toggle"><input type="checkbox" ${r.includeConsole ? 'checked' : ''} onchange="toggleConsole('${test.id}',this.checked)"> Attach console logs</label>
                        ${r.consoleLogs ? `<div class="console-output">${r.consoleLogs.slice(-10).map(l => `<div class="${l.type}">[${l.type}] ${escapeHtml(l.msg)}</div>`).join('')}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Variant helper functions
function getVariantStats(test, variantResults) {
    const total = test.variants.length;
    const pass = test.variants.filter((v, i) => variantResults[i] === 'pass').length;
    const fail = test.variants.filter((v, i) => variantResults[i] === 'fail').length;
    return { total, pass, fail };
}

function renderVariantsSection(test, variantResults) {
    const typeIcons = { happy: '‚úÖ', edge: '‚ö†Ô∏è', error: '‚ùå' };
    const typeLabels = { happy: 'Happy Path', edge: 'Edge Case', error: 'Error Case' };
    
    return `
        <div class="variants-section">
            <div class="variants-header" onclick="toggleVariants('${test.id}')">
                <span>üîÄ Test Variants (${test.variants.length})</span>
                <span class="variants-chevron">‚ñº</span>
            </div>
            <div class="variants-body" id="variants-${test.id}">
                ${test.variants.map((v, i) => {
                    const vStatus = variantResults[i] || 'pending';
                    return `
                        <div class="variant-row status-${vStatus}">
                            <div class="variant-info">
                                <span class="variant-type" title="${typeLabels[v.type]}">${typeIcons[v.type]}</span>
                                <span class="variant-name">${v.name}</span>
                            </div>
                            <div class="variant-expected">${v.expected}</div>
                            ${v.data ? `<div class="variant-data" onclick="copyVariantData('${escapeHtml(v.data)}')" title="Click to copy">${escapeHtml(v.data.substring(0, 50))}${v.data.length > 50 ? '...' : ''}</div>` : ''}
                            ${v.launch ? `<button class="btn btn-sm btn-secondary" onclick="launchVariant('${v.launch}')">üöÄ</button>` : ''}
                            <div class="variant-actions">
                                <button class="variant-btn pass ${vStatus === 'pass' ? 'selected' : ''}" onclick="setVariantStatus('${test.id}',${i},'pass')">‚úì</button>
                                <button class="variant-btn fail ${vStatus === 'fail' ? 'selected' : ''}" onclick="setVariantStatus('${test.id}',${i},'fail')">‚úó</button>
                                <button class="variant-btn skip ${vStatus === 'skip' ? 'selected' : ''}" onclick="setVariantStatus('${test.id}',${i},'skip')">‚àí</button>
                            </div>
                        </div>
                    `;
                }).join('')}
                <div class="variant-actions-row">
                    <button class="btn btn-sm btn-success" onclick="passAllVariants('${test.id}')">‚úì Pass All</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetVariants('${test.id}')">üîÑ Reset</button>
                </div>
            </div>
        </div>
    `;
}

function toggleVariants(testId) {
    const body = document.getElementById(`variants-${testId}`);
    body.classList.toggle('expanded');
    body.previousElementSibling.querySelector('.variants-chevron').style.transform = 
        body.classList.contains('expanded') ? 'rotate(180deg)' : '';
}

function setVariantStatus(testId, variantIndex, status) {
    const existing = testResults[testId] || {};
    const variants = existing.variants || {};
    variants[variantIndex] = status;
    saveResult(testId, { ...existing, variants });
    renderTestCards();
}

function passAllVariants(testId) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === testId);
    if (!test || !test.variants) return;
    const existing = testResults[testId] || {};
    const variants = {};
    test.variants.forEach((v, i) => variants[i] = 'pass');
    saveResult(testId, { ...existing, variants, status: 'pass' });
    renderTestCards();
}

function resetVariants(testId) {
    const existing = testResults[testId] || {};
    saveResult(testId, { ...existing, variants: {} });
    renderTestCards();
}

function copyVariantData(data) {
    navigator.clipboard.writeText(data);
    toast('Variant data copied!');
}

function launchVariant(launch) {
    const debugParams = getDebugParams();
    const url = GAMESHELF_URL + launch + (launch.includes('?') ? '&' : '?') + debugParams;
    window.open(url, '_blank');
    toast('Launching variant test...');
}

// ========== LAUNCH ==========
function launchTest(id) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === id);
    window.open(GAMESHELF_URL + (test?.launch || ''), '_blank');
    toast('Launching Game Shelf...');
}

function launchTestDebug(id) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === id);
    const debugParams = getDebugParams();
    const url = GAMESHELF_URL + (test?.launch || '') + (test?.launch?.includes('?') ? '&' : '?') + debugParams;
    window.open(url, '_blank');
    toast('Launching with debug mode...');
}

function launchWithDebug() {
    const debugParams = getDebugParams();
    window.open(GAMESHELF_URL + '?' + debugParams, '_blank');
    toast('Launching with debug...');
}

function getDebugParams() {
    const opts = [];
    if (document.getElementById('debug-console')?.checked) opts.push('debugConsole=1');
    if (document.getElementById('debug-network')?.checked) opts.push('debugNetwork=1');
    if (document.getElementById('debug-performance')?.checked) opts.push('debugPerf=1');
    if (document.getElementById('debug-storage')?.checked) opts.push('debugStorage=1');
    if (document.getElementById('debug-events')?.checked) opts.push('debugEvents=1');
    if (document.getElementById('debug-errors')?.checked) opts.push('debugErrors=1');
    return opts.join('&');
}

function copyDebugBookmarklet() {
    const code = `javascript:(function(){localStorage.setItem('gs-debug',JSON.stringify({console:true,network:true,perf:true,storage:true,events:true,errors:true}));location.reload();})();`;
    navigator.clipboard.writeText(code);
    toast('Bookmarklet copied! Add to browser bookmarks.');
}

function copyData(id) {
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === id);
    if (test?.data) { navigator.clipboard.writeText(test.data); toast('Test data copied!'); }
}

// ========== TEST RESULTS ==========
function setStatus(id, status) { 
    const existing = testResults[id] || {};
    // Auto-apply detected platform if not already set
    const platform = existing.platform || detectedPlatform;
    saveResult(id, { ...existing, status, platform }); 
    renderTestCards(); 
}
function setPlatform(id, platform) { saveResult(id, { ...(testResults[id] || {}), platform }); renderTestCards(); }
function saveNotes(id) { saveResult(id, { ...(testResults[id] || {}), notes: document.getElementById(`notes-${id}`).value }); }
function toggleConsole(id, on) { saveResult(id, { ...(testResults[id] || {}), includeConsole: on, consoleLogs: on ? consoleLogs.slice(-50) : null }); }

function saveResult(id, data) {
    testResults[id] = { ...data, tester: { uid: currentUser.uid, name: currentUser.displayName, email: currentUser.email }, updatedAt: new Date().toISOString(), device: navigator.userAgent, screen: `${innerWidth}x${innerHeight}` };
    db.ref(`test-results/${currentUser.uid}/${id}`).set(testResults[id]).then(() => { updateProgress(); toast('Saved'); });
}

async function uploadImg(id, input) {
    const file = input.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        const r = testResults[id] || {};
        const shots = r.screenshots || [];
        shots.push(reader.result);
        saveResult(id, { ...r, screenshots: shots });
        renderTestCards();
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function removeImg(id, i) {
    const r = testResults[id] || {};
    const shots = r.screenshots || [];
    shots.splice(i, 1);
    saveResult(id, { ...r, screenshots: shots });
    renderTestCards();
}

function updateProgress() {
    const tests = getAssignedTests();
    let pass = 0, fail = 0, skip = 0, pending = 0;
    tests.forEach(t => { const s = testResults[t.id]?.status; if (s === 'pass') pass++; else if (s === 'fail') fail++; else if (s === 'skip') skip++; else pending++; });
    const done = pass + fail + skip;
    document.getElementById('progress-fill').style.width = (tests.length ? done / tests.length * 100 : 0) + '%';
    document.getElementById('progress-text').textContent = `${done}/${tests.length} (${tests.length ? Math.round(done / tests.length * 100) : 0}%)`;
    document.getElementById('cnt-pass').textContent = pass;
    document.getElementById('cnt-fail').textContent = fail;
    document.getElementById('cnt-skip').textContent = skip;
    document.getElementById('cnt-pending').textContent = pending;
    renderSectionTabs();
}

// ========== ADMIN ==========
function renderAdminPanel() {
    document.getElementById('test-grid').innerHTML = TEST_SECTIONS.map(s => `
        <div class="section-header">${s.icon} ${s.name} <button class="select-all-btn" onclick="selectSection('${s.id}')">All</button></div>
        ${s.tests.map(t => `<label class="test-checkbox"><input type="checkbox" value="${t.id}">${t.id}</label>`).join('')}
    `).join('');
}

function selectSection(id) {
    const sec = TEST_SECTIONS.find(s => s.id === id);
    sec?.tests.forEach(t => { const cb = document.querySelector(`#test-grid input[value="${t.id}"]`); if (cb) cb.checked = true; });
}

function switchAdminTab(tab) {
    document.querySelectorAll('#tab-admin .tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase().includes(tab)));
    document.getElementById('admin-assign').classList.toggle('hidden', tab !== 'assign');
    document.getElementById('admin-view').classList.toggle('hidden', tab !== 'view');
    document.getElementById('admin-results').classList.toggle('hidden', tab !== 'results');
    if (tab === 'view') loadAssignments();
    if (tab === 'results') loadAllResults();
}

async function createAssignment() {
    const email = document.getElementById('assign-email').value.trim();
    const focus = document.getElementById('assign-focus').value.trim();
    const ids = Array.from(document.querySelectorAll('#test-grid input:checked')).map(c => c.value);
    if (!email) return toast('Enter email');
    if (!ids.length) return toast('Select tests');
    const key = email.replace(/\./g, ',');
    await db.ref(`test-assignments/${key}`).set({ email, focusArea: focus || 'General', testIds: ids, createdAt: new Date().toISOString(), createdBy: currentUser.email });
    toast(`Assigned ${ids.length} tests`);
    document.getElementById('assign-email').value = '';
    document.getElementById('assign-focus').value = '';
    document.querySelectorAll('#test-grid input:checked').forEach(c => c.checked = false);
}

async function loadAssignments() {
    const snap = await db.ref('test-assignments').once('value');
    const data = snap.val() || {};
    document.getElementById('admin-view').innerHTML = Object.entries(data).length ? Object.entries(data).map(([k, a]) => `
        <div class="assignment-card">
            <div><h4>${a.email}</h4><p>${a.focusArea}</p></div>
            <span class="badge">${a.testIds?.length || 0}</span>
            <button class="btn btn-danger btn-sm" onclick="deleteAssignment('${k}')">üóëÔ∏è</button>
        </div>
    `).join('') : '<p style="color:var(--gray-500)">No assignments</p>';
}

async function deleteAssignment(key) {
    if (!confirm('Delete?')) return;
    await db.ref(`test-assignments/${key}`).remove();
    toast('Deleted');
    loadAssignments();
}

async function loadAllResults() {
    const snap = await db.ref('test-results').once('value');
    const data = snap.val() || {};
    const rows = Object.entries(data).map(([uid, results]) => {
        const tests = Object.values(results);
        const platforms = [...new Set(tests.map(t => t.platform).filter(Boolean))];
        return { 
            name: tests[0]?.tester?.name || uid, 
            pass: tests.filter(t => t.status === 'pass').length, 
            fail: tests.filter(t => t.status === 'fail').length, 
            total: tests.length,
            platforms: platforms
        };
    });
    document.getElementById('admin-results').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="exportAllResults()" style="margin-bottom:10px;">üìä Export All</button>
        <table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
            <tr style="background:var(--gray-100)"><th style="padding:6px;text-align:left">Tester</th><th>Pass</th><th>Fail</th><th>Total</th><th style="text-align:left">Platforms</th></tr>
            ${rows.map(r => `<tr style="border-bottom:1px solid var(--gray-200)"><td style="padding:6px">${r.name}</td><td style="text-align:center;color:var(--success)">${r.pass}</td><td style="text-align:center;color:var(--danger)">${r.fail}</td><td style="text-align:center">${r.total}</td><td style="padding:6px;font-size:0.7rem">${r.platforms.map(p => getPlatformIcon(p)).join(', ') || '-'}</td></tr>`).join('')}
        </table>
    `;
}

async function exportAllResults() {
    const snap = await db.ref('test-results').once('value');
    navigator.clipboard.writeText(JSON.stringify(snap.val(), null, 2));
    toast('All results copied!');
}

// ========== DEBUG ==========
function updateDebugPanel() {
    document.getElementById('log-count').textContent = consoleLogs.length;
    document.getElementById('debug-content').innerHTML = consoleLogs.slice(-100).map(l => `<div class="debug-entry ${l.type}">[${l.type}] ${escapeHtml(l.msg)}</div>`).join('');
    document.getElementById('debug-content').scrollTop = 99999;
}

function toggleDebugPanel() {
    debugPanelVisible = !debugPanelVisible;
    document.getElementById('debug-panel').classList.toggle('visible', debugPanelVisible);
}

function clearLogs() { consoleLogs = []; updateDebugPanel(); }

function updateMetrics() {
    document.getElementById('metric-errors').textContent = consoleLogs.filter(l => l.type === 'error').length;
    document.getElementById('metric-warnings').textContent = consoleLogs.filter(l => l.type === 'warn').length;
    document.getElementById('metric-logs').textContent = consoleLogs.length;
    document.getElementById('metric-duration').textContent = Math.round((Date.now() - sessionStart) / 1000) + 's';
}

function clearMetrics() { consoleLogs = []; sessionStart = Date.now(); updateMetrics(); updateDebugPanel(); toast('Metrics cleared'); }

// ========== AUTOMATION ==========
function renderAutomationTests() {
    document.getElementById('automation-tests').innerHTML = TEST_SECTIONS.map(s => `
        <div class="section-header">${s.icon} ${s.name} <button class="select-all-btn" onclick="selectAutoSection('${s.id}')">All</button></div>
        ${s.tests.map(t => `<label class="test-checkbox"><input type="checkbox" value="${t.id}" class="auto-test">${t.id}: ${t.title.substring(0, 25)}...</label>`).join('')}
    `).join('');
}

function selectAutoSection(id) {
    const sec = TEST_SECTIONS.find(s => s.id === id);
    sec?.tests.forEach(t => { const cb = document.querySelector(`.auto-test[value="${t.id}"]`); if (cb) cb.checked = true; });
}

function addAutoLog(msg, type = 'info') {
    const log = document.getElementById('automation-log');
    log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
    log.scrollTop = 99999;
}

function updateAutoStatus(text, detail) {
    document.getElementById('automation-status').innerHTML = `<div class="status-text">${text}</div><div class="status-detail">${detail}</div>`;
}

// Automation state
let autoTestQueue = [];
let autoCurrentIndex = 0;
let autoWindow = null;
let autoTimer = null;
let autoCountdown = 0;
let lastAutoUrl = '';

async function runAllTests() {
    const tests = getAssignedTests();
    document.querySelectorAll('.auto-test').forEach(cb => { cb.checked = tests.some(t => t.id === cb.value); });
    await runSelectedTests();
}

async function runSelectedTests() {
    const selected = Array.from(document.querySelectorAll('.auto-test:checked')).map(cb => cb.value);
    if (!selected.length) return toast('Select tests first');
    
    autoTestQueue = selected;
    autoCurrentIndex = 0;
    automationRunning = true;
    
    const isAutoAdvance = document.getElementById('auto-advance')?.checked;
    const delay = document.getElementById('auto-delay')?.value || '5';
    
    addAutoLog(`Queued ${selected.length} tests`, 'info');
    addAutoLog(`Mode: ${isAutoAdvance ? `Auto-advance every ${delay}s` : 'Manual (click Next Test)'}`, 'info');
    
    // Start first test
    runNextTest();
}

async function runNextTest() {
    // Clear any existing timer
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    if (!automationRunning || autoCurrentIndex >= autoTestQueue.length) {
        automationRunning = false;
        lastAutoUrl = '';
        updateAutoStatus('‚úÖ Complete', `${autoTestQueue.length} tests run`);
        addAutoLog('All tests complete!', 'success');
        return;
    }
    
    const testId = autoTestQueue[autoCurrentIndex];
    const test = TEST_SECTIONS.flatMap(s => s.tests).find(t => t.id === testId);
    const isAutoAdvance = document.getElementById('auto-advance')?.checked;
    const delay = parseInt(document.getElementById('auto-delay')?.value || '5');
    
    addAutoLog(`Running ${testId}: ${test?.title}`, 'info');
    
    // Build URL - only if test has a launch parameter
    const hasLaunch = test?.launch && test.launch.length > 0;
    
    if (hasLaunch) {
        const debugParams = getDebugParams();
        let url = GAMESHELF_URL + test.launch;
        const separator = url.includes('?') ? '&' : '?';
        if (debugParams) url += separator + debugParams;
        
        // For ?fresh=1 tests, close existing window to ensure clean state
        const needsFreshWindow = test.launch.includes('fresh=1');
        if (needsFreshWindow && autoWindow && !autoWindow.closed) {
            addAutoLog('Closing window for fresh start...', 'info');
            autoWindow.close();
            autoWindow = null;
            // Small delay to ensure window is closed
            await new Promise(r => setTimeout(r, 500));
        }
        
        // Only navigate if URL is different from last (or fresh window needed)
        if (url !== lastAutoUrl || needsFreshWindow) {
            addAutoLog(`Opening: ${url}`, 'info');
            lastAutoUrl = url;
            
            // Reuse same window to avoid popup blockers (unless fresh needed)
            if (autoWindow && !autoWindow.closed) {
                autoWindow.location.href = url;
                autoWindow.focus();
            } else {
                autoWindow = window.open(url, 'gameshelf-test');
            }
        } else {
            addAutoLog(`Same URL - continuing in current window`, 'info');
            if (autoWindow && !autoWindow.closed) autoWindow.focus();
        }
    } else {
        addAutoLog(`Continue in current window (${test?.note || 'sequential test'})`, 'info');
        if (autoWindow && !autoWindow.closed) autoWindow.focus();
    }
    
    // Start countdown if auto-advance is enabled
    if (isAutoAdvance) {
        autoCountdown = delay;
        updateAutoStatus(
            `üîÑ Test ${autoCurrentIndex + 1}/${autoTestQueue.length}: ${testId}`,
            `${test?.title || ''} - Next in ${autoCountdown}s`
        );
        
        autoTimer = setInterval(() => {
            autoCountdown--;
            if (autoCountdown <= 0) {
                clearInterval(autoTimer);
                autoTimer = null;
                addAutoLog(`${testId} auto-advanced`, 'success');
                autoCurrentIndex++;
                runNextTest();
            } else {
                updateAutoStatus(
                    `üîÑ Test ${autoCurrentIndex + 1}/${autoTestQueue.length}: ${testId}`,
                    `${test?.title || ''} - Next in ${autoCountdown}s`
                );
            }
        }, 1000);
    } else {
        updateAutoStatus(
            `üîÑ Test ${autoCurrentIndex + 1}/${autoTestQueue.length}: ${testId}`,
            `${test?.title || ''} - Click "Next Test" when done`
        );
    }
}

function nextTest() {
    if (!automationRunning) return toast('Start automation first');
    
    // Clear timer if running
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    const testId = autoTestQueue[autoCurrentIndex];
    addAutoLog(`${testId} marked as reviewed`, 'success');
    
    autoCurrentIndex++;
    runNextTest();
}

function skipTest() {
    if (!automationRunning) return toast('Start automation first');
    
    // Clear timer if running
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    const testId = autoTestQueue[autoCurrentIndex];
    addAutoLog(`${testId} skipped`, 'warn');
    
    autoCurrentIndex++;
    runNextTest();
}

function stopTests() {
    // Clear timer
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    automationRunning = false;
    autoTestQueue = [];
    autoCurrentIndex = 0;
    lastAutoUrl = '';
    updateAutoStatus('‚èπÔ∏è Stopped', 'Automation halted');
    addAutoLog('Automation stopped', 'error');
}

function resetAutomation() {
    // Clear timer
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
    
    automationRunning = false;
    autoTestQueue = [];
    autoCurrentIndex = 0;
    lastAutoUrl = '';
    if (autoWindow && !autoWindow.closed) autoWindow.close();
    autoWindow = null;
    document.getElementById('automation-log').innerHTML = '<div class="info">[Ready] Automation runner reset</div>';
    updateAutoStatus('‚è∏Ô∏è Ready', 'Select tests and click Run');
    document.querySelectorAll('.auto-test').forEach(cb => cb.checked = false);
}

// ========== ISSUE REPORTING ==========
let issuesData = [];
let currentScreenshotData = null;

// Load issues from Firebase
async function loadIssues() {
    const container = document.getElementById('issues-list');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">Loading issues...</div>';
    
    try {
        // Check if user is authenticated
        if (!currentUser) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">Please sign in to view issues</div>';
            return;
        }
        
        const snapshot = await db.ref('reported-issues').orderByChild('timestamp').once('value');
        const data = snapshot.val() || {};
        
        issuesData = Object.entries(data).map(([id, issue]) => ({ id, ...issue }))
            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        filterIssues();
    } catch (e) {
        console.error('Error loading issues:', e);
        // Show more helpful error message
        let errorMsg = 'Error loading issues';
        if (e.code === 'PERMISSION_DENIED') {
            errorMsg = 'Permission denied - Firebase rules may need updating';
        } else if (e.message) {
            errorMsg = `Error: ${e.message}`;
        }
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--danger);">${errorMsg}</div>`;
    }
}

// Filter and render issues
function filterIssues() {
    const container = document.getElementById('issues-list');
    const typeFilter = document.getElementById('filter-type').value;
    const statusFilter = document.getElementById('filter-status').value;
    const priorityFilter = document.getElementById('filter-priority').value;
    const severityFilter = document.getElementById('filter-severity').value;
    
    let filtered = issuesData;
    
    if (typeFilter !== 'all') {
        filtered = filtered.filter(i => (i.type || 'bug') === typeFilter);
    }
    if (statusFilter !== 'all') {
        filtered = filtered.filter(i => (i.status || 'open') === statusFilter);
    }
    if (priorityFilter !== 'all') {
        if (priorityFilter === 'none') {
            filtered = filtered.filter(i => !i.priority);
        } else {
            filtered = filtered.filter(i => i.priority === priorityFilter);
        }
    }
    if (severityFilter !== 'all') {
        filtered = filtered.filter(i => i.severity === severityFilter);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">No issues found</div>';
        return;
    }
    
    container.innerHTML = filtered.map(issue => renderIssueCard(issue)).join('');
}

// Render a single issue card
function renderIssueCard(issue) {
    const typeIcons = { bug: 'üêõ', enhancement: '‚ú®', feature: 'üí°', question: '‚ùì' };
    const typeLabels = { bug: 'Bug', enhancement: 'Enhancement', feature: 'Feature', question: 'Question' };
    const severityIcons = { critical: 'üî¥', major: 'üü†', minor: 'üü°', cosmetic: 'üü¢', suggestion: 'üí°' };
    const statusLabels = { 
        open: 'üîµ Open', 
        triaged: 'üìã Triaged',
        'in-progress': 'üü° In Progress', 
        'in-review': 'üîç In Review',
        resolved: 'üü¢ Resolved', 
        closed: '‚ö´ Closed',
        'wont-fix': 'üö´ Won\'t Fix',
        duplicate: 'üìé Duplicate'
    };
    const priorityLabels = {
        p0: 'üî¥ P0',
        p1: 'üü† P1',
        p2: 'üü° P2',
        p3: 'üü¢ P3',
        p4: '‚ö™ P4'
    };
    const sectionIcons = { home: 'üè†', games: 'üéÆ', social: 'üë•', battles: '‚öîÔ∏è', share: 'üì§', log: 'üìã', settings: '‚öôÔ∏è', onboarding: 'üéØ', auth: 'üîê', achievements: 'üèÜ', rewards: 'üéÅ', notifications: 'üîî', other: 'üì±' };
    
    const type = issue.type || 'bug';
    const status = issue.status || 'open';
    const priority = issue.priority;
    const timeAgo = getTimeAgo(issue.timestamp);
    
    return `
        <div class="issue-card severity-${issue.severity} status-${status}" style="border-left: 4px solid ${type === 'bug' ? '#ef4444' : type === 'enhancement' ? '#6366f1' : type === 'feature' ? '#22c55e' : '#6b7280'};">
            <div class="issue-header">
                <div class="issue-title">
                    <span style="margin-right: 6px;">${typeIcons[type] || 'üêõ'}</span>
                    ${escapeHtml(issue.title)}
                </div>
                <div class="issue-badges">
                    <span class="issue-badge type" style="background: ${type === 'bug' ? '#fef2f2' : type === 'enhancement' ? '#eef2ff' : type === 'feature' ? '#f0fdf4' : '#f9fafb'}; color: ${type === 'bug' ? '#dc2626' : type === 'enhancement' ? '#4f46e5' : type === 'feature' ? '#16a34a' : '#4b5563'};">${typeLabels[type]}</span>
                    <span class="issue-badge section">${sectionIcons[issue.section] || 'üì±'} ${issue.section}</span>
                    <span class="issue-badge severity">${severityIcons[issue.severity]} ${issue.severity}</span>
                    ${priority ? `<span class="issue-badge priority" style="background: ${priority === 'p0' ? '#fef2f2' : priority === 'p1' ? '#fff7ed' : priority === 'p2' ? '#fefce8' : '#f0fdf4'}; color: ${priority === 'p0' ? '#dc2626' : priority === 'p1' ? '#ea580c' : priority === 'p2' ? '#ca8a04' : '#16a34a'}; font-weight: 600;">${priorityLabels[priority]}</span>` : ''}
                    <span class="issue-badge status-${status}">${statusLabels[status] || status}</span>
                </div>
            </div>
            <div class="issue-description">${escapeHtml(issue.description || '').substring(0, 200)}${(issue.description || '').length > 200 ? '...' : ''}</div>
            <div class="issue-meta">
                ${issue.screenshotUrl ? `<img src="${issue.screenshotUrl}" class="issue-screenshot-thumb" onclick="showImageModal('${issue.screenshotUrl}')" alt="Screenshot">` : ''}
                <span>üì± ${issue.platform || 'Unknown'}</span>
                <span>üì¶ ${issue.appVersion || '?'}</span>
                <span>üë§ ${issue.reporterName || 'Anonymous'}</span>
                <span>üïê ${timeAgo}</span>
            </div>
            ${isAdmin ? `
                <div class="issue-actions" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                    <select onchange="updateIssuePriority('${issue.id}', this.value)" style="padding: 4px 8px; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.75rem;">
                        <option value="" ${!priority ? 'selected' : ''}>Set Priority</option>
                        <option value="p0" ${priority === 'p0' ? 'selected' : ''}>P0 - Critical</option>
                        <option value="p1" ${priority === 'p1' ? 'selected' : ''}>P1 - High</option>
                        <option value="p2" ${priority === 'p2' ? 'selected' : ''}>P2 - Medium</option>
                        <option value="p3" ${priority === 'p3' ? 'selected' : ''}>P3 - Low</option>
                        <option value="p4" ${priority === 'p4' ? 'selected' : ''}>P4 - Backlog</option>
                    </select>
                    <select onchange="updateIssueStatus('${issue.id}', this.value)" style="padding: 4px 8px; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.75rem;">
                        <option value="open" ${status === 'open' ? 'selected' : ''}>üîµ Open</option>
                        <option value="triaged" ${status === 'triaged' ? 'selected' : ''}>üìã Triaged</option>
                        <option value="in-progress" ${status === 'in-progress' ? 'selected' : ''}>üü° In Progress</option>
                        <option value="in-review" ${status === 'in-review' ? 'selected' : ''}>üîç In Review</option>
                        <option value="resolved" ${status === 'resolved' ? 'selected' : ''}>üü¢ Resolved</option>
                        <option value="closed" ${status === 'closed' ? 'selected' : ''}>‚ö´ Closed</option>
                        <option value="wont-fix" ${status === 'wont-fix' ? 'selected' : ''}>üö´ Won't Fix</option>
                        <option value="duplicate" ${status === 'duplicate' ? 'selected' : ''}>üìé Duplicate</option>
                    </select>
                    <button class="btn btn-sm btn-danger" onclick="deleteIssue('${issue.id}')" style="padding: 4px 8px;">üóëÔ∏è</button>
                </div>
            ` : ''}
        </div>
    `;
}

// Handle screenshot file selection
function handleScreenshotSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
        showToast('Screenshot too large (max 5MB)', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        currentScreenshotData = e.target.result;
        showScreenshotPreview(currentScreenshotData);
    };
    reader.readAsDataURL(file);
}

// Handle paste from clipboard
document.addEventListener('paste', (event) => {
    // Only handle paste if issues tab is active
    if (currentTab !== 'issues') return;
    
    const items = event.clipboardData?.items;
    if (!items) return;
    
    for (const item of items) {
        if (item.type.startsWith('image/')) {
            const file = item.getAsFile();
            const reader = new FileReader();
            reader.onload = (e) => {
                currentScreenshotData = e.target.result;
                showScreenshotPreview(currentScreenshotData);
            };
            reader.readAsDataURL(file);
            break;
        }
    }
});

// Show screenshot preview
function showScreenshotPreview(dataUrl) {
    const preview = document.getElementById('screenshot-preview');
    preview.innerHTML = `
        <img src="${dataUrl}" alt="Screenshot preview">
        <button class="screenshot-remove" onclick="removeScreenshot(event)">√ó</button>
    `;
    preview.classList.add('has-image');
}

// Remove screenshot
function removeScreenshot(event) {
    event.stopPropagation();
    currentScreenshotData = null;
    const preview = document.getElementById('screenshot-preview');
    preview.innerHTML = `
        <div class="screenshot-placeholder">
            <span style="font-size: 2rem;">üì∑</span>
            <span>Click to add screenshot</span>
            <span style="font-size: 0.7rem; color: var(--gray-400);">or paste from clipboard</span>
        </div>
    `;
    preview.classList.remove('has-image');
    document.getElementById('issue-screenshot').value = '';
}

// Submit issue
async function submitIssue(event) {
    event.preventDefault();
    
    const btn = document.getElementById('submit-issue-btn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Submitting...';
    
    try {
        const issue = {
            section: document.getElementById('issue-section').value,
            severity: document.getElementById('issue-severity').value,
            platform: document.getElementById('issue-platform').value,
            browser: document.getElementById('issue-browser').value || null,
            title: document.getElementById('issue-title').value.trim(),
            description: document.getElementById('issue-description').value.trim(),
            steps: document.getElementById('issue-steps').value.trim() || null,
            screenshotUrl: currentScreenshotData || null,
            reporterId: currentUser?.uid || 'anonymous',
            reporterName: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Anonymous',
            reporterEmail: currentUser?.email || null,
            status: 'open',
            timestamp: Date.now()
        };
        
        // Save to Firebase
        await db.ref('reported-issues').push(issue);
        
        showToast('‚úÖ Issue submitted successfully!', 'success');
        clearIssueForm();
        loadIssues();
        
    } catch (e) {
        console.error('Error submitting issue:', e);
        showToast('‚ùå Error submitting issue', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'üêõ Submit Issue';
    }
}

// Clear issue form
function clearIssueForm() {
    document.getElementById('issue-form').reset();
    removeScreenshot({ stopPropagation: () => {} });
    currentScreenshotData = null;
}

// Update issue status (admin only)
async function updateIssueStatus(issueId, newStatus) {
    if (!isAdmin) return;
    
    try {
        await db.ref(`reported-issues/${issueId}`).update({
            status: newStatus,
            updatedAt: Date.now()
        });
        showToast(`Status updated to ${newStatus}`);
        loadIssues();
    } catch (e) {
        console.error('Error updating issue:', e);
        showToast('Error updating issue', 'error');
    }
}

// Update issue priority (admin only - internal field)
async function updateIssuePriority(issueId, newPriority) {
    if (!isAdmin) return;
    if (!newPriority) return; // Don't update if "Set Priority" selected
    
    try {
        await db.ref(`reported-issues/${issueId}`).update({
            priority: newPriority,
            updatedAt: Date.now()
        });
        showToast(`Priority set to ${newPriority.toUpperCase()}`);
        loadIssues();
    } catch (e) {
        console.error('Error updating priority:', e);
        showToast('Error updating priority', 'error');
    }
}

// Delete issue (admin only)
async function deleteIssue(issueId) {
    if (!isAdmin) return;
    if (!confirm('Delete this issue permanently?')) return;
    
    try {
        await db.ref(`reported-issues/${issueId}`).remove();
        showToast('Issue deleted');
        loadIssues();
    } catch (e) {
        console.error('Error deleting issue:', e);
        showToast('Error deleting issue', 'error');
    }
}

// Show image in modal
function showImageModal(imageUrl) {
    let modal = document.getElementById('image-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.className = 'image-modal';
        modal.innerHTML = `
            <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
            <img src="" alt="Full size image">
        `;
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeImageModal();
        });
        document.body.appendChild(modal);
    }
    
    modal.querySelector('img').src = imageUrl;
    modal.classList.add('visible');
}

function closeImageModal() {
    const modal = document.getElementById('image-modal');
    if (modal) modal.classList.remove('visible');
}

// Helper: time ago
function getTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    return new Date(timestamp).toLocaleDateString();
}

// Helper: escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Check URL params for direct link to issues
function checkIssueParams() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('tab') === 'issues' || params.get('report') === 'issue') {
        currentTab = 'issues';
        
        // Prefill form if coming from PWA
        if (params.get('prefill') === '1') {
            setTimeout(() => {
                if (params.get('section')) {
                    const sectionEl = document.getElementById('issue-section');
                    if (sectionEl) sectionEl.value = params.get('section');
                }
                if (params.get('severity')) {
                    const severityEl = document.getElementById('issue-severity');
                    if (severityEl) severityEl.value = params.get('severity');
                }
                if (params.get('title')) {
                    const titleEl = document.getElementById('issue-title');
                    if (titleEl) titleEl.value = decodeURIComponent(params.get('title'));
                }
            }, 100);
        }
    }
}

// ========== REPORTS ==========
function renderReports() {
    const tests = getAssignedTests();
    const results = testResults;
    
    // Calculate summary stats
    let pass = 0, fail = 0, skip = 0, pending = 0;
    tests.forEach(t => {
        const status = results[t.id]?.status;
        if (status === 'pass') pass++;
        else if (status === 'fail') fail++;
        else if (status === 'skip') skip++;
        else pending++;
    });
    
    // Update summary cards
    document.getElementById('rpt-total').textContent = tests.length;
    document.getElementById('rpt-pass').textContent = pass;
    document.getElementById('rpt-fail').textContent = fail;
    document.getElementById('rpt-skip').textContent = skip;
    document.getElementById('rpt-pending').textContent = pending;
    
    // Platform coverage
    renderPlatformCoverage(tests, results);
    
    // Section progress
    renderSectionProgress(tests, results);
    
    // Attention list
    renderAttentionList(tests, results);
    
    // Coverage matrix
    renderCoverageMatrix(tests, results);
}

function renderPlatformCoverage(tests, results) {
    const platforms = [
        { id: 'desktop-chrome', icon: 'üñ•Ô∏è', name: 'Chrome' },
        { id: 'desktop-safari', icon: 'üñ•Ô∏è', name: 'Safari' },
        { id: 'desktop-firefox', icon: 'üñ•Ô∏è', name: 'Firefox' },
        { id: 'iphone-safari', icon: 'üì±', name: 'iPhone Safari' },
        { id: 'iphone-pwa', icon: 'üì±', name: 'iPhone PWA' },
        { id: 'android-chrome', icon: 'ü§ñ', name: 'Android Chrome' },
        { id: 'android-pwa', icon: 'ü§ñ', name: 'Android PWA' },
        { id: 'ipad', icon: 'üì≤', name: 'iPad' }
    ];
    
    const platformStats = {};
    platforms.forEach(p => platformStats[p.id] = { pass: 0, fail: 0, total: 0 });
    
    tests.forEach(t => {
        const r = results[t.id];
        if (r?.platform && platformStats[r.platform]) {
            platformStats[r.platform].total++;
            if (r.status === 'pass') platformStats[r.platform].pass++;
            if (r.status === 'fail') platformStats[r.platform].fail++;
        }
    });
    
    const maxTests = Math.max(...Object.values(platformStats).map(s => s.total), 1);
    
    document.getElementById('platform-coverage').innerHTML = platforms.map(p => {
        const stats = platformStats[p.id];
        const pct = stats.total ? Math.round((stats.total / tests.length) * 100) : 0;
        const passPct = stats.total ? Math.round((stats.pass / stats.total) * 100) : 0;
        const barWidth = (stats.total / maxTests) * 100;
        
        let fillClass = 'pass';
        if (stats.fail > 0 && stats.pass > 0) fillClass = 'mixed';
        else if (stats.fail > 0) fillClass = 'fail';
        
        return `
            <div class="platform-row">
                <div class="platform-icon">${p.icon}</div>
                <div class="platform-name">${p.name}</div>
                <div class="platform-bar">
                    <div class="platform-fill ${fillClass}" style="width: ${barWidth}%; --pass-pct: ${passPct}%;">
                        ${stats.total > 0 ? stats.total : ''}
                    </div>
                </div>
                <div class="platform-stats">
                    ${stats.total > 0 ? `${stats.pass}‚úì ${stats.fail > 0 ? stats.fail + '‚úó' : ''}` : '<span style="color: var(--gray-400)">No tests</span>'}
                </div>
            </div>
        `;
    }).join('') + `
        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 0.8rem;">
            <strong>üìå Not yet tested on any platform:</strong> ${tests.filter(t => !results[t.id]?.platform).length} tests
        </div>
    `;
}

function renderSectionProgress(tests, results) {
    document.getElementById('section-progress').innerHTML = TEST_SECTIONS.map(section => {
        const sectionTests = section.tests.filter(t => tests.some(at => at.id === t.id));
        if (!sectionTests.length) return '';
        
        let pass = 0, fail = 0, skip = 0;
        sectionTests.forEach(t => {
            const status = results[t.id]?.status;
            if (status === 'pass') pass++;
            else if (status === 'fail') fail++;
            else if (status === 'skip') skip++;
        });
        
        const total = sectionTests.length;
        const passPct = (pass / total) * 100;
        const failPct = (fail / total) * 100;
        const skipPct = (skip / total) * 100;
        
        return `
            <div class="section-row">
                <div class="section-icon">${section.icon}</div>
                <div class="section-name">${section.name}</div>
                <div class="section-bar">
                    <div class="bar-segment pass" style="width: ${passPct}%"></div>
                    <div class="bar-segment fail" style="width: ${failPct}%"></div>
                    <div class="bar-segment skip" style="width: ${skipPct}%"></div>
                </div>
                <div class="section-stats">${pass + fail + skip}/${total}</div>
            </div>
        `;
    }).join('');
}

function renderAttentionList(tests, results) {
    const failedTests = tests.filter(t => results[t.id]?.status === 'fail');
    const noPlatformTests = tests.filter(t => results[t.id]?.status && !results[t.id]?.platform);
    
    let html = '';
    
    if (failedTests.length === 0 && noPlatformTests.length === 0) {
        html = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">‚úÖ All tests looking good!</p>';
    } else {
        if (failedTests.length > 0) {
            html += '<h4 style="font-size: 0.8rem; color: var(--danger); margin-bottom: 8px;">Failed Tests</h4>';
            html += failedTests.map(t => `
                <div class="attention-item">
                    <span class="attention-id">${t.id}</span>
                    <span class="attention-title">${t.title}</span>
                    <span class="attention-badge fail">FAIL</span>
                </div>
            `).join('');
        }
        
        if (noPlatformTests.length > 0) {
            html += '<h4 style="font-size: 0.8rem; color: var(--warning); margin: 16px 0 8px;">Missing Platform</h4>';
            html += noPlatformTests.slice(0, 10).map(t => `
                <div class="attention-item warning">
                    <span class="attention-id">${t.id}</span>
                    <span class="attention-title">${t.title}</span>
                    <span class="attention-badge no-platform">No Platform</span>
                </div>
            `).join('');
            if (noPlatformTests.length > 10) {
                html += `<p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 8px;">...and ${noPlatformTests.length - 10} more</p>`;
            }
        }
    }
    
    document.getElementById('attention-list').innerHTML = html;
}

function renderCoverageMatrix(tests, results) {
    const platforms = [
        { id: 'desktop-chrome', short: 'üñ•Ô∏è Chr' },
        { id: 'desktop-safari', short: 'üñ•Ô∏è Saf' },
        { id: 'desktop-firefox', short: 'üñ•Ô∏è FF' },
        { id: 'iphone-safari', short: 'üì± iOS' },
        { id: 'iphone-pwa', short: 'üì± PWA' },
        { id: 'android-chrome', short: 'ü§ñ And' },
        { id: 'android-pwa', short: 'ü§ñ PWA' },
        { id: 'ipad', short: 'üì≤ iPad' }
    ];
    
    let html = '<table class="matrix-table"><thead><tr><th>Section</th>';
    platforms.forEach(p => html += `<th>${p.short}</th>`);
    html += '</tr></thead><tbody>';
    
    TEST_SECTIONS.forEach(section => {
        const sectionTests = section.tests.filter(t => tests.some(at => at.id === t.id));
        if (!sectionTests.length) return;
        
        html += `<tr><td class="section-header-cell">${section.icon} ${section.name}</td>`;
        
        platforms.forEach(platform => {
            const platformTests = sectionTests.filter(t => results[t.id]?.platform === platform.id);
            const passCount = platformTests.filter(t => results[t.id]?.status === 'pass').length;
            const failCount = platformTests.filter(t => results[t.id]?.status === 'fail').length;
            const total = platformTests.length;
            
            let cellClass = 'none';
            let cellContent = '-';
            
            if (total > 0) {
                if (failCount > 0) {
                    cellClass = 'has-fail';
                    cellContent = `${passCount}/${total}`;
                } else if (total === sectionTests.length) {
                    cellClass = 'full';
                    cellContent = '‚úì';
                } else {
                    cellClass = 'partial';
                    cellContent = total;
                }
            }
            
            html += `<td class="matrix-cell ${cellClass}">${cellContent}</td>`;
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    // Add legend
    html += `
        <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.7rem; color: var(--gray-500);">
            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 2px;"></span> All pass</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #fef3c7; border-radius: 2px;"></span> Partial</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #fee2e2; border-radius: 2px;"></span> Has failures</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--gray-50); border-radius: 2px;"></span> Not tested</span>
        </div>
    `;
    
    document.getElementById('coverage-matrix').innerHTML = html;
}

// ========== SCRIPT GENERATION ==========
function generatePlaywright() {
    const tests = getAssignedTests();
    const script = `import { test, expect } from '@playwright/test';

const GAMESHELF_URL = '${GAMESHELF_URL}';

${tests.map(t => `
test('${t.id}: ${t.title}', async ({ page }) => {
    await page.goto(GAMESHELF_URL + '${t.launch || ''}');
    // Expected: ${t.expected}
    // TODO: Add assertions
    await page.waitForTimeout(2000);
});
`).join('')}`;
    
    downloadFile(script, 'gameshelf.spec.ts', 'text/typescript');
    toast('Playwright script downloaded');
}

function generateCypress() {
    const tests = getAssignedTests();
    const script = `describe('Game Shelf Tests', () => {
    const GAMESHELF_URL = '${GAMESHELF_URL}';
    
${tests.map(t => `
    it('${t.id}: ${t.title}', () => {
        cy.visit(GAMESHELF_URL + '${t.launch || ''}');
        // Expected: ${t.expected}
        // TODO: Add assertions
        cy.wait(2000);
    });
`).join('')}
});`;
    
    downloadFile(script, 'gameshelf.cy.js', 'text/javascript');
    toast('Cypress script downloaded');
}

function generatePuppeteer() {
    const tests = getAssignedTests();
    const script = `const puppeteer = require('puppeteer');

const GAMESHELF_URL = '${GAMESHELF_URL}';

(async () => {
    const browser = await puppeteer.launch({ headless: false });
    const page = await browser.newPage();
    
${tests.map(t => `
    // ${t.id}: ${t.title}
    // Expected: ${t.expected}
    console.log('Running ${t.id}...');
    await page.goto(GAMESHELF_URL + '${t.launch || ''}');
    await page.waitForTimeout(2000);
    // TODO: Add assertions
`).join('')}
    
    await browser.close();
})();`;
    
    downloadFile(script, 'gameshelf.puppeteer.js', 'text/javascript');
    toast('Puppeteer script downloaded');
}

// ========== EXPORT ==========
function exportJSON() {
    const data = {
        exportedAt: new Date().toISOString(),
        tester: { uid: currentUser.uid, name: currentUser.displayName, email: currentUser.email },
        assignment: userAssignment,
        device: navigator.userAgent,
        screen: `${innerWidth}x${innerHeight}`,
        summary: {
            total: getAssignedTests().length,
            pass: Object.values(testResults).filter(r => r.status === 'pass').length,
            fail: Object.values(testResults).filter(r => r.status === 'fail').length,
            skip: Object.values(testResults).filter(r => r.status === 'skip').length
        },
        platformCoverage: [...new Set(Object.values(testResults).map(r => r.platform).filter(Boolean))],
        failedTests: getAssignedTests().filter(t => testResults[t.id]?.status === 'fail').map(t => ({
            id: t.id, title: t.title, expected: t.expected,
            platform: testResults[t.id]?.platform,
            notes: testResults[t.id]?.notes,
            screenshots: testResults[t.id]?.screenshots?.length || 0
        })),
        results: testResults,
        consoleLogs: consoleLogs.slice(-200)
    };
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    toast('JSON copied! Paste to Claude');
}

function exportCSV() {
    const rows = [['ID', 'Title', 'Status', 'Platform', 'Notes', 'Screenshots']];
    getAssignedTests().forEach(t => {
        const r = testResults[t.id] || {};
        rows.push([t.id, `"${t.title}"`, r.status || 'pending', r.platform || '', `"${(r.notes || '').replace(/"/g, '""')}"`, (r.screenshots || []).length]);
    });
    downloadFile(rows.map(r => r.join(',')).join('\n'), 'test-results.csv', 'text/csv');
}

function exportMarkdown() {
    const tests = getAssignedTests();
    const pass = tests.filter(t => testResults[t.id]?.status === 'pass').length;
    const fail = tests.filter(t => testResults[t.id]?.status === 'fail').length;
    const platforms = [...new Set(Object.values(testResults).map(r => r.platform).filter(Boolean))];
    
    let md = `# Game Shelf Test Results\n\n`;
    md += `**Tester:** ${currentUser.displayName}\n`;
    md += `**Date:** ${new Date().toLocaleString()}\n`;
    md += `**Summary:** ${pass} pass, ${fail} fail of ${tests.length}\n`;
    md += `**Platforms Tested:** ${platforms.map(p => getPlatformIcon(p)).join(', ') || 'Not specified'}\n\n`;
    
    const failed = tests.filter(t => testResults[t.id]?.status === 'fail');
    if (failed.length) {
        md += `## Failed Tests\n\n`;
        failed.forEach(t => {
            const r = testResults[t.id];
            md += `### ${t.id}: ${t.title}\n`;
            md += `**Platform:** ${r.platform ? getPlatformIcon(r.platform) : 'Not specified'}\n`;
            md += `**Expected:** ${t.expected}\n`;
            md += `**Notes:** ${r.notes || 'None'}\n\n`;
        });
    }
    
    downloadFile(md, 'test-results.md', 'text/markdown');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

// ========== UTILS ==========
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 2000);
}

function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function getPlatformIcon(platform) {
    const icons = {
        'desktop-chrome': 'üñ•Ô∏è Chrome',
        'desktop-safari': 'üñ•Ô∏è Safari',
        'desktop-firefox': 'üñ•Ô∏è Firefox',
        'iphone-safari': 'üì± iOS',
        'iphone-pwa': 'üì± iOS PWA',
        'android-chrome': 'ü§ñ Android',
        'android-pwa': 'ü§ñ Android PWA',
        'ipad': 'üì≤ iPad'
    };
    return icons[platform] || platform;
}

function detectPlatform() {
    const ua = navigator.userAgent;
    const standalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    
    if (/iPad/.test(ua)) return 'ipad';
    if (/iPhone|iPod/.test(ua)) return standalone ? 'iphone-pwa' : 'iphone-safari';
    if (/Android/.test(ua)) return standalone ? 'android-pwa' : 'android-chrome';
    if (/Firefox/.test(ua)) return 'desktop-firefox';
    if (/Safari/.test(ua) && !/Chrome/.test(ua)) return 'desktop-safari';
    return 'desktop-chrome';
}

function autoDetectPlatform(id) {
    const platform = detectPlatform();
    setPlatform(id, platform);
    toast(`Detected: ${getPlatformIcon(platform)}`);
}

function changeGlobalPlatform(platform) {
    detectedPlatform = platform;
    updatePlatformUI();
    toast(`Platform set to ${getPlatformIcon(platform)}`);
}

function updatePlatformUI() {
    document.getElementById('current-platform').textContent = getPlatformIcon(detectedPlatform);
    const select = document.getElementById('platform-select');
    if (select) select.value = detectedPlatform;
}

// Init
detectedPlatform = detectPlatform();
console.log('üß™ Test Plan v4 loaded');
console.log('üì± Detected platform:', detectedPlatform, getPlatformIcon(detectedPlatform));
setInterval(updateMetrics, 1000);
</script>
</body>
</html>

<!-- Playwright Runner Integration (embedded) -->
<script>
/**
 * Playwright Runner - Adds real test execution to Auto tab
 */
(function() {
  'use strict';
  
  const PLAYWRIGHT_SERVER = window.location.origin;
  
  const state = {
    connected: false,
    running: false,
    currentRun: null,
    eventSource: null,
    results: {}
  };
  
  function injectUI() {
    const autoTab = document.getElementById('tab-automation');
    if (!autoTab) { setTimeout(injectUI, 1000); return; }
    if (document.getElementById('playwright-section')) return;
    
    const scriptsPanel = autoTab.querySelector('.panel:last-child');
    
    const section = document.createElement('div');
    section.id = 'playwright-section';
    section.className = 'panel';
    section.style.borderLeft = '4px solid var(--primary)';
    section.innerHTML = `
      <h3>üé≠ Playwright Runner</h3>
      <p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 12px;">
        Run real automated tests. Results sync to Firebase.
      </p>
      
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--gray-50); border-radius: 6px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span id="pw-status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: var(--gray-300);"></span>
          <span id="pw-status-text" style="font-size: 0.85rem;">Connecting...</span>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="PlaywrightRunner.reconnect()">üîÑ Reconnect</button>
      </div>
      
      <div class="form-row" style="margin-bottom: 12px;">
        <div class="form-group">
          <label>Browser</label>
          <select id="pw-browser">
            <option value="all">üåê All Platforms</option>
            <option value="chromium">üñ•Ô∏è Chrome (Desktop)</option>
            <option value="firefox">ü¶ä Firefox (Desktop)</option>
            <option value="webkit">üß≠ Safari (Desktop)</option>
            <option value="Mobile Chrome">üì± Android (Pixel 5)</option>
            <option value="Mobile Safari">üì± iPhone 12</option>
            <option value="iPhone SE">üì± iPhone SE</option>
            <option value="iPad">üì± iPad Pro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Options</label>
          <div style="display: flex; gap: 12px; padding-top: 6px;">
            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
              <input type="checkbox" id="pw-headed"> Headed
            </label>
            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; cursor: pointer;">
              <input type="checkbox" id="pw-parallel"> Parallel
            </label>
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
        <button id="pw-run-all" class="btn btn-primary" onclick="PlaywrightRunner.runAll()" disabled>üé≠ Run All</button>
        <button id="pw-run-selected" class="btn btn-secondary" onclick="PlaywrightRunner.runSelected()" disabled>üé≠ Selected</button>
        <button id="pw-run-smoke" class="btn btn-secondary" onclick="PlaywrightRunner.runSmoke()" disabled>üöÄ Smoke</button>
        <button id="pw-stop" class="btn btn-danger" onclick="PlaywrightRunner.stop()" disabled>‚èπÔ∏è Stop</button>
      </div>
      
      <div id="pw-progress" style="display: none; padding: 10px; background: var(--gray-50); border-radius: 6px; margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span id="pw-progress-text" style="font-size: 0.85rem; font-weight: 500;">Running...</span>
          <span id="pw-progress-counts" style="font-size: 0.8rem;">‚úÖ 0 ‚ùå 0</span>
        </div>
        <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
          <div id="pw-progress-bar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s;"></div>
        </div>
      </div>
      
      <div style="margin-bottom: 12px;">
        <label style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); display: block; margin-bottom: 6px;">BY SECTION</label>
        <div id="pw-section-buttons" style="display: flex; gap: 4px; flex-wrap: wrap;"></div>
      </div>
      
      <div id="pw-results-summary" style="display: none;">
        <label style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); display: block; margin-bottom: 6px;">RESULTS</label>
        <div id="pw-results-grid" style="display: flex; gap: 4px; flex-wrap: wrap; max-height: 100px; overflow-y: auto; padding: 8px; background: var(--gray-50); border-radius: 6px;"></div>
      </div>
    `;
    
    if (scriptsPanel) autoTab.insertBefore(section, scriptsPanel);
    else autoTab.appendChild(section);
    
    populateSectionButtons();
  }
  
  function populateSectionButtons() {
    const container = document.getElementById('pw-section-buttons');
    if (!container || typeof TEST_SECTIONS === 'undefined') return;
    container.innerHTML = TEST_SECTIONS.map(s => 
      `<button class="btn btn-sm btn-secondary pw-section-btn" onclick="PlaywrightRunner.runSection('${s.id}')" disabled title="${s.name}">${s.icon}</button>`
    ).join('');
  }
  
  function connect() {
    if (state.eventSource) state.eventSource.close();
    updateStatus('connecting');
    
    try {
      state.eventSource = new EventSource(`${PLAYWRIGHT_SERVER}/api/events`);
      
      state.eventSource.onopen = () => {
        state.connected = true;
        updateStatus('connected');
        enableButtons(true);
        addLog('Connected to server', 'success');
      };
      
      state.eventSource.onmessage = (e) => handleEvent(JSON.parse(e.data));
      
      state.eventSource.onerror = () => {
        state.connected = false;
        state.running = false;  // Reset running state
        state.currentRun = null;
        updateStatus('disconnected');
        enableButtons(false);
        showProgress(false);  // Hide progress bar
        addLog('Server disconnected', 'warn');
        setTimeout(connect, 5000);
      };
    } catch (e) {
      updateStatus('disconnected');
    }
  }
  
  function handleEvent(event) {
    switch (event.type) {
      case 'run-started':
        state.running = true;
        state.currentRun = event.data;
        showProgress(true);
        addLog(`üé≠ Started: ${event.data.project}`, 'info');
        enableButtons(false);
        document.getElementById('pw-stop').disabled = false;
        break;
      
      case 'test-running':
        // Show which test is currently running
        if (event.data) {
          const { testId, title, current, total } = event.data;
          addLog(`üîÑ [${current}/${total}] ${testId}: ${title}`, 'info');
          
          // Update progress bar
          const bar = document.getElementById('pw-progress-bar');
          const text = document.getElementById('pw-progress-text');
          if (bar && total) bar.style.width = `${(current / total) * 100}%`;
          if (text) text.textContent = `Running ${current}/${total}...`;
        }
        break;
        
      case 'test-complete':
        handleResult(event.data);
        break;
        
      case 'progress-update':
        // Update from summary line when individual results weren't captured
        if (event.data) {
          state.currentRun = event.data;
          addLog(`üìä Progress: ${event.data.passed} passed, ${event.data.failed} failed`, 'info');
        }
        break;
        
      case 'run-complete':
        state.running = false;
        state.currentRun = event.data;
        showProgress(false);
        addLog(`‚úÖ Done: ${event.data.passed} passed, ${event.data.failed} failed`, 'success');
        saveRunToFirebase(event.data);
        updateResultsGrid();
        enableButtons(true);
        break;
        
      case 'run-stopped':
        state.running = false;
        showProgress(false);
        addLog('‚èπÔ∏è Stopped', 'warn');
        enableButtons(true);
        break;
    }
    updateProgress();
  }
  
  function handleResult(result) {
    // Check if we already processed this result (avoid double-counting)
    const existing = state.results[result.testId];
    const isNew = !existing;
    
    state.results[result.testId] = result;
    const icon = result.status === 'pass' ? '‚úÖ' : result.status === 'fail' ? '‚ùå' : '‚è≠Ô∏è';
    addLog(`${icon} ${result.testId}: ${result.title} (${Math.round(result.duration)}ms)`, 
           result.status === 'pass' ? 'success' : result.status === 'fail' ? 'error' : 'info');
    saveResultToFirebase(result);
    updateBadge(result.testId, result.status);
    
    // Update currentRun counters for live progress display
    if (isNew && state.currentRun) {
      if (result.status === 'pass') {
        state.currentRun.passed = (state.currentRun.passed || 0) + 1;
      } else if (result.status === 'fail') {
        state.currentRun.failed = (state.currentRun.failed || 0) + 1;
      } else {
        state.currentRun.skipped = (state.currentRun.skipped || 0) + 1;
      }
    }
    
    updateProgress();
  }
  
  function updateStatus(s) {
    const dot = document.getElementById('pw-status-dot');
    const text = document.getElementById('pw-status-text');
    if (!dot || !text) return;
    
    if (s === 'connected') {
      dot.style.background = 'var(--success)';
      text.textContent = 'Connected to Playwright server';
    } else if (s === 'connecting') {
      dot.style.background = 'var(--warning)';
      text.textContent = 'Connecting...';
    } else {
      dot.style.background = 'var(--danger)';
      text.innerHTML = 'Server stopped. <a href="#" onclick="alert(\'Run in terminal:\\n\\nnpm start\\n\\nThen click Reconnect\');return false;" style="color: var(--primary);">Restart?</a>';
    }
  }
  
  function enableButtons(enabled) {
    const canRun = enabled && state.connected && !state.running;
    ['pw-run-all', 'pw-run-selected', 'pw-run-smoke'].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.disabled = !canRun;
    });
    document.querySelectorAll('.pw-section-btn').forEach(btn => btn.disabled = !canRun);
    
    // Stop button: only enabled when connected AND running
    const stopBtn = document.getElementById('pw-stop');
    if (stopBtn) stopBtn.disabled = !(state.connected && state.running);
  }
  
  function showProgress(show) {
    const el = document.getElementById('pw-progress');
    if (el) el.style.display = show ? 'block' : 'none';
  }
  
  function updateProgress() {
    if (!state.currentRun) return;
    const run = state.currentRun;
    const total = run.passed + run.failed + run.skipped;
    
    const text = document.getElementById('pw-progress-text');
    const counts = document.getElementById('pw-progress-counts');
    const bar = document.getElementById('pw-progress-bar');
    
    if (text) text.textContent = `Running... ${total}`;
    if (counts) counts.textContent = `‚úÖ ${run.passed} ‚ùå ${run.failed}`;
    if (bar) bar.style.width = `${Math.min(total * 3, 100)}%`;
  }
  
  function updateResultsGrid() {
    const container = document.getElementById('pw-results-grid');
    const summary = document.getElementById('pw-results-summary');
    if (!container || !summary) return;
    
    const results = Object.entries(state.results);
    if (results.length === 0) { summary.style.display = 'none'; return; }
    
    summary.style.display = 'block';
    container.innerHTML = results.map(([id, r]) => {
      const bg = r.status === 'pass' ? '#dcfce7' : r.status === 'fail' ? '#fee2e2' : '#f3f4f6';
      const color = r.status === 'pass' ? '#166534' : r.status === 'fail' ? '#991b1b' : '#374151';
      return `<div style="padding: 4px 8px; background: ${bg}; color: ${color}; border-radius: 4px; font-size: 0.7rem; font-weight: 500; cursor: pointer;" onclick="scrollToTestCard('${id}')">${id}</div>`;
    }).join('');
  }
  
  function updateBadge(testId, status) {
    const card = document.querySelector(`[data-test-id="${testId}"]`);
    if (!card) return;
    
    let badge = card.querySelector('.pw-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'pw-badge';
      badge.style.cssText = 'position: absolute; top: 4px; right: 4px; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; z-index: 5;';
      card.style.position = 'relative';
      card.appendChild(badge);
    }
    
    badge.textContent = status === 'pass' ? 'üé≠‚úÖ' : status === 'fail' ? 'üé≠‚ùå' : 'üé≠‚è≠Ô∏è';
    badge.style.background = status === 'pass' ? '#dcfce7' : status === 'fail' ? '#fee2e2' : '#f3f4f6';
  }
  
  function addLog(msg, type = 'info') {
    const log = document.getElementById('automation-log');
    if (!log) return;
    const line = document.createElement('div');
    line.className = type;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
  }
  
  async function runTests(testIds = []) {
    if (!state.connected) { toast('Not connected'); return; }
    if (state.running) { toast('Already running'); return; }
    
    try {
      const response = await fetch(`${PLAYWRIGHT_SERVER}/api/run-tests`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tests: testIds,
          project: document.getElementById('pw-browser')?.value || 'chromium',
          headed: document.getElementById('pw-headed')?.checked || false,
          workers: document.getElementById('pw-parallel')?.checked ? 2 : 1
        })
      });
      
      if (!response.ok) toast('Error starting tests');
    } catch (e) {
      toast('Server not running');
    }
  }
  
  async function stopTests() {
    try { await fetch(`${PLAYWRIGHT_SERVER}/api/stop-tests`, { method: 'POST' }); } catch {}
  }
  
  function saveResultToFirebase(result) {
    if (typeof firebase === 'undefined' || !firebase.database) return;
    firebase.database().ref(`automated-results/${result.testId}`).set({
      testId: result.testId,
      status: result.status,
      duration: result.duration,
      timestamp: new Date().toISOString(),
      automated: true,
      project: state.currentRun?.project || 'unknown'
    }).catch(() => {});
  }
  
  function saveRunToFirebase(run) {
    if (typeof firebase === 'undefined' || !firebase.database) return;
    firebase.database().ref(`automated-runs/${run.id}`).set({
      id: run.id,
      startTime: run.startTime,
      endTime: run.endTime,
      duration: run.duration,
      status: run.status,
      passed: run.passed,
      failed: run.failed,
      skipped: run.skipped,
      project: run.project
    }).catch(() => {});
  }
  
  function loadFromFirebase() {
    if (typeof firebase === 'undefined' || !firebase.database) return;
    firebase.database().ref('automated-results').once('value')
      .then(snap => {
        const results = snap.val() || {};
        state.results = results;
        Object.entries(results).forEach(([id, r]) => updateBadge(id, r.status));
        updateResultsGrid();
      }).catch(() => {});
  }
  
  function getSelected() {
    return Array.from(document.querySelectorAll('.auto-test:checked')).map(cb => cb.value);
  }
  
  function getSectionTests(sectionId) {
    if (typeof TEST_SECTIONS === 'undefined') return [];
    const section = TEST_SECTIONS.find(s => s.id === sectionId);
    return section ? section.tests.map(t => t.id) : [];
  }
  
  window.PlaywrightRunner = {
    runAll: () => runTests([]),
    runSelected: () => {
      const selected = getSelected();
      if (selected.length === 0) { toast('Select tests first'); return; }
      runTests(selected);
    },
    runSmoke: () => runTests(['A1', 'A5', 'B1', 'B2', 'H1']),
    runSection: (id) => runTests(getSectionTests(id)),
    stop: stopTests,
    reconnect: () => { addLog('Reconnecting...', 'info'); connect(); }
  };
  
  window.scrollToTestCard = function(testId) {
    const card = document.querySelector(`[data-test-id="${testId}"]`);
    if (card) {
      if (typeof switchTab === 'function') switchTab('testing');
      setTimeout(() => {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.style.outline = '3px solid var(--primary)';
        setTimeout(() => card.style.outline = '', 2000);
      }, 100);
    }
  };
  
  function init() {
    injectUI();
    connect();
    setTimeout(loadFromFirebase, 1000);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(init, 500));
  } else {
    setTimeout(init, 500);
  }
  
  const style = document.createElement('style');
  style.textContent = '#playwright-section .btn:disabled { opacity: 0.5; cursor: not-allowed; }';
  document.head.appendChild(style);
})();
</script>
